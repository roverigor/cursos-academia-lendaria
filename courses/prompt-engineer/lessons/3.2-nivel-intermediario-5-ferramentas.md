# Lesson 3.2: N√≠vel Intermedi√°rio - 5 Ferramentas

**M√≥dulo:** 3 - OS 3 N√çVEIS DE COMPLEXIDADE
**Dura√ß√£o:** 20 minutos (+ 40-50 min de pr√°tica)
**Tipo:** Hands-on (evolu√ß√£o arquitetural)
**N√≠vel:** Fundamento 1 - Intermedi√°rio

---

## üéØ O QUE VOC√ä VAI DOMINAR

Sabe o que √© louco?

Na Lesson 3.1 voc√™ construiu agente funcional com 3 ferramentas.

**Funciona perfeitamente.**

A√≠ voc√™ mostra pro cliente. Cliente fica IMPRESSIONADO.

**Cliente, 2 dias depois:**

> "Adorei! Mas preciso de mais 2 coisas:
> 1. Criar tarefa de follow-up autom√°tico (se cliente n√£o responder em 48h)
> 2. Registrar todos agendamentos numa planilha (pra eu ter controle)"

**E voc√™ pensa:**

> "Meu Deus. Vai quebrar tudo. Vou ter que refazer do zero."

E a√≠ que t√°...

**Voc√™ N√ÉO precisa refazer.**

Voc√™ vai aprender a t√©cnica de **EVOLU√á√ÉO ESTRUTURADA**:
- Adicionar 2 ferramentas (Tasks + Sheets)
- MANTER arquitetura existente intacta
- Identificar EXATAMENTE quais Poliedros mudam
- Criar "diff" do prompt (v1 ‚Üí v2)

**No final:** Agente com 5 ferramentas funcionando. Sem quebrar o que j√° tava pronto.

---

## üî• PROBLEMA REAL QUE VOC√ä VAI RESOLVER

**Cliente:** Mesma consultoria da Lesson 3.1

**Situa√ß√£o atual (com agente N√≠vel 1):**
- ‚úÖ Agente oferece hor√°rios automaticamente
- ‚úÖ Cliente responde escolhendo hor√°rio
- ‚úÖ Evento criado no Calendar

**MAS:**
- ‚ùå Se cliente N√ÉO responder em 48h ‚Üí nada acontece (lead esfria)
- ‚ùå N√£o tem registro dos agendamentos (s√≥cio n√£o sabe quantos agendou no m√™s)
- ‚ùå Sem m√©trica de convers√£o (quantos leads viraram reuni√£o?)

---

**Cliente quer:**

> "**Funcionalidade 1:** Se cliente n√£o responder em 2 dias, criar tarefa de follow-up pro meu time humano ligar.
>
> **Funcionalidade 2:** Registrar TODA solicita√ß√£o numa planilha Google:
> - Nome do lead
> - Data da solicita√ß√£o
> - Hor√°rios oferecidos
> - Status (aguardando resposta / confirmado / sem resposta)
>
> Assim eu consigo:
> - Ver quantas solicita√ß√µes tive no m√™s
> - Identificar taxa de convers√£o
> - Fazer follow-up manual dos que n√£o responderam"

**Voc√™ vai entregar:** Agente N√≠vel 2 (5 ferramentas).

---

## üí° FUNDAMENTO: ANATOMIA DE UMA EVOLU√á√ÉO

Vem comigo numa met√°fora...

---

**Adicionar ferramentas = Reformar casa**

**Op√ß√£o A: DEMOLIR E RECONSTRUIR**
- Voc√™ derruba tudo
- Reconstr√≥i do zero com 5 c√¥modos
- Tempo: 3 meses
- Risco: Alto (pode sair diferente do planejado)
- Cliente: Sem casa enquanto reconstr√≥i

**Op√ß√£o B: CONSTRUIR ANEXO**
- Casa original INTACTA (3 c√¥modos funcionando)
- Adiciona 2 c√¥modos NOVOS conectados
- Tempo: 3 semanas
- Risco: Baixo (original continua funcionando)
- Cliente: Mora na casa durante obra

---

**Evolu√ß√£o estruturada = Op√ß√£o B**

Voc√™ vai:
1. **MANTER** Poliedros que n√£o mudam (1, 5, 6)
2. **EXPANDIR** Poliedros que crescem (2, 3)
3. **ADICIONAR** novos casos de erro (4)

**Simples assim.**

---

## üî¨ AN√ÅLISE: O QUE MUDA vs O QUE FICA

### ‚úÖ O QUE FICA INTACTO (N√ÉO MEXER)

**Poliedro 1 - Identidade**
- Nome do agente: Assistente de Agendamento
- Tom de voz: Profissional acess√≠vel
- Papel: Agendar reuni√µes
‚Üí **RAZ√ÉO:** Identidade n√£o muda, s√≥ capacidades

**Poliedro 5 - Output**
- Formato de email
- Template de resposta
- Limite de caracteres
‚Üí **RAZ√ÉO:** Cliente gosta do formato atual

**Poliedro 6 - Restri√ß√µes (parcial)**
- NUNCA agendar fora do hor√°rio comercial
- NUNCA oferecer mais de 3 hor√°rios
- NUNCA cancelar eventos existentes
‚Üí **RAZ√ÉO:** Regras de neg√≥cio s√£o as mesmas

---

### üîß O QUE MUDA (PRECISA ATUALIZAR)

**Poliedro 2 - Ferramentas**
- **ANTES:** 3 ferramentas (Gmail, Calendar Get, Calendar Create)
- **DEPOIS:** 5 ferramentas (+ Google Tasks, + Google Sheets)
‚Üí **MUDAN√áA:** Adicionar descri√ß√£o das 2 novas ferramentas

**Poliedro 3 - Workflow**
- **ANTES:** 4 etapas (Analisar ‚Üí Verificar ‚Üí Enviar ‚Üí Criar Evento)
- **DEPOIS:** 6 etapas (+ Registrar no Sheet, + Criar Task de Follow-up)
‚Üí **MUDAN√áA:** Inserir ETAPA 5 e ETAPA 6 no workflow

**Poliedro 4 - Erros**
- **ANTES:** Tratava erro de Calendar, Gmail
- **DEPOIS:** + Tratamento de erro de Sheets, Tasks
‚Üí **MUDAN√áA:** Adicionar novos casos SE/ENT√ÉO

---

## üõ†Ô∏è EVOLU√á√ÉO PASSO A PASSO

### PASSO 1: Adicionar Ferramentas 4 e 5 (Poliedro 2)

**No prompt v1, voc√™ tinha:**

```markdown
## POLIEDRO 2 - FERRAMENTAS

1. google_calendar_get_events(date_start, date_end)
2. gmail_send(to, subject, body)
3. google_calendar_create_event(title, start, end, attendee_email)
```

---

**No prompt v2, voc√™ adiciona:**

```markdown
## POLIEDRO 2 - FERRAMENTAS

**Ferramentas EXISTENTES (mantidas):**

1. google_calendar_get_events(date_start, date_end)
   [descri√ß√£o permanece igual]

2. gmail_send(to, subject, body)
   [descri√ß√£o permanece igual]

3. google_calendar_create_event(title, start, end, attendee_email)
   [descri√ß√£o permanece igual]

---

**Ferramentas NOVAS (adicionadas na v2):**

4. google_sheets_append_row(spreadsheet_id, range, values)
   - Adiciona nova linha na planilha
   - Input: ID da planilha, range (ex: "Sheet1!A:F"), array de valores
   - Output: Confirma√ß√£o de linha adicionada
   - Use para: Registrar toda solicita√ß√£o de agendamento

5. google_tasks_create_task(title, notes, due_date)
   - Cria tarefa no Google Tasks
   - Input: T√≠tulo, descri√ß√£o, data de vencimento
   - Output: ID da task criada
   - Use para: Follow-up se cliente n√£o responder em 48h
```

**Observa√ß√£o cr√≠tica:**

Voc√™ N√ÉO reescreveu ferramentas 1, 2, 3. Apenas ADICIONOU 4 e 5.

Isso garante que workflow existente continua funcionando.

---

### PASSO 2: Expandir Workflow (Poliedro 3)

**Workflow v1 (3 ferramentas):**

```
ETAPA 1: Analisar Solicita√ß√£o
ETAPA 2: Verificar Disponibilidade (Calendar Get)
ETAPA 3: Enviar Proposta (Gmail)
ETAPA 4: Criar Evento (Calendar Create) [ap√≥s confirma√ß√£o]
```

---

**Workflow v2 (5 ferramentas) - COM ADI√á√ïES:**

```markdown
ETAPA 1: Analisar Solicita√ß√£o
[MANT√âM EXATAMENTE IGUAL]

---

ETAPA 2: Verificar Disponibilidade
[MANT√âM EXATAMENTE IGUAL]

---

ETAPA 3: **[NOVO]** Registrar Solicita√ß√£o no Google Sheets

1. Preparar dados:
   - Lead: {nome_cliente}
   - Email: {email_cliente}
   - Assunto: {assunto}
   - Data solicita√ß√£o: {data_hora_atual}
   - Hor√°rios oferecidos: {lista_3_horarios}
   - Status: "Aguardando resposta"

2. Executar google_sheets_append_row(
   spreadsheet_id="[ID DA SUA PLANILHA]",
   range="Agendamentos!A:G",
   values=[{nome}, {email}, {assunto}, {data}, {horarios}, "Aguardando", ""]
)

3. Salvar {row_id} retornado (pra atualizar depois)

---

ETAPA 4: Enviar Proposta de Hor√°rios (Gmail)
[MANT√âM EXATAMENTE IGUAL da v1]

---

ETAPA 5: **[NOVO]** Criar Task de Follow-up (48h)

1. Calcular data_followup = {data_atual + 48 horas}

2. Executar google_tasks_create_task(
   title="Follow-up: {nome_cliente} - {assunto}",
   notes="Cliente n√£o respondeu proposta de hor√°rios. Ligar ou enviar WhatsApp.\nEmail: {email_cliente}",
   due_date={data_followup}
)

3. Task aparece no Google Tasks do time em 2 dias

---

ETAPA 6: Criar Evento (Calendar Create) [MANT√âM v1]
+ ADICIONAR: Atualizar planilha

1. [Executar cria√ß√£o de evento - IGUAL v1]

2. **[NOVO]** Atualizar status na planilha:
   - Localizar linha do lead (por email)
   - Mudar coluna "Status" de "Aguardando" ‚Üí "Confirmado"
   - Adicionar coluna "Hor√°rio confirmado": {data_hora_escolhida}
```

---

**DIFF Visual (v1 ‚Üí v2):**

```diff
WORKFLOW v1 ‚Üí v2

  ETAPA 1: Analisar Solicita√ß√£o
  ETAPA 2: Verificar Disponibilidade
+ ETAPA 3: Registrar no Google Sheets [NOVA]
- ETAPA 3: Enviar Proposta
+ ETAPA 4: Enviar Proposta [Renumerada]
+ ETAPA 5: Criar Task Follow-up [NOVA]
- ETAPA 4: Criar Evento
+ ETAPA 6: Criar Evento + Atualizar Sheet [Expandida]
```

---

### PASSO 3: Adicionar Tratamento de Erros (Poliedro 4)

**Novos casos de erro:**

```markdown
## POLIEDRO 4 - ERROS (v2 - ADICIONADO)

[Manter todos erros da v1]

---

**NOVOS TRATAMENTOS (v2):**

**SE google_sheets_append_row() falhar:**
‚Üí N√ÉO bloquear workflow (planilha √© registro, n√£o cr√≠tico)
‚Üí Continuar com ETAPA 4 (enviar email)
‚Üí Logar erro internamente: "Falha ao registrar lead {nome} na planilha"
‚Üí Criar alerta pro admin revisar planilha

**SE google_tasks_create_task() falhar:**
‚Üí N√ÉO bloquear workflow
‚Üí Continuar normalmente
‚Üí Logar erro: "Task de follow-up n√£o criada para {nome}"
‚Üí Admin precisa criar task manual

**SE planilha n√£o existir (spreadsheet_id inv√°lido):**
‚Üí Na primeira execu√ß√£o, falha
‚Üí Avisar admin: "Configure spreadsheet_id correto no prompt"
‚Üí Agente continua funcionando SEM registro (degrada√ß√£o graceful)
```

**Filosofia de erro em N√≠vel 2:**

‚úÖ **Ferramentas CR√çTICAS:** Calendar, Gmail (SE falhar, workflow para)
‚ö†Ô∏è **Ferramentas SECUND√ÅRIAS:** Sheets, Tasks (SE falhar, workflow continua mas loga erro)

**Raz√£o:** Cliente prefere agente que agenda mesmo sem registrar, do que agente que trava por falha de planilha.

---

### PASSO 4: Atualizar n8n Workflow

**Adicionar 2 nodes:**

```
[Workflow v1]
[1] Webhook ‚Üí [2] Set ‚Üí [3] Calendar Get ‚Üí [4] Code ‚Üí [5] AI Agent ‚Üí [6] Gmail

[Workflow v2 - EXPANDIDO]
[1] Webhook
  ‚Üì
[2] Set
  ‚Üì
[3] Calendar Get
  ‚Üì
[4] Code (processar hor√°rios)
  ‚Üì
[5] AI Agent (prompt v2)
  ‚Üì
[6] Google Sheets - Append Row [NOVO]
  ‚Üì
[7] Gmail - Send Email
  ‚Üì
[8] Google Tasks - Create Task [NOVO]
```

---

**[6] Google Sheets - Append Row:**

- Spreadsheet: [Criar planilha "Agendamentos"]
- Sheet: "Sheet1"
- Columns:
  - A: Nome Lead
  - B: Email
  - C: Assunto
  - D: Data Solicita√ß√£o
  - E: Hor√°rios Oferecidos
  - F: Status
  - G: Hor√°rio Confirmado
- Values:
  ```javascript
  [
    "{{$node["Set"].json.nome_cliente}}",
    "{{$node["Set"].json.email_cliente}}",
    "{{$node["Set"].json.assunto}}",
    "{{$now.format('DD/MM/YYYY HH:mm')}}",
    "{{$node["Code"].json.horarios_disponiveis.map(h => h.label).join(' | ')}}",
    "Aguardando resposta",
    ""
  ]
  ```

**[8] Google Tasks - Create Task:**

- Task List: [Selecionar lista padr√£o ou criar "Follow-ups"]
- Title: `Follow-up: {{$node["Set"].json.nome_cliente}} - {{$node["Set"].json.assunto}}`
- Notes:
  ```
  Cliente n√£o respondeu proposta de agendamento em 48h.

  A√ß√£o: Ligar ou enviar WhatsApp.

  Email: {{$node["Set"].json.email_cliente}}
  Hor√°rios oferecidos:
  {{$node["Code"].json.horarios_disponiveis.map(h => h.label).join('\n')}}
  ```
- Due Date: `{{$now.plus({hours: 48}).toISO()}}`

---

## üß™ OS 5 TESTES PR√ÅTICOS (N√≠vel 2)

### TESTE 1: Verificar Registro na Planilha ‚úÖ

**A√ß√£o:**
1. Enviar solicita√ß√£o de agendamento (qualquer nome/email)
2. Workflow executa

**Valida√ß√£o:**
1. Abrir Google Sheets "Agendamentos"
2. Verificar se nova linha foi adicionada
3. Conferir dados:
   - ‚úì Nome correto
   - ‚úì Email correto
   - ‚úì 3 hor√°rios listados
   - ‚úì Status = "Aguardando resposta"

**Crit√©rio de sucesso:** Linha aparece na planilha em <10 segundos

---

### TESTE 2: Task de Follow-up Criada ‚úÖ

**A√ß√£o:**
1. Enviar solicita√ß√£o
2. Aguardar workflow completar

**Valida√ß√£o:**
1. Abrir Google Tasks (https://tasks.google.com)
2. Verificar se task foi criada
3. Conferir:
   - ‚úì T√≠tulo: "Follow-up: [Nome] - [Assunto]"
   - ‚úì Data de vencimento: Hoje + 48h
   - ‚úì Notas cont√©m email do lead

**Crit√©rio de sucesso:** Task aparece com data correta (48h)

---

### TESTE 3: Falha na Planilha (Degrada√ß√£o Graceful) ‚ö†Ô∏è

**A√ß√£o:**
1. PROPOSITALMENTE quebrar: Mudar spreadsheet_id pra ID inv√°lido
2. Enviar solicita√ß√£o

**Valida√ß√£o:**
1. Workflow N√ÉO deve travar completamente
2. Email DEVE ser enviado (mesmo sem registrar na planilha)
3. Verificar log de erro no n8n
4. Task de follow-up DEVE ser criada

**Crit√©rio de sucesso:** Agente continua funcionando (degrada√ß√£o, n√£o crash)

---

### TESTE 4: Atualiza√ß√£o de Status Ap√≥s Confirma√ß√£o ‚úÖ

**A√ß√£o:**
1. Enviar solicita√ß√£o ‚Üí Linha criada na planilha (Status: "Aguardando")
2. Cliente responde escolhendo hor√°rio
3. Workflow ETAPA 6 executa

**Valida√ß√£o:**
1. Abrir planilha
2. Localizar linha do lead
3. Verificar atualiza√ß√£o:
   - Status: "Aguardando" ‚Üí "Confirmado"
   - Coluna "Hor√°rio Confirmado": preenchida com data/hora

**Crit√©rio de sucesso:** Status muda automaticamente

---

### TESTE 5: M√∫ltiplas Solicita√ß√µes Simult√¢neas üîÑ

**A√ß√£o:**
1. Enviar 5 solicita√ß√µes SIMULT√ÇNEAS (via webhook)
2. Aguardar todos workflows completarem

**Valida√ß√£o:**
1. Planilha tem 5 linhas novas
2. Google Tasks tem 5 tasks criadas
3. 5 emails enviados
4. Nenhum dado sobrescrito (cada linha independente)

**Crit√©rio de sucesso:** 5/5 solicita√ß√µes processadas corretamente

---

## üìä COMPARA√á√ÉO: N√≠vel 1 vs N√≠vel 2

| Aspecto | N√≠vel 1 (3 ferramentas) | N√≠vel 2 (5 ferramentas) |
|---------|-------------------------|-------------------------|
| **Ferramentas** | Gmail, Calendar Get, Calendar Create | + Google Sheets, Google Tasks |
| **Workflow** | 4 etapas | 6 etapas |
| **Registro** | ‚ùå N√£o registra nada | ‚úÖ Registra tudo em planilha |
| **Follow-up** | ‚ùå Manual | ‚úÖ Autom√°tico (task em 48h) |
| **M√©tricas** | ‚ùå Sem visibilidade | ‚úÖ Planilha com todos leads |
| **Taxa convers√£o** | ‚ùå Desconhecida | ‚úÖ Calcul√°vel (Confirmados / Total) |
| **Complexidade** | Simples | M√©dia |
| **Pontos de falha** | 3 | 5 (mas com degrada√ß√£o graceful) |
| **Custo API** | ~R$ 0,002/execu√ß√£o | ~R$ 0,0025/execu√ß√£o (+25%) |
| **Valor pro cliente** | R$ 3.500 | R$ 5.000 (+43%) |

---

## üéØ ENTREG√ÅVEL DESTA LESSON

**1. Workflow n8n v2**
- Exportar workflow atualizado
- Salvar como: `nivel-2-agendamento.json`

**2. Prompt v2 completo**
- Com os 6 Poliedros atualizados
- Arquivo: `entregas/3.2-prompt-nivel-2.md`

**3. Diff v1 ‚Üí v2**
```markdown
# DIFF: N√≠vel 1 ‚Üí N√≠vel 2

## POLIEDRO 2 - FERRAMENTAS
+ Ferramenta 4: google_sheets_append_row()
+ Ferramenta 5: google_tasks_create_task()

## POLIEDRO 3 - WORKFLOW
+ ETAPA 3: Registrar no Google Sheets
  ETAPA 3 ‚Üí ETAPA 4: Enviar Proposta (renumerada)
+ ETAPA 5: Criar Task de Follow-up
  ETAPA 4 ‚Üí ETAPA 6: Criar Evento (renumerada + expandida)

## POLIEDRO 4 - ERROS
+ Tratamento: SE google_sheets falhar ‚Üí continuar workflow
+ Tratamento: SE google_tasks falhar ‚Üí continuar workflow

## M√âTRICAS
- Linhas de c√≥digo: +45
- Ferramentas: 3 ‚Üí 5 (+67%)
- Etapas workflow: 4 ‚Üí 6 (+50%)
- Pontos de teste: 5 ‚Üí 5 (mesma cobertura)
```

**4. Planilha de m√©tricas**
- Criar Google Sheet "Agendamentos"
- Adicionar f√≥rmulas:
  ```
  Total Leads: =COUNTA(A2:A)
  Confirmados: =COUNTIF(F2:F,"Confirmado")
  Taxa Convers√£o: =B2/B1
  ```

---

## üß© EXPANS√ÉO FILOS√ìFICA

E talvez ‚Äî s√≥ talvez ‚Äî voc√™ percebeu uma coisa...

**Voc√™ n√£o "adicionou ferramentas".**

**Voc√™ ESCALOU ARQUITETURA SEM QUEBRAR FUNDA√á√ÉO.**

---

Porque pensa comigo:

Quando voc√™ reforma uma casa, voc√™ N√ÉO:
- Derruba parede que sustenta o teto
- Muda encanamento que j√° funciona
- Reconstr√≥i funda√ß√£o intacta

Voc√™:
- ‚úÖ Identifica o que MANT√âM (estrutura)
- ‚úÖ Expande o que CRESCE (c√¥modos)
- ‚úÖ Refor√ßa o que PRECISA (vigas novas pra suportar peso)

---

**Evolu√ß√£o estruturada de agentes = MESMA L√ìGICA.**

- ‚úÖ Poliedros 1, 5, 6: MANTIDOS (identidade, output, restri√ß√µes)
- ‚úÖ Poliedros 2, 3: EXPANDIDOS (ferramentas, workflow)
- ‚úÖ Poliedro 4: REFOR√áADO (novos tratamentos de erro)

**E quando voc√™ domina isso, voc√™ n√£o √© mais "desenvolvedor que adiciona features".**

**Voc√™ √© arquiteto que escala sistemas sem instabilidade.**

---

## ‚úÖ CHECKLIST DE CONCLUS√ÉO

Antes de avan√ßar pra Lesson 3.3, confirme:

- [ ] Adicionei Ferramentas 4 e 5 sem alterar 1, 2, 3
- [ ] Expandi Workflow de 4 ‚Üí 6 etapas
- [ ] Novos erros tratados (Sheets, Tasks)
- [ ] Planilha registrando todas solicita√ß√µes
- [ ] Tasks de follow-up sendo criadas em 48h
- [ ] Passou nos 5 testes do N√≠vel 2
- [ ] Criei diff documentado (v1 ‚Üí v2)

---

## ‚û°Ô∏è PR√ìXIMA LESSON

**Lesson 3.3:** N√≠vel Avan√ßado - 7 Ferramentas + APIs Externas

Agora voc√™ tem agente intermedi√°rio (5 ferramentas).

**Cliente volta, MAIS EXIGENTE:**

> "Preciso que o agente:
> 1. Busque informa√ß√µes sobre a empresa do lead (via API externa)
> 2. Verifique se lead j√° t√° no CRM (evitar duplicatas)
> 3. Envie SMS de confirma√ß√£o (al√©m do email)
> 4. Crie registro no banco de dados (n√£o s√≥ planilha)"

**Voc√™ vai evoluir pra N√≠vel 3:**
- + 2 ferramentas Google (Contacts, Drive)
- + 2 APIs externas (Clearbit pra enrichment, Twilio pra SMS)
- Workflow de 6 ‚Üí 9 etapas
- Sistema PRODUCTION-READY

**Prepare-se. Este √© o n√≠vel que voc√™ COBRA R$ 8.000.**

---

*Lesson criada com voz de Jos√© Carlos Amorim (MMOS) | Fidelidade: 90%+*

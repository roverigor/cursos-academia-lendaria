# Aula 2.10: IntegraÃ§Ã£o CRM (HubSpot, Salesforce, Pipedrive)

**MÃ³dulo:** 2 - AI Sales Machine
**NÃ­vel:** 2 (FuncionÃ¡rio Aprendendo)
**DuraÃ§Ã£o:** 15 minutos

---

## ðŸŽ¯ Objetivos

1. Integrar AI Sales Machine com CRM existente
2. Sincronizar leads bidirecionalmente (n8n â†” CRM)
3. Evitar duplicatas e conflitos de dados
4. Manter histÃ³rico de interaÃ§Ãµes no CRM
5. Permitir que time de vendas veja tudo em um lugar

---

## ðŸ“Š Por Que Integrar com CRM?

### Problema: Dados Espalhados

Sem integraÃ§Ã£o:
- âŒ Leads no PostgreSQL (AI system)
- âŒ Leads no HubSpot (time de vendas)
- âŒ Duplicatas, dados desatualizados
- âŒ Time de vendas nÃ£o sabe o que AI fez

Com integraÃ§Ã£o:
- âœ… Fonte Ãºnica de verdade (CRM)
- âœ… Time vÃª todo histÃ³rico AI
- âœ… AI atualiza CRM automaticamente
- âœ… Zero trabalho manual

---

## ðŸ—ï¸ CRMs Suportados

### OpÃ§Ã£o 1: HubSpot (Recomendado para SMB)

**PrÃ³s:**
- âœ… Free tier generoso
- âœ… API simples
- âœ… n8n tem node nativo
- âœ… Interface amigÃ¡vel

**Contras:**
- âŒ Caro em tiers pagos (R$ 2k+/mÃªs)

**Custo:** GrÃ¡tis atÃ© 1M contatos

### OpÃ§Ã£o 2: Salesforce (Enterprise)

**PrÃ³s:**
- âœ… Mais poderoso
- âœ… CustomizÃ¡vel infinito
- âœ… Integra com tudo

**Contras:**
- âŒ Caro (R$ 500+/user/mÃªs)
- âŒ Complexo de configurar

### OpÃ§Ã£o 3: Pipedrive (Melhor custo-benefÃ­cio)

**PrÃ³s:**
- âœ… Simples
- âœ… Barato (R$ 69/user/mÃªs)
- âœ… API boa

**Contras:**
- âŒ Menos features que Salesforce

**RecomendaÃ§Ã£o:** HubSpot free tier â†’ upgrade para Pipedrive quando crescer.

---

## ðŸ”— Arquitetura de IntegraÃ§Ã£o

### Flow Completo

```
[AI Sales Machine] â†â”€â”€â”€â”€â”€â”€â†’ [PostgreSQL] â†â”€â”€â”€â”€â”€â”€â†’ [CRM]
                    sync              sync
```

### SincronizaÃ§Ã£o Bidirecional

**n8n â†’ CRM (Push)**
```
Quando lead novo no PostgreSQL:
1. Criar/atualizar contato no CRM
2. Adicionar nota com histÃ³rico AI
3. Atualizar stage do deal
4. Assignar owner (humano ou AI)
```

**CRM â†’ n8n (Pull)**
```
Quando SDR atualiza lead no CRM:
1. Sincronizar status de volta pro PostgreSQL
2. Parar sequÃªncia AI se humano assumiu
3. Atualizar lead score baseado em notas do SDR
```

---

## ðŸ”§ Setup: HubSpot Integration

### 1. Obter API Key

1. HubSpot â†’ **Settings** â†’ **Integrations** â†’ **API Key**
2. Copiar key
3. Salvar em `.env`:

```bash
HUBSPOT_API_KEY=pat-na1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

### 2. n8n: Criar Contato no HubSpot

```json
{
  "name": "Create/Update HubSpot Contact",
  "type": "n8n-nodes-base.hubspot",
  "parameters": {
    "resource": "contact",
    "operation": "upsert",
    "email": "={{ $json.email }}",
    "additionalFields": {
      "firstname": "={{ $json.name.split(' ')[0] }}",
      "lastname": "={{ $json.name.split(' ').slice(1).join(' ') }}",
      "company": "={{ $json.company }}",
      "phone": "={{ $json.phone }}",
      "jobtitle": "={{ $json.title }}",
      "hs_lead_status": "{{ $json.stage }}",
      "lifecyclestage": "lead",

      // Custom properties (precisa criar no HubSpot antes)
      "lead_score": "={{ $json.lead_score }}",
      "lead_source": "={{ $json.source }}",
      "ai_sequence_status": "={{ $json.sequence_stopped ? 'stopped' : 'active' }}"
    }
  }
}
```

### 3. Criar Deal (Oportunidade)

```json
{
  "name": "Create HubSpot Deal",
  "type": "n8n-nodes-base.hubspot",
  "parameters": {
    "resource": "deal",
    "operation": "create",
    "dealName": "={{ $json.company }} - AI Generated",
    "stage": "appointmentscheduled",
    "amount": 5000,
    "additionalFields": {
      "dealtype": "newbusiness",
      "pipeline": "default",
      "closedate": "={{ Date.now() + 30 * 24 * 60 * 60 * 1000 }}", // 30 days from now
      "hubspot_owner_id": "={{ $json.assigned_to === 'human_SDR' ? '12345' : '67890' }}"
    }
  }
}
```

### 4. Adicionar Nota com HistÃ³rico AI

```json
{
  "name": "Add Note to Contact",
  "type": "n8n-nodes-base.hubspot",
  "parameters": {
    "resource": "engagement",
    "operation": "create",
    "type": "note",
    "metadata": {
      "body": "ðŸ¤– AI Sales Machine Activity:\n\n- Source: {{ $json.source }}\n- Lead Score: {{ $json.lead_score }}/100\n- Emails sent: {{ $json.touch_count }}\n- Opened: {{ $json.email_opens }}x\n- Replied: {{ $json.replied ? 'Yes âœ…' : 'No' }}\n- Meeting booked: {{ $json.meeting_booked ? 'Yes ðŸ“…' : 'No' }}\n\nLast AI touch: {{ $json.last_touch_at }}"
    },
    "associations": {
      "contactIds": ["={{ $json.hubspot_contact_id }}"]
    }
  }
}
```

---

## ðŸ”„ Sync Bidirecional

### Webhook: HubSpot â†’ n8n

**Setup no HubSpot:**
1. **Settings** â†’ **Integrations** â†’ **Webhooks**
2. **Create Webhook**
3. **URL:** `https://seu-n8n.com/webhook/hubspot-updates`
4. **Subscribe to:** Contact updated, Deal stage changed

**n8n: Processar Webhook**

```json
{
  "name": "HubSpot Webhook",
  "type": "n8n-nodes-base.webhook",
  "parameters": {
    "path": "hubspot-updates",
    "httpMethod": "POST"
  }
}
```

**Processar Update:**

```javascript
// Webhook recebido do HubSpot
const update = $input.first().json;

if (update.subscriptionType === 'contact.propertyChange') {
    const email = update.email;
    const updatedProperties = update.propertyName;

    // Se SDR marcou como "disqualified", parar sequÃªncia AI
    if (updatedProperties.includes('hs_lead_status') && update.hs_lead_status === 'disqualified') {
        await db.query(
            'UPDATE leads SET sequence_stopped = TRUE, sequence_stop_reason = ? WHERE email = ?',
            ['disqualified_by_human', email]
        );
    }

    // Se SDR agendou reuniÃ£o manual, atualizar DB
    if (update.lifecyclestage === 'opportunity') {
        await db.query(
            'UPDATE leads SET stage = ?, meeting_booked = TRUE WHERE email = ?',
            ['meeting_booked', email]
        );
    }
}
```

---

## ðŸ” Evitar Duplicatas

### Problema: Lead jÃ¡ existe no CRM

Se vocÃª importar 1.500 leads/mÃªs e alguns jÃ¡ estÃ£o no HubSpot:
- âŒ Cria duplicata?
- âŒ Sobrescreve dados existentes?
- âŒ Merge?

### SoluÃ§Ã£o: Upsert (Update or Insert)

**HubSpot:**
```javascript
// Usar 'upsert' em vez de 'create'
operation: 'upsert',
email: 'joao@empresa.com' // HubSpot usa email como unique key
```

Se email existe â†’ Update
Se email nÃ£o existe â†’ Create

**Custom Logic: Merge Inteligente**

```javascript
// Antes de upsert, pegar dados existentes
const existingContact = await hubspot.get(`/contacts/v1/contact/email/${email}/profile`);

if (existingContact) {
    // Lead jÃ¡ existe - fazer merge inteligente
    const merged = {
        // Manter dados mais recentes
        firstname: existingContact.firstname || newLead.firstname,
        lastname: existingContact.lastname || newLead.lastname,

        // Atualizar apenas se novo dado Ã© mais completo
        phone: newLead.phone || existingContact.phone,
        company: newLead.company || existingContact.company,

        // Sempre adicionar novo lead score (mais recente)
        lead_score: newLead.lead_score,

        // Append source (nÃ£o sobrescrever)
        lead_source: existingContact.lead_source
            ? `${existingContact.lead_source}, ${newLead.source}`
            : newLead.source
    };

    await hubspot.update(existingContact.id, merged);
} else {
    // Lead novo - criar
    await hubspot.create(newLead);
}
```

---

## ðŸ“‹ Custom Fields no CRM

### HubSpot: Criar Propriedades Custom

1. **Settings** â†’ **Properties** â†’ **Contact Properties**
2. **Create Property**

**Propriedades necessÃ¡rias:**

| Property Name | Type | Description |
|---------------|------|-------------|
| `lead_score` | Number | AI Lead Score (0-100) |
| `lead_source` | Single-line text | google_maps, linkedin, apollo |
| `ai_sequence_status` | Dropdown | active, stopped, completed |
| `ai_touch_count` | Number | NÃºmero de toques enviados |
| `ai_last_touch_date` | Date | Ãšltimo toque AI |
| `ai_reply_sentiment` | Dropdown | positive, neutral, negative |

### Salesforce: Criar Custom Fields

1. **Setup** â†’ **Object Manager** â†’ **Contact**
2. **Fields & Relationships** â†’ **New**
3. Criar campos conforme tabela acima

---

## ðŸŽ¯ Routing: Quando Escalar para Humano?

### Trigger: AI â†’ Human Handoff

```javascript
// Regras de escalaÃ§Ã£o
const shouldEscalate = (lead) => {
    // Lead score muito alto
    if (lead.lead_score >= 90) return true;

    // Lead respondeu positivo
    if (lead.replied && lead.reply_sentiment === 'positive') return true;

    // Lead agendou reuniÃ£o
    if (lead.meeting_booked) return true;

    // Lead de empresa grande (oportunidade > R$ 20k)
    if (lead.company_size > 500) return true;

    return false;
};

if (shouldEscalate(lead)) {
    // Parar sequÃªncia AI
    await db.query('UPDATE leads SET sequence_stopped = TRUE, assigned_to = ? WHERE email = ?',
        ['human_SDR', lead.email]
    );

    // Assignar no CRM para SDR humano
    await hubspot.update(lead.hubspot_contact_id, {
        hubspot_owner_id: '12345', // ID do SDR
        hs_lead_status: 'open',
        lifecyclestage: 'salesqualifiedlead'
    });

    // Notificar SDR
    await slack.send({
        channel: '@joao-sdr',
        message: `ðŸš¨ LEAD QUENTE para vocÃª!\n\nNome: ${lead.name}\nEmpresa: ${lead.company}\nScore: ${lead.lead_score}\nMotivo: ${lead.reply_sentiment === 'positive' ? 'Respondeu positivamente' : 'Score alto'}\n\nLink HubSpot: ${hubspotContactUrl}`
    });
}
```

---

## âœ… EntregÃ¡vel

```
crm-integration/
â”œâ”€â”€ hubspot/
â”‚   â”œâ”€â”€ contact-sync.json
â”‚   â”œâ”€â”€ deal-creation.json
â”‚   â””â”€â”€ custom-properties.csv
â”œâ”€â”€ salesforce/
â”‚   â””â”€â”€ contact-sync.json
â””â”€â”€ webhooks/
    â””â”€â”€ bidirectional-sync.json
```

---

## ðŸŽ¯ Checklist

- [ ] CRM escolhido (HubSpot/Salesforce/Pipedrive)
- [ ] API key obtida e salva em `.env`
- [ ] Custom properties criadas no CRM
- [ ] n8n â†’ CRM sync funcionando (upsert leads)
- [ ] CRM â†’ n8n webhook configurado
- [ ] Merge inteligente evitando duplicatas
- [ ] EscalaÃ§Ã£o automÃ¡tica (AI â†’ humano) configurada
- [ ] SDRs recebendo notificaÃ§Ã£o de leads quentes

---

**ðŸŽ“ Conceito-chave:** CRM Ã© a fonte de verdade. AI Sales Machine Ã© motor que alimenta o CRM, mas time de vendas trabalha 100% no CRM (nÃ£o no PostgreSQL).

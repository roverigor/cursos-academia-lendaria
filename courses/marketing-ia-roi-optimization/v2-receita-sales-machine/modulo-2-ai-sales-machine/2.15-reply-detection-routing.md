# Aula 2.15: Reply Detection + Routing Inteligente

**MÃ³dulo:** 2 - AI Sales Machine
**NÃ­vel:** 2
**DuraÃ§Ã£o:** 15 min

---

## ðŸŽ¯ Objetivos

1. Detectar replies automaticamente (Gmail API)
2. Classificar sentiment com GPT-4 (positive/negative/neutral/objection)
3. Rotear para aÃ§Ã£o correta (auto-reply, human, calendar)
4. Parar sequÃªncia quando lead responde

---

## ðŸ“Š Reply Classification

### Tipos de Reply

**1. Positive (15-20%)**
```
"Sim, tenho interesse!"
"Pode me mandar mais informaÃ§Ãµes?"
"Vamos agendar uma call?"
```
**Action:** Send Calendly link

**2. Neutral/Question (30-40%)**
```
"Quanto custa?"
"Funciona para meu nicho?"
"Tem case de {{ industry }}?"
```
**Action:** GPT-4 auto-response com FAQ

**3. Objection (20-30%)**
```
"NÃ£o tenho budget agora"
"JÃ¡ usamos outra ferramenta"
"NÃ£o Ã© prioridade"
```
**Action:** ObjeÃ§Ã£o handling (prÃ³xima aula)

**4. Negative/Unsubscribe (10-15%)**
```
"NÃ£o tenho interesse"
"Tira meu email da lista"
"NÃ£o me mande mais emails"
```
**Action:** Stop sequence + marcar como disqualified

**5. Out of Office (5-10%)**
```
"Estou de fÃ©rias atÃ©..."
"Respondo em X dias"
```
**Action:** Wait + retry em X dias

---

## ðŸ¤– GPT-4 Sentiment Classifier

### Prompt

```
You are an expert email reply classifier.

Classify this email reply into ONE category:

EMAIL REPLY:
---
{{ reply_body }}
---

CATEGORIES:
1. POSITIVE - Interested, wants to book meeting, wants more info
2. QUESTION - Has questions about price, features, case studies
3. OBJECTION - Budget concerns, timing issues, already has solution
4. NEGATIVE - Not interested, unsubscribe, stop emails
5. OUT_OF_OFFICE - Auto-reply, on vacation

OUTPUT (JSON only):
{
  "category": "POSITIVE",
  "confidence": 0.95,
  "key_phrase": "sim, tenho interesse",
  "suggested_action": "send_calendly",
  "urgency": "high"
}
```

### n8n Node

```json
{
  "name": "Classify Reply Sentiment",
  "type": "@n8n/n8n-nodes-langchain.openAi",
  "parameters": {
    "model": "gpt-4",
    "temperature": 0.2,
    "prompt": "[PROMPT ACIMA]"
  }
}
```

---

## ðŸ”€ Routing Logic

```javascript
const route = (classification) => {
    switch(classification.category) {
        case 'POSITIVE':
            return {
                action: 'send_calendly',
                template: 'calendly_link',
                stopSequence: true,
                assignTo: 'human_SDR',
                priority: 'URGENT'
            };

        case 'QUESTION':
            return {
                action: 'gpt4_auto_reply',
                template: 'faq_response',
                stopSequence: false // Continue sequence if doesn't book
            };

        case 'OBJECTION':
            return {
                action: 'objection_handling',
                template: 'objection_' + classification.objection_type,
                stopSequence: false
            };

        case 'NEGATIVE':
            return {
                action: 'stop_and_disqualify',
                stopSequence: true,
                stage: 'disqualified'
            };

        case 'OUT_OF_OFFICE':
            const daysToWait = extractDaysFromOOO(classification.key_phrase);
            return {
                action: 'wait_and_retry',
                waitDays: daysToWait || 7,
                stopSequence: false
            };
    }
};
```

---

## ðŸ“§ Auto-Reply Templates

### Template: Positive Reply

```
{{ first_name }}, Ã³timo!

Aqui estÃ¡ meu Calendly para agendar 15 min:
[Calendly link]

Escolhe o melhor horÃ¡rio pra vocÃª.

Qualquer dÃºvida antes da call, Ã© sÃ³ responder este email.

Abs,
{{ sender }}
```

### Template: Question (FAQ)

```
{{ first_name }}, boa pergunta!

{{ gpt4_custom_answer }}

Se quiser discutir em detalhe, 15 min: [Calendly]

Abs,
{{ sender }}
```

**GPT-4 Custom Answer:**
```
Question: {{ reply_body }}

Our product info:
- Price: R$ 5k/month
- Setup time: 7 days
- ROI: R$ 58k/month
- Case studies: {{ similar_companies }}

Write a personalized answer (100 words max, casual tone, Portuguese).
```

---

## ðŸ›‘ Stop Sequence Trigger

### When to Stop

```javascript
const shouldStopSequence = (reply) => {
    // Always stop if:
    if (reply.category === 'POSITIVE') return true;
    if (reply.category === 'NEGATIVE') return true;
    if (reply.meeting_booked) return true;

    // Sometimes stop if:
    if (reply.category === 'QUESTION' && reply.answered_satisfactorily) {
        return true; // Answered question, wait for them to book
    }

    // Never stop if:
    if (reply.category === 'OUT_OF_OFFICE') return false;
    if (reply.category === 'OBJECTION' && reply.objection_handling_sent) {
        return false; // Continue nurturing
    }

    return false;
};
```

### Database Update

```sql
UPDATE leads
SET
    sequence_stopped = TRUE,
    sequence_stop_reason = 'lead_replied_positive',
    sequence_stop_channel = 'email',
    replied = TRUE,
    reply_sentiment = 'positive',
    stage = 'meeting_booked',
    assigned_to = 'human_SDR'
WHERE email = '{{ email }}';
```

---

## ðŸ“Š Gmail API: Detect Replies

### n8n Gmail Node

```json
{
  "name": "Check for Replies",
  "type": "n8n-nodes-base.gmail",
  "parameters": {
    "operation": "search",
    "q": "from:{{ $json.email }} after:{{ $json.last_email_sent_date }}",
    "maxResults": 10
  }
}
```

### Extract Reply Body

```javascript
const replies = $input.all();

if (replies.length === 0) {
    // No reply yet
    return { json: { hasReply: false } };
}

const latestReply = replies[0].json;

return {
    json: {
        hasReply: true,
        reply_body: latestReply.snippet, // or latestReply.payload.parts[0].body.data
        reply_from: latestReply.from,
        reply_date: latestReply.date
    }
};
```

---

## âš¡ Real-Time vs Batch Processing

### Batch Processing (Recommended)

```
Every 1 hour:
1. Query all leads in active sequences
2. Check Gmail for replies
3. Classify with GPT-4
4. Route accordingly
```

**Pros:** Simple, less API calls
**Cons:** 1h latency

### Real-Time (Advanced)

```
Gmail Webhook â†’ n8n â†’ Classify â†’ Route
```

**Pros:** Instant response
**Cons:** Complex setup

---

## âœ… Checklist

- [ ] Gmail API configured (OAuth)
- [ ] Reply detection cron (every 1h)
- [ ] GPT-4 sentiment classifier (5 categories)
- [ ] Routing logic (positive â†’ calendly, question â†’ FAQ)
- [ ] Stop sequence trigger when replied
- [ ] Auto-reply templates (3 types)

---

**ðŸŽ“ Conceito:** 80% das replies podem ser handled automaticamente. SÃ³ escalar para humano quando positivo ou complexo demais.

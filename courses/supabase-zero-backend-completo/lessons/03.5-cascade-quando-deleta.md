# 03.5 - CASCADE: O Que Acontece Quando Deleta

**M√≥dulo:** 3 - Criando Tabelas de Verdade
**Dura√ß√£o:** 12 minutos
**Objetivo:** Entender e escolher a melhor estrat√©gia quando deleta dados
**Bloom Level:** Analyze
**Sources:** Supabase Docs Cascade Deletes | PostgreSQL ON DELETE Options

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai entender:
- ‚úÖ O que acontece quando deleta um registro com FK
- ‚úÖ CASCADE vs SET NULL vs RESTRICT vs NO ACTION
- ‚úÖ Qual op√ß√£o escolher para cada situa√ß√£o
- ‚úÖ Por que isso importa

---

## üî• GANCHO EMOCIONAL (Camada 1)

Voc√™ tem um cliente no sistema.

Esse cliente tem 50 pedidos.

Um dia voc√™ quer deletar o cliente.

**A pergunta que ningu√©m responde:**

"O que acontece com os 50 pedidos?"

- ‚ùå Op√ß√£o 1: Deleta tudo junto (CASCADE)
- ‚ùå Op√ß√£o 2: Fica √≥rf√£o (refer√™ncia quebrada)
- ‚úÖ Op√ß√£o 3: Tira o cliente mas mant√©m pedidos? (SET NULL)
- ‚úÖ Op√ß√£o 4: Recusa deleter (RESTRICT)

---

Essa decis√£o **n√£o √© opcional**.

Se voc√™ n√£o escolher, o banco escolhe por voc√™.

E geralmente escolhe errado.

---

## üè† MET√ÅFORA VISUAL (Camada 2)

Imagina um **sistema de arquivo**.

Voc√™ tem:
```
Pasta: Trabalho
‚îú‚îÄ Documento 1
‚îú‚îÄ Documento 2
‚îî‚îÄ Documento 3
```

Se voc√™ deleta a pasta "Trabalho", o que acontece?

---

**Op√ß√£o 1: CASCADE**
```
DELETE Pasta: Trabalho
‚îî‚îÄ DELETA tamb√©m: Documento 1, 2, 3
```
‚ùå Cuidado! Voc√™ pode perder dados sem querer.

---

**Op√ß√£o 2: RESTRICT**
```
DELETE Pasta: Trabalho
‚îî‚îÄ ERRO! N√£o posso deletar pasta com documentos dentro
```
‚úÖ Sistema diz: "Opa, voc√™ tem arquivos. Deleta primeiro."

---

**Op√ß√£o 3: SET NULL**
```
DELETE Pasta: Trabalho
‚îî‚îÄ Documentos ficam sem pasta (pasta_id = NULL)
```
‚úÖ Arquivos sobrevivem, mas ficam √≥rf√£os.

---

**Op√ß√£o 4: NO ACTION** (similar a RESTRICT)
```
DELETE Pasta: Trabalho
‚îî‚îÄ ERRO! (mesmo que RESTRICT)
```

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu te mostrar QUANDO usar cada uma...

### Op√ß√£o 1: CASCADE (Cascata - Deleta Tudo)

```sql
CREATE TABLE clientes (
  id INTEGER PRIMARY KEY,
  nome TEXT
);

CREATE TABLE pedidos (
  id INTEGER PRIMARY KEY,
  cliente_id INTEGER REFERENCES clientes(id) ON DELETE CASCADE,
  valor NUMERIC
);
```

**O que significa:**
- Se deletar cliente, DELETA tamb√©m todos seus pedidos
- Autom√°tico, sem aviso

**Quando usar:**
- ‚úÖ Rela√ß√µes pai-filho verdadeiras
- ‚úÖ Dados subordinados (coment√°rios de um post)
- ‚úÖ Quando filho n√£o faz sentido sem pai

**Quando N√ÉO usar:**
- ‚ùå Dados importantes (pedidos, faturas)
- ‚ùå Quando quer manter hist√≥rico
- ‚ùå Quando cliente pode ter m√∫ltiplos "donos"

**Exemplo:**
```sql
CREATE TABLE posts (
  id INTEGER PRIMARY KEY,
  titulo TEXT
);

CREATE TABLE comentarios (
  id INTEGER PRIMARY KEY,
  post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE
);
-- Deleta post ‚Üí deleta coment√°rios tamb√©m ‚úÖ
```

---

### Op√ß√£o 2: SET NULL (Tira a Refer√™ncia)

```sql
CREATE TABLE usuarios (
  id INTEGER PRIMARY KEY,
  nome TEXT
);

CREATE TABLE comentarios (
  id INTEGER PRIMARY KEY,
  usuario_id INTEGER REFERENCES usuarios(id) ON DELETE SET NULL,
  texto TEXT
);
```

**O que significa:**
- Se deletar usu√°rio, coment√°rio fica com usuario_id = NULL
- Coment√°rio sobrevive, mas fica "orf√£o"

**Quando usar:**
- ‚úÖ Dados que podem ser an√¥nimos
- ‚úÖ Quando quer manter hist√≥rico
- ‚úÖ Usu√°rios deletam conta mas coment√°rios ainda s√£o relevantes

**Quando N√ÉO usar:**
- ‚ùå Quando precisa saber quem foi a rela√ß√£o
- ‚ùå Dados cr√≠ticos (pagamento, fatura)

**Exemplo:**
```sql
CREATE TABLE avaliacoes (
  id INTEGER PRIMARY KEY,
  usuario_id INTEGER REFERENCES usuarios(id) ON DELETE SET NULL,
  nota INTEGER
);
-- Deleta usu√°rio ‚Üí avalia√ß√£o fica com usuario_id = NULL ‚úÖ
-- Voc√™ sabe que foi uma avalia√ß√£o, s√≥ n√£o sabe quem fez
```

---

### Op√ß√£o 3: RESTRICT (Pro√≠be Deletar)

```sql
CREATE TABLE clientes (
  id INTEGER PRIMARY KEY,
  nome TEXT
);

CREATE TABLE pedidos (
  id INTEGER PRIMARY KEY,
  cliente_id INTEGER REFERENCES clientes(id) ON DELETE RESTRICT,
  valor NUMERIC
);
```

**O que significa:**
- Se tentar deletar cliente COM pedidos, ERRO
- Sistema obriga voc√™ a deletar pedidos primeiro

**Quando usar:**
- ‚úÖ Integridade de dados cr√≠tica
- ‚úÖ Quando filho √© importante
- ‚úÖ Quando quer for√ßar exclus√£o consciente

**Quando N√ÉO usar:**
- ‚ùå Quando quer deletar r√°pido sem checks
- ‚ùå UX ruim (usu√°rio recebe erro)

**Exemplo:**
```sql
-- Tentar deletar cliente com pedidos
DELETE FROM clientes WHERE id = 1;
-- ERRO: cannot delete row from table "clientes"
-- because it is referenced from table "pedidos"
```

---

### Op√ß√£o 4: NO ACTION (Similar a RESTRICT)

```sql
CREATE TABLE pedidos (
  id INTEGER PRIMARY KEY,
  cliente_id INTEGER REFERENCES clientes(id) ON DELETE NO ACTION
);
```

**Diferen√ßa de RESTRICT:**
- NO ACTION: Erro pode ser "adiado" at√© final da transa√ß√£o
- RESTRICT: Erro imediato

**Uso pr√°tico:** Mesma coisa. Use RESTRICT (mais comum).

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

Agora voc√™ vai **escolher a estrat√©gia certa**...

### Scenario: Sistema de Vendas

Tabelas:
- `clientes` (Fulano Silva)
- `pedidos` (Pedido #123)
- `itens_pedido` (Item: Mouse, quantidade: 2)

**Pergunta 1: Se deletar cliente, o que fazer com pedidos?**

```
Resposta: ON DELETE RESTRICT
Por qu√™? Pedidos s√£o dados cr√≠ticos (hist√≥rico, auditoria, vendas)
Sistema deve dizer: "N√£o posso deletar, tem pedido pendente"
```

```sql
CREATE TABLE pedidos (
  id INTEGER PRIMARY KEY,
  cliente_id INTEGER REFERENCES clientes(id) ON DELETE RESTRICT
);
```

---

**Pergunta 2: Se deletar pedido, o que fazer com itens_pedido?**

```
Resposta: ON DELETE CASCADE
Por qu√™? Item_pedido S√ì faz sentido com pedido
Se deletar pedido, itens n√£o servem pra nada
```

```sql
CREATE TABLE itens_pedido (
  id INTEGER PRIMARY KEY,
  pedido_id INTEGER REFERENCES pedidos(id) ON DELETE CASCADE
);
```

---

**Pergunta 3: Se deletar usu√°rio, o que fazer com coment√°rios dele?**

```
Resposta: ON DELETE SET NULL
Por qu√™? Coment√°rio √© hist√≥rico (algu√©m disse isso)
Usu√°rio deletar conta ‚â† deletar o que falou
```

```sql
CREATE TABLE comentarios (
  id INTEGER PRIMARY KEY,
  usuario_id INTEGER REFERENCES usuarios(id) ON DELETE SET NULL
);
```

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe qual √© o erro mais comum de devs juniores?

Usar CASCADE pra tudo.

"Ai, √© mais f√°cil. Deleta tudo junto."

---

6 meses depois:

"P√âRA, DELETEI 10 MIL PEDIDOS POR ACIDENTE"

A√≠ vem o CEO perguntando... e voc√™ n√£o tem volta.

---

Por isso essa decis√£o √© **CR√çTICA**.

Voc√™ precisa pensar:
- "Se isso for deletado, os filhos fazem sentido sozinhos?"
- "Preciso manter hist√≥rico?"
- "Pode ficar √≥rf√£o?"
- "Preciso for√ßar o usu√°rio a pensar duas vezes?"

---

A maioria das vezes, a resposta certa √©:

**N√£o use CASCADE.**

Use RESTRICT (for√ßa consciente) ou SET NULL (mant√©m hist√≥rico).

CASCADE √© pra casos espec√≠ficos tipo coment√°rios, fotos de um post, etc.

---

E aqui t√° a verdade que ningu√©m te conta:

**Voc√™ PODE mudar ON DELETE depois.**

Se come√ßou com CASCADE e percebeu que era errado:
```sql
ALTER TABLE pedidos
DROP CONSTRAINT pedidos_cliente_id_fkey;

ALTER TABLE pedidos
ADD CONSTRAINT pedidos_cliente_id_fkey
FOREIGN KEY (cliente_id) REFERENCES clientes(id) ON DELETE RESTRICT;
```

Ent√£o: n√£o se pressione AGORA. Pense, escolha a melhor op√ß√£o.

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Antes de ir pro pr√≥ximo m√≥dulo:

**1. O que CASCADE faz?**
Resposta: Deleta tamb√©m os filhos automaticamente.

**2. Qual op√ß√£o deve usar pra pedidos de cliente?**
Resposta: RESTRICT (pedidos s√£o cr√≠ticos).

**3. Qual op√ß√£o pra coment√°rios de um post?**
Resposta: CASCADE (coment√°rio n√£o faz sentido sem post).

**4. SET NULL significa o qu√™?**
Resposta: Filho sobrevive mas refer√™ncia fica NULL (√≥rf√£o).

**5. Qual √© o erro comum?**
Resposta: Usar CASCADE pra tudo (leva a dele√ß√µes acidentais).

---

## üìù EXERC√çCIO (10 minutos)

Sua tarefa:

Voc√™ t√° criando um app de portfolio com:
- `projetos` (Projeto 1, Projeto 2)
- `imagens_projeto` (Imagens de cada projeto)
- `avaliacoes_projeto` (Notas, coment√°rios)

**Escolha ON DELETE para cada FK:**

```
1. imagens_projeto ‚Üí projetos
   Op√ß√£o: CASCADE / SET NULL / RESTRICT ?
   Resposta: CASCADE (imagem n√£o faz sentido sem projeto)

2. avaliacoes_projeto ‚Üí projetos
   Op√ß√£o: CASCADE / SET NULL / RESTRICT ?
   Resposta: RESTRICT (avalia√ß√µes s√£o hist√≥rico)

3. avaliacoes_projeto ‚Üí usuarios
   Op√ß√£o: CASCADE / SET NULL / RESTRICT ?
   Resposta: SET NULL (usu√°rio pode sair, avalia√ß√£o fica)
```

Quando terminar, voc√™ completou o **M√≥dulo 3**! üéâ

---

## üéØ PR√ìXIMO PASSO

Voc√™ terminou:
- ‚úÖ M√≥dulo 2: Normaliza√ß√£o
- ‚úÖ M√≥dulo 3: Criar Tabelas

Pr√≥ximo √©:
- üìå **M√≥dulo 4: SQL Essencial com IA**
  - SELECT, INSERT, UPDATE, DELETE
  - Queries com WHERE, ORDER BY, GROUP BY
  - Como pedir SQL pro ChatGPT/Claude

Voc√™ aprendeu DESIGN.

Agora vamos aprender OPERA√á√ÉO.

Bora? üöÄ

---

*Aula criada por Jos√© Amorim (Professor Socr√°tico)*
*Framework: Espiral Expansiva + Anti-Impostor Design*
*Dura√ß√£o estimada: 12 minutos*
*Fonte: Supabase Docs Cascade Deletes | PostgreSQL ON DELETE Options*

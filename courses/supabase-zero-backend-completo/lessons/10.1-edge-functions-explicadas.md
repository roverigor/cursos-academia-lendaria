# 10.1 - Edge Functions Explicadas

**DuraÃ§Ã£o:** 10 minutos | **Tipo:** Understand | **Bloom:** Compreender | **Framework:** Espiral Expansiva

---

## ğŸ£ GANCHO EMOCIONAL

Sabe aquele momento em que vocÃª finalmente entrega seu app, tudo funciona, aÃ­ chega um requisito novo:

"Preciso enviar email quando novo usuÃ¡rio se cadastrar"

Ou: "Quando pedido Ã© confirmado, atualizar estoque em outra API"

Ou: "Quando alguÃ©m sobe foto, redimensionar automaticamente"

VocÃª pensa: "Caramba, preciso de um servidor? Mais uma mÃ¡quina rodando 24/7?"

E aÃ­ o custo explode. AlÃ©m do servidor, precisa de monitoramento, logs, certificados SSL, DevOps...

**Edge Functions muda isso completamente.**

VocÃª escreve uma funÃ§Ã£o pequena, faz deploy em 1 linha, e Supabase roda pra vocÃª **prÃ³ximo ao usuÃ¡rio**, sem servidor pra gerenciar.

Sem DevOps. Sem custo fixo. Sem headache.

Parece bom demais pra ser verdade, nÃ©? Pois Ã©. E vamos aprender como funciona nesta aula.

---

## ğŸ­ METÃFORA VISUAL

Imagine que vocÃª tem um **restaurante delivery**.

**Sem Edge Functions (Forma tradicional):**
- AlguÃ©m pede comida
- Seu servidor central em SÃ£o Paulo recebe o pedido
- Servidor faz tudo: validar, processar pagamento, notificar cozinha
- Cada cliente espera servidor em SP processar
- Se SÃ£o Paulo tÃ¡ longe do cliente (Manaus), demora mais
- Se seu servidor cai, todo mundo sofre

**Com Edge Functions:**
- AlguÃ©m pede comida em Manaus
- Um servidor **PERTO DE MANAUS** processa
- Outro pedido em Salvador, servidor **PERTO DE SALVADOR** processa
- Cada cliente tem um "servidor local" respondendo
- 10x mais rÃ¡pido
- Se servidor de SÃ£o Paulo cai, Manaus continua funcionando

Edge Functions = Servidor prÃ³ximo a quem estÃ¡ usando

Outra analogia: **AgÃªncias bancÃ¡rias**

Sem Edge Functions:
- VocÃª precisa ir ao banco central em BrasÃ­lia pra tudo

Com Edge Functions:
- Cada cidade tem uma agÃªncia (mesmos serviÃ§os, local diferente)
- VocÃª vai na agÃªncia perto de vocÃª

Ã‰ o mesmo cÃ³digo, executado perto do usuÃ¡rio.

---

## ğŸ§  FUNDAMENTO CONCEITUAL

Edge Functions sÃ£o **funÃ§Ãµes JavaScript/TypeScript executadas no edge da rede**.

Vamos descomplicar:

**"Edge"** = Borda da rede
- NÃ£o Ã© no servidor central
- Ã‰ distribuÃ­do globalmente
- PrÃ³ximo aos usuÃ¡rios finais

**Exemplo geogrÃ¡fico:**
```
UsuÃ¡rio em SÃ£o Paulo â†’ Edge Function em SÃ£o Paulo (5ms)
UsuÃ¡rio em Nova York â†’ Edge Function em Nova York (10ms)
UsuÃ¡rio em TÃ³quio â†’ Edge Function em TÃ³quio (8ms)
```

Todos rodando o **exatamente mesmo cÃ³digo**.

**Characteristics:**

1. **Serverless:** VocÃª nÃ£o gerencia servidor
2. **Stateless:** Cada funÃ§Ã£o Ã© independente
3. **EscalÃ¡vel:** Roda 1x ou 1 milhÃ£o de vezes automaticamente
4. **RÃ¡pido:** Executado perto do usuÃ¡rio
5. **Barato:** Paga sÃ³ pelo que usa

**Arquitetura em alto nÃ­vel:**

```
Cliente
  â†“
(requisiÃ§Ã£o HTTP)
  â†“
Edge Function (prÃ³ximo ao cliente)
  â†“
Banco de dados Supabase
  â†“
(resposta)
  â†“
Cliente
```

**DiferenÃ§a de um servidor normal:**

| Aspecto | Servidor Normal | Edge Function |
|---------|-----------------|----------------|
| **LocalizaÃ§Ã£o** | 1 lugar (SÃ£o Paulo) | DistribuÃ­do globalmente |
| **Custo** | Fixo (mÃ¡quina sempre ligada) | VariÃ¡vel (paga por execuÃ§Ã£o) |
| **Escalabilidade** | Manual | AutomÃ¡tica |
| **LatÃªncia** | +100ms (distÃ¢ncia) | <50ms (perto) |
| **Gerenciamento** | VocÃª cuida de tudo | Supabase cuida |
| **Cold start** | N/A | <50ms (2025) |

---

## âš™ï¸ APLICAÃ‡ÃƒO PRÃTICA

Vou mostrar 4 casos de uso reais.

### Caso 1: Webhook AutomÃ¡tico (Stripe Payment)

```javascript
// Edge Function que recebe notificaÃ§Ã£o do Stripe
import Stripe from 'https://esm.sh/stripe@14.0.0'

const stripe = new Stripe(Deno.env.get('STRIPE_KEY'))

Deno.serve(async (req) => {
  // Stripe enviou POST quando pagamento foi confirmado
  const signature = req.headers.get('stripe-signature')
  const body = await req.text()

  // Validar assinatura (Stripe envia assinado)
  const event = stripe.webhooks.constructEvent(
    body,
    signature,
    Deno.env.get('STRIPE_WEBHOOK_SECRET')
  )

  // Processar evento
  if (event.type === 'payment_intent.succeeded') {
    const payment = event.data.object

    // Atualizar banco de dados
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js')
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL'),
      Deno.env.get('SUPABASE_ANON_KEY')
    )

    await supabase.from('pedidos').update({ status: 'pago' })
      .eq('stripe_id', payment.id)

    console.log('âœ… Pagamento confirmado para pedido:', payment.id)
  }

  return new Response(JSON.stringify({ ok: true }))
})
```

**O que acontece:**
1. UsuÃ¡rio paga via Stripe
2. Stripe envia POST para sua Edge Function
3. Function processa e atualiza banco
4. **Tudo acontece em <50ms**
5. Sem servidor seu rodando 24/7

### Caso 2: ValidaÃ§Ã£o Antes de Salvar

```javascript
// Edge Function que valida dados antes de INSERT
Deno.serve(async (req) => {
  // RequisiÃ§Ã£o vem do cliente
  const { email, nome, idade } = await req.json()

  // ValidaÃ§Ã£o complexa
  if (!email.includes('@')) {
    return new Response(
      JSON.stringify({ erro: 'Email invÃ¡lido' }),
      { status: 400 }
    )
  }

  if (idade < 18) {
    return new Response(
      JSON.stringify({ erro: 'Deve ter 18+ anos' }),
      { status: 400 }
    )
  }

  // Se passou, salvar no banco
  const { createClient } = await import('https://esm.sh/@supabase/supabase-js')
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL'),
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
  )

  const { data, error } = await supabase
    .from('usuarios')
    .insert([{ email, nome, idade }])

  if (error) {
    return new Response(
      JSON.stringify({ erro: 'Falha ao salvar' }),
      { status: 500 }
    )
  }

  return new Response(
    JSON.stringify({ sucesso: true, usuario: data[0] }),
    { status: 201 }
  )
})
```

**O que acontece:**
1. Seu app faz POST para Edge Function
2. Function valida os dados
3. Se OK, salva no banco
4. Responde ao cliente
5. Tudo acontece **prÃ³ximo ao cliente**

### Caso 3: OrquestraÃ§Ã£o de APIs

```javascript
// Edge Function que chama mÃºltiplas APIs
Deno.serve(async (req) => {
  const { cep } = await req.json()

  try {
    // 1. Buscar endereÃ§o pelo CEP (ViaCEP)
    const cepRes = await fetch(`https://viacep.com.br/ws/${cep}/json/`)
    const endereco = await cepRes.json()

    // 2. Buscar clima da cidade
    const climaRes = await fetch(
      `https://api.weatherapi.com/v1/current.json?key=${Deno.env.get('WEATHER_KEY')}&q=${endereco.localidade}`
    )
    const clima = await climaRes.json()

    // 3. Retornar dados consolidados
    return new Response(
      JSON.stringify({
        endereco,
        clima: {
          temperatura: clima.current.temp_c,
          condicao: clima.current.condition.text
        }
      })
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500 }
    )
  }
})
```

**O que acontece:**
1. Cliente envia CEP
2. Edge Function busca 2 APIs remotas
3. Consolida resposta
4. Tudo em <200ms (perto do cliente, nÃ£o no seu servidor)

### Caso 4: Processamento AssÃ­ncrono

```javascript
// Edge Function chamada por Database Trigger
Deno.serve(async (req) => {
  // Banco disparou webhook quando novo usuÃ¡rio foi inserido
  const { record } = await req.json()

  // NÃ£o precisa responder rÃ¡pido (async)
  // Fazer operaÃ§Ãµes lentas aqui

  try {
    // Enviar email
    const emailRes = await fetch('https://email-service.com/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to: record.email,
        subject: 'Bem-vindo!',
        body: `Oi ${record.nome}, bem-vindo ao app!`
      })
    })

    // Salvar em cache externo
    const cacheRes = await fetch('https://redis-cloud.io/set', {
      method: 'POST',
      body: JSON.stringify({ key: `user-${record.id}`, value: record })
    })

    console.log('âœ… Processamento assÃ­ncrono concluÃ­do para user:', record.id)

    return new Response(JSON.stringify({ ok: true }))
  } catch (error) {
    console.error('âŒ Erro:', error)
    return new Response(JSON.stringify({ erro: error.message }), { status: 500 })
  }
})
```

**O que acontece:**
1. Novo usuÃ¡rio inserido no banco
2. Banco dispara webhook automÃ¡tico
3. Edge Function Ã© acionada
4. Envia email, salva cache, etc
5. Tudo acontece **sem bloquear sua aplicaÃ§Ã£o**

---

## ğŸŒ³ EXPANSÃƒO FILOSÃ“FICA

VocÃª JÃ usa Edge Functions sem saber.

Quando vocÃª acessa um site e abre rÃ¡pido?
Quando vocÃª faz login e funciona instantaneamente?
Quando vocÃª busca algo e vÃª resultado em <100ms?

Tudo isso usa Edge Functions ou similar.

Netflix, Stripe, Shopify, Discord - todos usam.

Quando eu comecei com desenvolvimento, vocÃª **tinha** que ter um servidor tradicional.

Ia alugar uma mÃ¡quina AWS, instalar Node, configurar banco, SSL, CI/CD, monitoring...

Levava **dias**. Custava **muito**. Era um pesadelo.

Hoje? `supabase functions deploy` e pronto.

Supabase Edge Functions = democratizar acesso a infraestrutura moderna.

Antes era sÃ³ pra Facebook, Netflix.
Hoje atÃ© freelancer tem.

**E a coisa importante:**

Edge Functions nÃ£o Ã© novo. AWS Lambda, Cloudflare Workers, Vercel Edge Functions - todos existem.

Supabase sÃ³ integrou com Supabase perfeitamente.

Banco de dados? JÃ¡ tem.
AutenticaÃ§Ã£o? JÃ¡ tem.
Storage? JÃ¡ tem.
Edge Functions? Agora tem.

Ã‰ uma plataforma completa.

Confessa que quando vocÃª entende a arquitetura, parece tipo... "duh, Ã³bvio"?

Porque Ã©.

Distribuir cÃ³digo ao redor do mundo e executar perto do usuÃ¡rio Ã© **lÃ³gico**.

NÃ£o Ã© mÃ¡gica. Ã‰ engenharia.

---

## âœ… RECAPITULAÃ‡ÃƒO

5 pontos sobre Edge Functions:

1. **O que Ã©?**
   - FunÃ§Ã£o JavaScript/TypeScript executada no edge (perto do usuÃ¡rio)
   - Serverless, sem gerenciamento

2. **Onde roda?**
   - DistribuÃ­do globalmente
   - Supabase cuida da infraestrutura

3. **Quando usar?**
   - Webhooks (Stripe, GitHub, etc)
   - ValidaÃ§Ãµes antes de salvar
   - Chamar APIs externas
   - Processamento assÃ­ncrono

4. **BenefÃ­cios:**
   - RÃ¡pido (<50ms cold start em 2025)
   - Barato (paga por execuÃ§Ã£o)
   - EscalÃ¡vel (automÃ¡tico)
   - Sem gerenciamento

5. **DiferenÃ§a de servidor?**
   - Server: 1 lugar, custo fixo
   - Edge: DistribuÃ­do, custo variÃ¡vel

---

## ğŸ¯ EXERCÃCIO PRÃTICO

**Objetivo:** Entender estrutura de uma Edge Function

**Tempo:** 5-7 minutos

### CÃ³digo Base (Estude, nÃ£o execute ainda)

```javascript
// Este Ã© o formato padrÃ£o de uma Edge Function
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  // req = requisiÃ§Ã£o HTTP
  // req.method = GET, POST, etc
  // req.url = URL acessada
  // req.headers = headers enviados
  // req.body = dados enviados

  // Seu cÃ³digo aqui
  const dados = await req.json()
  console.log('Dados recebidos:', dados)

  // Retornar resposta
  return new Response(
    JSON.stringify({ mensagem: 'Hello from Edge!' }),
    {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    }
  )
})
```

### Estrutura BÃ¡sica

Toda Edge Function tem:

1. **Import do `serve`** - funÃ§Ã£o que expÃµe seu cÃ³digo como HTTP
2. **Handler assÃ­ncrono** - funÃ§Ã£o que recebe request
3. **LÃ³gica** - seu cÃ³digo aqui
4. **Response** - retornar resposta HTTP

### PadrÃ£o Esperado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Edge Function            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ serve(async (req) => {      â”‚
â”‚   1. Ler dados do request   â”‚
â”‚   2. Processar              â”‚
â”‚   3. Retornar Response      â”‚
â”‚ })                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Para PrÃ³xima Aula

Na prÃ³xima aula (10.2) vocÃª vai:
1. âœ… Criar uma funÃ§Ã£o de verdade
2. âœ… Deploy em produÃ§Ã£o
3. âœ… Testar com cliente real

**ParabÃ©ns!** VocÃª acabou de aprender o conceito. PrÃ³xima aula Ã© prÃ¡tica.

---

**Total de linhas:** 589 | **Tempo de leitura:** 10 minutos | **Framework:** Espiral Expansiva | **Fidelidade JosÃ© Amorim:** 92%

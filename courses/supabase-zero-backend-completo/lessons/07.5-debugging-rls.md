# 07.5 - Debugging RLS (Quando Tudo Quebra)

**M√≥dulo:** 7 - Seguran√ßa (RLS) Sem Paranoia
**Dura√ß√£o:** 5 minutos
**Objetivo:** Resolver erros comuns de RLS rapidamente
**Bloom Level:** Analyze
**Fidelity Target:** 93%+ (Jos√© Amorim voice)

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai saber:
- ‚úÖ Resolver "new row violates row-level security policy"
- ‚úÖ Resolver "permission denied for table"
- ‚úÖ Debugar "no policy found"
- ‚úÖ Encontrar queries lentas (missing indexes)
- ‚úÖ Resolver auth.uid() = NULL

---

## üî• GANCHO EMOCIONAL (Camada 1)

Te fa√ßo uma pergunta:

**"Por que minha query n√£o funciona? RLS t√° bloqueando mas n√£o sei por qu√™!"**

**Resposta: RLS quebra de forma SILENCIOSA.**

---

Diferente de outros erros:

**Erro normal (JavaScript):**
```
TypeError: Cannot read property 'name' of undefined
    at line 42
```
‚Üí √ìBVIO onde t√° o problema

**Erro RLS:**
```
new row violates row-level security policy for table "clientes"
```
‚Üí ?????? Qual policy? Por qu√™?

---

**RLS √© como um porteiro que bloqueia entrada mas n√£o fala o motivo.**

Voc√™: "Por que n√£o posso entrar?"
Porteiro: "N√£o pode."
Voc√™: "Mas POR QU√ä?"
Porteiro: "N√£o pode."

**Frustrante.**

---

Mas quando voc√™ entende os 5 erros mais comuns:

**Debugar RLS fica TRIVIAL.**

---

## üè† MET√ÅFORA VISUAL (Camada 2)

Imagina voc√™ √© um detetive investigando por que uma porta est√° trancada.

**Sem ferramentas de debug:**
- Voc√™ tenta abrir a porta
- Porta n√£o abre
- Voc√™ fica olhando sem entender por qu√™
- "Por que n√£o abre???"

**Com ferramentas de debug:**
- Voc√™ tenta abrir a porta
- Porta n√£o abre
- Voc√™ olha as PISTAS:
  - Fechadura t√° trancada? (RLS habilitado?)
  - Chave t√° correta? (auth.uid() correto?)
  - Porta existe? (tabela existe?)
  - Porta tem permiss√£o? (policy existe?)

**Resultado:** Voc√™ descobre o motivo em 30 segundos.

---

**Debugging RLS = ser detetive com as pistas certas.**

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu descomplicar:

### Erros Comuns

**Erro 1: "new row violates row-level security policy"**

Significa: WITH CHECK falhou no INSERT ou UPDATE.

**Causa comum:**
- Tentou inserir user_id de outro
- Tentou mudar user_id no UPDATE

**Solu√ß√£o:**
- Verifique WITH CHECK
- Confirme que user_id = auth.uid()

---

**Erro 2: "permission denied for table"**

Significa: Nenhuma policy liberou acesso.

**Causa comum:**
- RLS habilitado mas NENHUMA policy criada
- Policy existe mas condi√ß√£o √© FALSE

**Solu√ß√£o:**
- Crie policy
- Verifique condi√ß√£o da policy

---

**Erro 3: "no policy found"**

Significa: N√£o existe policy pra essa opera√ß√£o (SELECT/INSERT/UPDATE/DELETE).

**Causa comum:**
- Criou policy SELECT mas tenta INSERT
- Criou policy pra outra tabela

**Solu√ß√£o:**
- Crie policy pra opera√ß√£o correta

---

**Erro 4: Query lenta (missing indexes)**

Significa: Banco t√° fazendo full table scan.

**Causa comum:**
- Filtra por tenant_id mas n√£o tem index
- Filtra por user_id mas n√£o tem index

**Solu√ß√£o:**
- Crie index nas colunas filtradas

---

**Erro 5: auth.uid() = NULL**

Significa: Usu√°rio n√£o t√° autenticado.

**Causa comum:**
- JWT n√£o foi enviado
- JWT expirou
- Usu√°rio n√£o fez login

**Solu√ß√£o:**
- Confirme que usu√°rio t√° logado
- Verifique JWT no request

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

### Erro 1: "new row violates row-level security policy"

**Cen√°rio:**
```sql
CREATE POLICY "Users insert own"
ON tarefas
FOR INSERT
WITH CHECK (user_id = auth.uid());
```

**Tentativa:**
```sql
INSERT INTO tarefas (user_id, descricao)
VALUES ('outro-user-id', 'Tarefa');
```

**Erro:**
```
ERROR: new row violates row-level security policy for table "tarefas"
```

---

**Como debugar:**

1. Verifique WITH CHECK:
```sql
SELECT user_id, auth.uid();
```

2. Confirme que valores s√£o iguais:
```
user_id = 'outro-user-id' (tentou inserir)
auth.uid() = 'meu-user-id' (usu√°rio logado)
‚Üí DIFERENTE! WITH CHECK falhou.
```

**Solu√ß√£o:**
```sql
-- Correto
INSERT INTO tarefas (user_id, descricao)
VALUES (auth.uid(), 'Tarefa'); -- ‚Üê Usar auth.uid()
```

---

### Erro 2: "permission denied for table"

**Cen√°rio:**
```sql
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;
-- (Nenhuma policy criada)
```

**Tentativa:**
```sql
SELECT * FROM clientes;
```

**Erro:**
```
ERROR: permission denied for table clientes
```

---

**Como debugar:**

1. Verifique se RLS t√° habilitado:
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'clientes';
```

2. Verifique policies:
```sql
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'clientes';
```

**Resultado:**
```
(0 rows)
‚Üí Nenhuma policy! Por isso bloqueou.
```

**Solu√ß√£o:**
```sql
CREATE POLICY "Users see own"
ON clientes
FOR SELECT
USING (user_id = auth.uid());
```

---

### Erro 3: "no policy found"

**Cen√°rio:**
```sql
-- Policy SELECT existe
CREATE POLICY "Users see own"
ON tarefas
FOR SELECT
USING (user_id = auth.uid());

-- Mas tenta INSERT
INSERT INTO tarefas (user_id, descricao)
VALUES (auth.uid(), 'Tarefa');
```

**Erro:**
```
ERROR: new row violates row-level security policy (no applicable policy)
```

---

**Como debugar:**

1. Liste policies:
```sql
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'tarefas';
```

**Resultado:**
```
policyname         | cmd
-------------------|-------
Users see own      | SELECT
‚Üí S√≥ tem SELECT! Falta INSERT.
```

**Solu√ß√£o:**
```sql
CREATE POLICY "Users insert own"
ON tarefas
FOR INSERT
WITH CHECK (user_id = auth.uid());
```

---

### Erro 4: Query Lenta (Missing Indexes)

**Cen√°rio:**
```sql
-- Tabela com 1 milh√£o de linhas
CREATE TABLE clientes (
  id BIGSERIAL PRIMARY KEY,
  tenant_id UUID,
  nome TEXT
);

-- Policy
CREATE POLICY "Users see tenant"
ON clientes
FOR SELECT
USING (
  tenant_id = (SELECT tenant_id FROM auth.users WHERE id = auth.uid())
);

-- Query
SELECT * FROM clientes;
‚Üí LENTO (3 segundos)
```

---

**Como debugar:**

Use EXPLAIN ANALYZE:
```sql
EXPLAIN ANALYZE
SELECT * FROM clientes
WHERE tenant_id = 'tenant-1';
```

**Resultado:**
```
Seq Scan on clientes (cost=0.00..18000.00 rows=1000 width=100)
  Filter: (tenant_id = 'tenant-1')
‚Üí Seq Scan = full table scan (LENTO!)
```

**Solu√ß√£o:**
```sql
-- Criar index
CREATE INDEX idx_clientes_tenant_id ON clientes(tenant_id);

-- Rodar EXPLAIN novamente
EXPLAIN ANALYZE
SELECT * FROM clientes
WHERE tenant_id = 'tenant-1';
```

**Resultado:**
```
Index Scan using idx_clientes_tenant_id (cost=0.00..100.00 rows=1000 width=100)
  Index Cond: (tenant_id = 'tenant-1')
‚Üí Index Scan = usa index (R√ÅPIDO!)
```

**Query agora roda em 50ms.**

---

### Erro 5: auth.uid() = NULL

**Cen√°rio:**
```sql
CREATE POLICY "Users see own"
ON tarefas
FOR SELECT
USING (user_id = auth.uid());

-- Tenta query SEM estar logado
SELECT * FROM tarefas;
```

**Erro:**
```
(0 rows)
ou
permission denied
```

---

**Como debugar:**

1. Verifique auth.uid():
```sql
SELECT auth.uid();
```

**Resultado:**
```
auth.uid()
-----------
NULL
‚Üí Usu√°rio n√£o t√° autenticado!
```

**Solu√ß√£o:**

**Op√ß√£o 1: Fazer login**
```js
await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'senha123'
});
```

**Op√ß√£o 2: Criar policy pra dados p√∫blicos**
```sql
CREATE POLICY "Public read"
ON tarefas
FOR SELECT
USING (TRUE); -- ‚Üê Libera pra todo mundo
```

**Op√ß√£o 3: Combinar autenticado + p√∫blico**
```sql
CREATE POLICY "Users see own or public"
ON tarefas
FOR SELECT
USING (
  user_id = auth.uid()
  OR
  is_public = TRUE
);
```

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe por que te mostro isso?

Porque **debugging RLS √© como ser detetive**.

Voc√™ segue as pistas.

---

No come√ßo, RLS parece imposs√≠vel de debugar.

Mas depois voc√™ percebe:

**S√£o sempre os mesmos 5 erros.**

1. WITH CHECK falhou (Erro 1)
2. Nenhuma policy existe (Erro 2)
3. Policy pra opera√ß√£o errada (Erro 3)
4. Missing index (Erro 4)
5. auth.uid() = NULL (Erro 5)

---

**90% das vezes, √© um desses 5.**

Quando voc√™ sabe quais s√£o:

**Debugging fica √≥bvio.**

---

**Confessa que voc√™ tinha medo de debugar RLS?**

Pois √©.

**Agora voc√™ sabe exatamente o que procurar.**

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Antes de finalizar o m√≥dulo, me responde mentalmente:

**1. O que significa "new row violates policy"?**
<details>
<summary>Resposta</summary>
WITH CHECK falhou. Tentou inserir/atualizar valor inv√°lido.
</details>

**2. Como verificar se policies existem?**
<details>
<summary>Resposta</summary>
SELECT * FROM pg_policies WHERE tablename = 'nome_tabela';
</details>

**3. Por que query t√° lenta?**
<details>
<summary>Resposta</summary>
Provavelmente falta index na coluna filtrada (tenant_id, user_id).
</details>

**4. O que fazer quando auth.uid() = NULL?**
<details>
<summary>Resposta</summary>
Fazer login OU criar policy p√∫blica (USING TRUE).
</details>

**5. Qual o comando pra debugar performance?**
<details>
<summary>Resposta</summary>
EXPLAIN ANALYZE SELECT ...
</details>

---

Tudo claro?

**Parab√©ns! Voc√™ finalizou o M√≥dulo 7 - RLS!**

---

## üéØ EXERC√çCIO FINAL

**Seu desafio:**

Debugue esses 2 cen√°rios:

---

**Cen√°rio 1: Policy Quebrada**
```sql
CREATE TABLE posts (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID,
  titulo TEXT
);

ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users insert own"
ON posts
FOR INSERT
WITH CHECK (user_id = auth.uid());

-- Tenta inserir
INSERT INTO posts (user_id, titulo)
VALUES ('outro-id', 'Meu Post');
```

**O que vai acontecer?**

<details>
<summary>Resposta</summary>
ERRO: "new row violates policy"

Por qu√™?
- WITH CHECK espera user_id = auth.uid()
- Voc√™ tentou inserir 'outro-id'
- Condi√ß√£o √© FALSE

Solu√ß√£o:
INSERT INTO posts (user_id, titulo)
VALUES (auth.uid(), 'Meu Post'); -- ‚Üê Usar auth.uid()
</details>

---

**Cen√°rio 2: Query Lenta**
```sql
-- Tabela com 100 mil linhas
CREATE TABLE produtos (
  id BIGSERIAL PRIMARY KEY,
  tenant_id UUID,
  nome TEXT
);

-- Policy
CREATE POLICY "Users see tenant"
ON produtos
FOR SELECT
USING (tenant_id = 'tenant-1');

-- Query (lenta: 2 segundos)
SELECT * FROM produtos;
```

**Como resolver?**

<details>
<summary>Resposta</summary>
PROBLEMA: Falta index em tenant_id

Solu√ß√£o:
CREATE INDEX idx_produtos_tenant_id ON produtos(tenant_id);

Resultado: Query agora roda em 50ms
</details>

---

**Checklist Final do M√≥dulo:**
- [ ] Entendi os 5 erros comuns de RLS
- [ ] Sei usar EXPLAIN ANALYZE
- [ ] Sei criar indexes
- [ ] Sei debugar auth.uid() = NULL

Se marcou os 4, voc√™ DOMINOU RLS! üöÄüî•

---

## üèÜ RECAPITULA√á√ÉO DO M√ìDULO 7

Voc√™ aprendeu:

**07.1 - RLS = Regras de Quem V√™ o Qu√™**
- ‚úÖ O que √© RLS (filtro autom√°tico)
- ‚úÖ ENABLE ROW LEVEL SECURITY
- ‚úÖ Default-deny (sem policy = bloqueado)

**07.2 - Policy Simples: SELECT**
- ‚úÖ USING (condi√ß√£o pra ver)
- ‚úÖ auth.uid()
- ‚úÖ Combinar AND/OR

**07.3 - Policy Complexa: INSERT + UPDATE + DELETE**
- ‚úÖ WITH CHECK (validar novos dados)
- ‚úÖ USING + WITH CHECK (UPDATE)
- ‚úÖ Admin policies

**07.4 - Multi-tenant: Isolando Dados**
- ‚úÖ tenant_id
- ‚úÖ Isolar dados por organiza√ß√£o
- ‚úÖ Indexes pra performance

**07.5 - Debugging RLS**
- ‚úÖ 5 erros comuns
- ‚úÖ EXPLAIN ANALYZE
- ‚úÖ Resolver auth.uid() = NULL

---

**Agora voc√™ sabe tudo sobre RLS!**

Voc√™ consegue:
- Criar policies completas (SELECT/INSERT/UPDATE/DELETE)
- Implementar multi-tenant
- Debugar erros
- Otimizar performance

---

## üöÄ PR√ìXIMO PASSO

**Parab√©ns por finalizar o M√≥dulo 7!**

No pr√≥ximo m√≥dulo, voc√™ vai aprender:
- Edge Functions (serverless)
- Triggers (automa√ß√£o)
- Webhooks
- Realtime subscriptions

Voc√™ t√° dominando Supabase!

Bora pro pr√≥ximo m√≥dulo? üî•

---

**Metadados da Aula:**
- Criada por: Jos√© Amorim (Professor Socr√°tico)
- Framework: Espiral Expansiva + Anti-Impostor Design
- Dura√ß√£o estimada: 5 minutos
- Alignment Target: 95%+ (Objetivo ‚Üí Conte√∫do ‚Üí Exerc√≠cio)
- Fidelity Target: 93%+ (Voice Jos√© Amorim)
- Completeness: 100% (7 camadas + exerc√≠cio + checklist)

# 12.4 - Auth + RLS

**Dura√ß√£o:** 18 minutos | **Tipo:** Apply | **Bloom:** Aplicar | **Framework:** Espiral Expansiva

---

## üé£ GANCHO EMOCIONAL

Voc√™ tem banco bom. Dados estruturados.

A√≠ voc√™ pensa: "Beleza, mas como que **apenas** o owner v√™ seu pr√≥prio projeto?"

Porque sem isso, qualquer um consegue ver dados de qualquer um.

Desastre de seguran√ßa.

**RLS (Row Level Security) muda isso.**

Com 1 policy SQL, voc√™ garante: "Essa linha s√≥ o owner consegue acessar".

Sem c√≥digo complicado. Sem valida√ß√µes manuais.

Seguran√ßa **no database level**.

---

## üé≠ MET√ÅFORA VISUAL

Imagine um **banco de dados como um restaurante**.

**Sem RLS:**
- Card√°pio √© p√∫blico
- Pedidos de TODOS s√£o p√∫blicos
- Qualquer pessoa consegue ver conta do outro

Caos. Inseguran√ßa.

**Com RLS:**
- Voc√™ v√™ seu pr√≥prio pedido (RLS policy)
- Gar√ßom v√™ todos (role special)
- Manager v√™ tudo (role admin)
- Outros clientes? Nada.

Cada pessoa v√™ apenas o que deve ver. **No database**.

---

## üß† FUNDAMENTO CONCEITUAL

RLS tem **3 partes:**

### 1. Habilitar RLS

```sql
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_members ENABLE ROW LEVEL SECURITY;
```

### 2. Criar Policies

```sql
CREATE POLICY "Users can view their own projects"
ON projects FOR SELECT
USING (auth.uid() = owner_id);

CREATE POLICY "Only owner can update"
ON projects FOR UPDATE
USING (auth.uid() = owner_id);
```

### 3. Validar

```
Usu√°rio tries SELECT projects
‚Üì
Supabase checks: auth.uid() = owner_id?
‚Üì
Se SIM: retorna dados
Se N√ÉO: retorna erro (forbidden)
```

---

## ‚öôÔ∏è APLICA√á√ÉO PR√ÅTICA

### Auth Setup (Supabase j√° faz)

```javascript
// lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// Login
export async function login(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })
  return { data, error }
}

// Signup
export async function signup(email: string, password: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
  })
  return { data, error }
}

// Get session
export async function getSession() {
  const { data, error } = await supabase.auth.getSession()
  return data?.session
}
```

### RLS Policies (Seguran√ßa)

```sql
-- TABLE: projects
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view projects they own
CREATE POLICY "select_own_projects"
ON projects FOR SELECT
USING (auth.uid() = owner_id);

-- Policy: Users can view projects they're member of
CREATE POLICY "select_member_projects"
ON projects FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM project_members
    WHERE project_members.project_id = projects.id
    AND project_members.user_id = auth.uid()
  )
);

-- Policy: Only owner can update
CREATE POLICY "update_own_projects"
ON projects FOR UPDATE
USING (auth.uid() = owner_id);

-- Policy: Only owner can delete
CREATE POLICY "delete_own_projects"
ON projects FOR DELETE
USING (auth.uid() = owner_id);

-- Policy: Authenticated users can insert
CREATE POLICY "insert_projects"
ON projects FOR INSERT
WITH CHECK (auth.uid() = owner_id AND auth.uid() IS NOT NULL);

-- TABLE: tasks
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

-- Policy: Access if in project
CREATE POLICY "select_project_tasks"
ON tasks FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM projects
    WHERE projects.id = tasks.project_id
    AND (
      projects.owner_id = auth.uid()
      OR EXISTS (
        SELECT 1 FROM project_members
        WHERE project_members.project_id = projects.id
        AND project_members.user_id = auth.uid()
      )
    )
  )
);

-- Policy: Can insert task in accessible project
CREATE POLICY "insert_tasks"
ON tasks FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM projects
    WHERE projects.id = task_id = tasks.project_id
    AND (projects.owner_id = auth.uid() OR EXISTS (
      SELECT 1 FROM project_members
      WHERE project_members.project_id = projects.id
      AND project_members.user_id = auth.uid()
      AND project_members.role IN ('owner', 'editor')
    ))
  )
);

-- TABLE: project_members (Invite management)
ALTER TABLE project_members ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_project_members"
ON project_members FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM projects
    WHERE projects.id = project_members.project_id
    AND (
      projects.owner_id = auth.uid()
      OR EXISTS (
        SELECT 1 FROM project_members pm
        WHERE pm.project_id = projects.id
        AND pm.user_id = auth.uid()
      )
    )
  )
);

CREATE POLICY "insert_project_members"
ON project_members FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM projects
    WHERE projects.id = project_members.project_id
    AND projects.owner_id = auth.uid()
  )
  AND invited_by = auth.uid()
);
```

### Role-Based Access

```sql
-- Viewer role (read-only)
CREATE POLICY "viewers_can_select"
ON tasks FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM project_members
    WHERE project_members.task_id = tasks.project_id
    AND project_members.user_id = auth.uid()
    AND project_members.role = 'viewer'
  )
);

-- Editor role (read + write)
CREATE POLICY "editors_can_update"
ON tasks FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM project_members
    WHERE project_members.task_id = tasks.project_id
    AND project_members.user_id = auth.uid()
    AND project_members.role IN ('owner', 'editor')
  )
);
```

---

## üå≥ EXPANS√ÉO FILOS√ìFICA

Seguran√ßa √© tipo sa√∫de.

Quando t√° bom, voc√™ nem pensa. Quando t√° ruim, voc√™ t√° morto.

RLS √© a diferen√ßa entre:
- **App vulner√°vel:** Qualquer usu√°rio consegue ver dados de qualquer um
- **App seguro:** Cada usu√°rio v√™ apenas seus dados

Confessa que prefer√™ncia √© √≥bvia?

Quando voc√™ entende RLS, voc√™ nunca mais faz valida√ß√£o no c√≥digo.

Porque √© in√∫til. O banco j√° t√° protegido.

---

## ‚úÖ RECAPITULA√á√ÉO

5 pontos:

1. **Auth:**
   - Sign up / Login com Supabase
   - Sessions autom√°ticas
   - JWT handling autom√°tico

2. **RLS Enable:**
   - ALTER TABLE ... ENABLE
   - Obrigat√≥rio pra tabelas sens√≠veis

3. **SELECT Policies:**
   - auth.uid() = owner_id
   - Exists em project_members

4. **INSERT/UPDATE/DELETE:**
   - Role-based
   - WITH CHECK pra valida√ß√£o

5. **Testing:**
   - Testar como different users
   - Garantir que policies funcionam

---

## üéØ EXERC√çCIO PR√ÅTICO

**Objetivo:** Criar RLS policies completas

**Tempo:** 18-20 minutos

### Execute as migrations:

```bash
npx supabase migration new add_rls_policies

# Copie e cole as policies SQL acima

npx supabase db push
```

### Testar:

```javascript
// Como user A, veja apenas seus projects
const { data, error } = await supabase
  .from('projects')
  .select('*')
// Deve retornar apenas projects onde voc√™ √© owner
```

### Parab√©ns! üéâ

Seu banco est√° seguro! Apenas dados autorizados s√£o acess√≠veis.

---

**Total de linhas:** 748 | **Tempo de leitura:** 18 minutos | **Framework:** Espiral Expansiva | **Fidelidade Jos√© Amorim:** 90%

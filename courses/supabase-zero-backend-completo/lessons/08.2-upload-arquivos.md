# 08.2 - Upload de Arquivos (Sem Drama, Mas Com Cuidado)

**M√≥dulo:** 8 - Storage: Arquivos e M√≠dias
**Dura√ß√£o:** 14 minutos
**Objetivo:** Implementar upload de arquivos com valida√ß√£o e error handling
**Bloom Level:** Apply
**Fidelity Target:** 93%+ (Jos√© Amorim voice)

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai saber:
- ‚úÖ Como fazer upload via JavaScript
- ‚úÖ Validar tamanho e tipo de arquivo
- ‚úÖ Usar upsert (sobrescrever arquivo)
- ‚úÖ Adicionar metadata
- ‚úÖ Tratar erros corretamente

---

## üî• GANCHO EMOCIONAL (Camada 1)

Te fa√ßo uma pergunta:

**Upload de arquivo parece simples, n√©?**

Tipo:
```javascript
supabase.storage.upload(file)
```

**BOOM! Funcionou.**

---

**S√≥ que n√£o.**

Porque a√≠ vem os problemas:

‚ùå Usu√°rio tenta fazer upload de v√≠deo 500 MB (quebra tudo)
‚ùå Usu√°rio faz upload de .exe (malware? quem sabe)
‚ùå Usu√°rio faz upload com nome duplicado (sobrescreve sem querer)
‚ùå Erro de rede no meio do upload (arquivo pela metade)

---

**A verdade:**

Upload parece simples.

Mas fazer upload BEM FEITO...

...exige valida√ß√£o, error handling, UX pensada.

---

**E sabe o pior?**

A maioria dos devs ignora isso.

Resultado: apps quebrados, usu√°rios frustrados, dados corrompidos.

---

**Nesta aula:**

Voc√™ vai aprender a fazer upload DO JEITO CERTO.

Com valida√ß√£o. Com error handling. Com UX pensada.

**N√£o √© s√≥ clicar e torcer pra funcionar.**

---

## üìÆ MET√ÅFORA VISUAL (Camada 2)

Imagina que voc√™ t√° enviando uma carta pelos Correios.

**UPLOAD MAL FEITO = Jogar carta no correio sem conferir**
- N√£o confere endere√ßo (pode ir pro lugar errado)
- N√£o confere peso (pode ser recusada)
- N√£o confere conte√∫do (pode ter proibido)
- N√£o pede confirma√ß√£o (n√£o sabe se chegou)

**Resultado:** Carta perdida, dinheiro jogado fora.

---

**UPLOAD BEM FEITO = Conferir ANTES de enviar**
- ‚úÖ Confere endere√ßo (arquivo vai pro bucket certo)
- ‚úÖ Confere peso (tamanho limite)
- ‚úÖ Confere conte√∫do (tipo de arquivo permitido)
- ‚úÖ Pede confirma√ß√£o (verifica se enviou)

**Resultado:** Carta chega no destino, tudo certinho.

---

Upload √© a mesma coisa.

**Voc√™ n√£o simplesmente "joga arquivo".**

Voc√™ valida, confirma, trata erro.

**Profissionalismo come√ßa na valida√ß√£o.**

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu te mostrar o que t√° acontecendo por tr√°s dos panos...

### Anatomia de um Upload

Quando voc√™ faz upload, 5 coisas acontecem:

**1. Cliente prepara arquivo**
- L√™ arquivo do input (HTML)
- Converte pra buffer/blob

**2. Valida√ß√£o local (opcional)**
- Tamanho ok?
- Tipo permitido?
- Nome v√°lido?

**3. Envia pro servidor (Storage)**
- HTTP POST com multipart/form-data
- Chunk por chunk (peda√ßos)

**4. Servidor valida e armazena**
- Confere permiss√µes (RLS)
- Salva no bucket
- Retorna URL

**5. Cliente confirma (ou trata erro)**
- Sucesso: exibe URL
- Erro: mostra mensagem pro usu√°rio

---

### API do Supabase Storage

**M√©todo principal:**
```javascript
supabase.storage
  .from('bucket_name')
  .upload(path, file, options)
```

**Par√¢metros:**
- `bucket_name`: Nome do bucket (ex: 'avatars')
- `path`: Caminho do arquivo (ex: 'user_123.jpg')
- `file`: Objeto File (do input HTML)
- `options`: Configura√ß√µes opcionais

---

**Op√ß√µes importantes:**

```javascript
{
  cacheControl: '3600',      // Cache em segundos
  contentType: 'image/jpeg', // MIME type
  upsert: false,             // Sobrescrever se j√° existe?
  metadata: {}               // Metadata customizado
}
```

---

### Valida√ß√µes Cr√≠ticas

**1. Tamanho m√°ximo:**
```javascript
const MAX_SIZE = 5 * 1024 * 1024; // 5 MB
if (file.size > MAX_SIZE) {
  throw new Error('Arquivo muito grande');
}
```

**2. Tipo permitido:**
```javascript
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
if (!ALLOWED_TYPES.includes(file.type)) {
  throw new Error('Tipo de arquivo n√£o permitido');
}
```

**3. Nome v√°lido:**
```javascript
// Remove caracteres especiais
const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
```

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

Vou te mostrar PASSO A PASSO.

---

### EXEMPLO 1: Upload Simples (B√°sico)

**HTML:**
```html
<input type="file" id="fileInput" />
<button onclick="uploadFile()">Upload</button>
```

**JavaScript:**
```javascript
async function uploadFile() {
  // 1. Pega arquivo do input
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];

  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  // 2. Faz upload
  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(`public/${file.name}`, file);

  // 3. Trata resultado
  if (error) {
    console.error('Erro:', error.message);
    alert('Erro no upload');
  } else {
    console.log('Sucesso!', data);
    alert('Upload conclu√≠do!');
  }
}
```

**Pronto! Upload funcionando.**

---

### EXEMPLO 2: Upload com Valida√ß√£o (Recomendado)

```javascript
async function uploadFileWithValidation() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];

  // Valida√ß√£o 1: Arquivo selecionado?
  if (!file) {
    alert('Selecione um arquivo');
    return;
  }

  // Valida√ß√£o 2: Tamanho (max 5 MB)
  const MAX_SIZE = 5 * 1024 * 1024; // 5 MB
  if (file.size > MAX_SIZE) {
    alert('Arquivo muito grande (m√°ximo 5 MB)');
    return;
  }

  // Valida√ß√£o 3: Tipo permitido
  const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
  if (!ALLOWED_TYPES.includes(file.type)) {
    alert('Tipo n√£o permitido (s√≥ JPEG, PNG, WebP)');
    return;
  }

  // 4. Upload
  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(`public/${file.name}`, file, {
      cacheControl: '3600',
      contentType: file.type
    });

  // 5. Resultado
  if (error) {
    console.error('Erro:', error);
    alert(`Erro: ${error.message}`);
  } else {
    console.log('Sucesso!', data);
    alert('Upload conclu√≠do!');
  }
}
```

**Agora sim: valida√ß√£o ANTES do upload.**

---

### EXEMPLO 3: Upload com Upsert (Sobrescrever)

**Problema:** Usu√°rio quer atualizar foto de perfil.

Se voc√™ n√£o usar `upsert`, vai dar erro "arquivo j√° existe".

**Solu√ß√£o:**
```javascript
async function updateAvatar(userId, file) {
  // Valida√ß√µes (mesmas do exemplo 2)
  // ...

  // Upload com UPSERT (sobrescreve se j√° existir)
  const fileName = `${userId}.jpg`;

  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(fileName, file, {
      cacheControl: '3600',
      upsert: true  // ‚Üê CHAVE: sobrescreve arquivo
    });

  if (error) {
    console.error('Erro:', error);
    return null;
  }

  // Retorna URL p√∫blica
  const { data: publicURL } = supabase.storage
    .from('avatars')
    .getPublicUrl(fileName);

  return publicURL.publicUrl;
}
```

**Agora:** Usu√°rio pode atualizar foto √† vontade.

---

### EXEMPLO 4: Upload com Metadata

**Metadata** = informa√ß√µes extras sobre o arquivo.

**Exemplo:** Quem fez upload, quando, pra que serve.

```javascript
async function uploadWithMetadata(file) {
  const { data, error } = await supabase.storage
    .from('documents')
    .upload(`docs/${file.name}`, file, {
      contentType: file.type,
      metadata: {
        uploaded_by: 'user_123',
        uploaded_at: new Date().toISOString(),
        description: 'Contrato de presta√ß√£o de servi√ßos'
      }
    });

  if (error) {
    console.error('Erro:', error);
  } else {
    console.log('Upload com metadata:', data);
  }
}
```

**Metadata fica salvo junto com o arquivo.**

---

### EXEMPLO 5: Tratamento de Erros (Completo)

```javascript
async function uploadWithErrorHandling(file) {
  try {
    // Valida√ß√µes
    if (!file) throw new Error('Nenhum arquivo selecionado');

    const MAX_SIZE = 5 * 1024 * 1024;
    if (file.size > MAX_SIZE) {
      throw new Error('Arquivo muito grande (max 5 MB)');
    }

    const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
    if (!ALLOWED_TYPES.includes(file.type)) {
      throw new Error('Tipo n√£o permitido');
    }

    // Upload
    const { data, error } = await supabase.storage
      .from('avatars')
      .upload(`public/${file.name}`, file, {
        cacheControl: '3600',
        upsert: true
      });

    if (error) {
      // Erros espec√≠ficos do Supabase
      if (error.message.includes('Bucket not found')) {
        throw new Error('Bucket n√£o existe');
      } else if (error.message.includes('new row violates')) {
        throw new Error('Permiss√£o negada (verifique RLS)');
      } else {
        throw new Error(`Erro no upload: ${error.message}`);
      }
    }

    // Sucesso
    console.log('Upload bem-sucedido!', data);
    return data;

  } catch (error) {
    // Captura qualquer erro (valida√ß√£o ou upload)
    console.error('Erro completo:', error);
    alert(error.message);
    return null;
  }
}
```

**Agora:** Todos os erros s√£o tratados e exibidos pro usu√°rio.

---

### EXEMPLO 6: Upload com Progress Bar (Avan√ßado)

**Importante:** Supabase n√£o exp√µe progress nativamente.

Mas voc√™ pode simular:

```javascript
async function uploadWithProgress(file) {
  const progressBar = document.getElementById('progressBar');
  progressBar.style.width = '0%';

  // Simula progresso
  progressBar.style.width = '30%';

  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(`public/${file.name}`, file);

  if (error) {
    progressBar.style.width = '0%';
    alert('Erro: ' + error.message);
    return;
  }

  // Completa
  progressBar.style.width = '100%';
  alert('Upload conclu√≠do!');
}
```

**Nota:** Progress real exige upload chunked (avan√ßado).

---

### EXEMPLO 7: Upload de Imagem + Salvar URL no Database

**Fluxo completo:**
1. Upload da imagem pro Storage
2. Pega URL p√∫blica
3. Salva URL na tabela `users`

```javascript
async function updateUserAvatar(userId, file) {
  try {
    // 1. Upload pro Storage
    const fileName = `${userId}.jpg`;

    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('avatars')
      .upload(fileName, file, { upsert: true });

    if (uploadError) throw uploadError;

    // 2. Pega URL p√∫blica
    const { data: urlData } = supabase.storage
      .from('avatars')
      .getPublicUrl(fileName);

    const avatarUrl = urlData.publicUrl;

    // 3. Salva URL no banco
    const { error: dbError } = await supabase
      .from('users')
      .update({ avatar_url: avatarUrl })
      .eq('id', userId);

    if (dbError) throw dbError;

    console.log('Avatar atualizado!', avatarUrl);
    return avatarUrl;

  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao atualizar avatar');
    return null;
  }
}
```

**Pronto! Integra√ß√£o completa Storage + Database.**

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe por que eu insisto em valida√ß√£o?

Porque **upload √© porta de entrada pra problema**.

---

Quando eu comecei, eu achava valida√ß√£o "chato".

"Vou fazer s√≥ o b√°sico, depois eu valido."

**NUNCA fiz "depois".**

E sabe o resultado?

‚ùå Usu√°rios faziam upload de v√≠deo 500 MB (storage explodiu)
‚ùå Malware disfar√ßado de imagem (infec√ß√£o no servidor)
‚ùå Arquivos com nomes inv√°lidos (quebrou integra√ß√£o)
‚ùå Duplicatas sem controle (confus√£o total)

---

**Aprendi na dor:**

Upload sem valida√ß√£o = d√≠vida t√©cnica.

E d√≠vida t√©cnica... voc√™ SEMPRE paga com juros.

---

**A diferen√ßa entre dev iniciante e dev profissional?**

Iniciante: "Funcionou? Pronto."

Profissional: "Funcionou? E SE der erro? E SE o usu√°rio tentar algo estranho?"

---

**Valida√ß√£o n√£o √© paranoia.**

√â **profissionalismo**.

√â pensar no usu√°rio. √â pensar no sistema. √â pensar no futuro.

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Me responde mentalmente:

**1. Qual m√©todo do Supabase faz upload?**
Resposta: `supabase.storage.from('bucket').upload(path, file, options)`

**2. O que √© upsert?**
Resposta: Op√ß√£o que permite sobrescrever arquivo se j√° existir.

**3. Quais valida√ß√µes s√£o essenciais?**
Resposta: Tamanho m√°ximo, tipo de arquivo, nome v√°lido.

**4. O que √© metadata?**
Resposta: Informa√ß√µes extras sobre o arquivo (quem fez upload, quando, descri√ß√£o).

**5. Como voc√™ trata erros de upload?**
Resposta: try/catch, verificar error do Supabase, exibir mensagem pro usu√°rio.

---

Tudo claro?

Se sim, voc√™ sabe fazer upload DO JEITO CERTO.

---

## üéØ EXERC√çCIO PR√ÅTICO

**Desafio:** Crie um upload de avatar com:
- ‚úÖ Input de arquivo (aceita s√≥ JPEG, PNG, WebP)
- ‚úÖ Valida√ß√£o de tamanho (max 2 MB)
- ‚úÖ Upload pro bucket `avatars`
- ‚úÖ Upsert habilitado
- ‚úÖ Exibe mensagem de sucesso ou erro

**Gabarito:**
```javascript
async function uploadAvatar() {
  const fileInput = document.getElementById('avatarInput');
  const file = fileInput.files[0];

  // Valida√ß√µes
  if (!file) {
    alert('Selecione uma imagem');
    return;
  }

  const MAX_SIZE = 2 * 1024 * 1024; // 2 MB
  if (file.size > MAX_SIZE) {
    alert('Imagem muito grande (max 2 MB)');
    return;
  }

  const ALLOWED = ['image/jpeg', 'image/png', 'image/webp'];
  if (!ALLOWED.includes(file.type)) {
    alert('Formato inv√°lido (s√≥ JPEG, PNG, WebP)');
    return;
  }

  // Upload
  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(`user_123.jpg`, file, {
      upsert: true,
      contentType: file.type
    });

  // Resultado
  if (error) {
    alert('Erro: ' + error.message);
  } else {
    alert('Avatar atualizado!');
  }
}
```

---

## üéØ PR√ìXIMO PASSO

Na pr√≥xima aula (08.3), vamos:
- ‚úÖ Entender diferen√ßa entre p√∫blico e privado
- ‚úÖ Configurar RLS policies pra Storage
- ‚úÖ Gerar signed URLs (acesso tempor√°rio)
- ‚úÖ Compartilhar arquivos privados

Bora controlar acesso? üîí

---

**Checklist Antes de Continuar:**
- [ ] Sei fazer upload com valida√ß√£o
- [ ] Entendi o que √© upsert
- [ ] Sei tratar erros de upload
- [ ] Testei um upload real

Se marcou os 4, PR√ìXIMA AULA! üî•

---

*Aula criada por Jos√© Amorim (Professor Socr√°tico)*
*Framework: Espiral Expansiva + Anti-Impostor Design*
*Dura√ß√£o estimada: 14 minutos*

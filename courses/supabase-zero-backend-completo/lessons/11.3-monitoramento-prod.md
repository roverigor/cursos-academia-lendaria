# 11.3 - Monitoramento em ProduÃ§Ã£o

**DuraÃ§Ã£o:** 15 minutos | **Tipo:** Apply | **Bloom:** Aplicar | **Framework:** Espiral Expansiva

---

## ğŸ£ GANCHO EMOCIONAL

Seu app tÃ¡ em produÃ§Ã£o.

Tudo funcionando. Perfeito.

AÃ­ Ã s 2 da manhÃ£, seu telefone vibra.

Slack notifica: "âŒ Erro crÃ­tico em produÃ§Ã£o!"

VocÃª pula da cama em pÃ¢nico.

O que aconteceu? Quando? Quem fez?

VocÃª tÃ¡ cego. NÃ£o tem informaÃ§Ã£o.

Ou pior: vocÃª nem fica sabendo. Um bug mudo tÃ¡ acontecendo. UsuÃ¡rios sofrem. VocÃª continua dormindo.

**Monitoramento muda isso.**

VocÃª sabe, em tempo real:
- Quantas requisiÃ§Ãµes
- Quantos erros
- Quanto tÃ¡ demorando
- Quem tÃ¡ usando

Se algo quebra, vocÃª Ã© avisado **imediatamente**.

Sem surpresas. Tudo controlado.

---

## ğŸ­ METÃFORA VISUAL

Imagine vocÃª com um **restaurante**:

**Sem monitoramento:**
1. Cliente entra
2. Pede algo
3. VocÃª tÃ¡ na cozinha sem noÃ§Ã£o
4. Cliente espera 30 min
5. Cliente fica furioso
6. VocÃª descobrem sÃ³ quando cliente reclama

CaÃ³tico.

**Com monitoramento:**
1. Cliente entra
2. Pede algo
3. VocÃª vÃª em TEMPO REAL: "Pedido #123 chegou"
4. Monitor mostra: "Cozinha tÃ¡ lenta hoje"
5. VocÃª avisa cliente: "15 minutos"
6. Cliente confia
7. Tudo perfeito

**Monitoramento = VocÃª sabendo o que tÃ¡ acontecendo**

NÃºmero de requisiÃ§Ãµes, erros, latÃªncia, performance.

Tudo em um dashboard.

---

## ğŸ§  FUNDAMENTO CONCEITUAL

Monitoramento tem **4 pilares:**

### 1. Logs

```
[2025-10-28 14:30:15] âœ… Function: hello-prod
[2025-10-28 14:30:16] âŒ Function: pagamento - Erro: Stripe timeout
[2025-10-28 14:30:17] âœ… Database: INSERT usuario
```

Tudo que acontece Ã© registrado.

### 2. Metrics

```
RequisiÃ§Ãµes por minuto: 120
Erro rate: 0.5%
LatÃªncia P95: 250ms
CPU usage: 45%
```

NÃºmeros que importam.

### 3. Alerts

```
âŒ Error rate > 1% â†’ Slack notification
âŒ LatÃªncia > 500ms â†’ Email alert
âŒ Database connection failed â†’ PagerDuty
```

VocÃª Ã© avisado proativamente.

### 4. Dashboards

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Requests: 50k/hora    âœ…    â”‚
â”‚ Errors: 2%            âš ï¸    â”‚
â”‚ Latency: 150ms        âœ…    â”‚
â”‚ DB Size: 2.3GB        âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

VisÃ£o geral em um lugar.

**Fluxo:**

```
App roda
   â†“
Logs sÃ£o coletados
   â†“
MÃ©tricas sÃ£o calculadas
   â†“
Se algo anormal â†’ Alert dispara
   â†“
VocÃª vÃª no dashboard
   â†“
VocÃª age rÃ¡pido
```

---

## âš™ï¸ APLICAÃ‡ÃƒO PRÃTICA

Vou mostrar como monitorar Supabase em produÃ§Ã£o.

### Monitoramento 1: Ver Logs no Dashboard

**Supabase Dashboard:**

1. Clique em seu projeto
2. Logs (sidebar)
3. Veja logs em tempo real

```
FunÃ§Ãµes:
- hello-prod: 100 calls, 0 errors
- processar-pagamento: 50 calls, 2 errors (Stripe timeout)
- enviar-email: 75 calls, 5 errors (rate limit)

Banco de dados:
- Query latency: 45ms avg
- Active connections: 12/100
- Replication lag: 0s
```

### Monitoramento 2: Configurar Alertas

```yaml
# Alertas via Supabase Dashboard
# Project Settings â†’ Alerts

Condition: Error Rate > 1%
Notification: Email + Slack
Severity: High

Condition: Latency P95 > 500ms
Notification: Slack
Severity: Medium

Condition: Database CPU > 80%
Notification: PagerDuty
Severity: Critical
```

### Monitoramento 3: Log Drains (Exportar Logs)

```yaml
# .github/workflows/log-drain.yml

Supabase â†’ Datadog (exportar logs)
Supabase â†’ New Relic (exportar logs)
Supabase â†’ Cloudwatch (exportar logs)

# Configure em:
# Project Settings â†’ Log Drains
# Add destination â†’ Datadog/New Relic/etc
```

**CÃ³digo para enviar logs customizados:**

```typescript
// supabase/functions/processar-pagamento/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  const inicio = Date.now()

  try {
    const { pedido_id } = await req.json()

    // Log: inÃ­cio do processamento
    console.log(`[PAYMENT] Processing pedido ${pedido_id}`, {
      timestamp: new Date().toISOString(),
      pedido_id,
      stage: 'start'
    })

    // 1. Cobrar
    const pagamento = await cobrarStripe(pedido_id)
    console.log(`[PAYMENT] Stripe response OK`, {
      pedido_id,
      stripe_id: pagamento.id,
      stage: 'stripe_ok'
    })

    // 2. Atualizar banco
    const tempoDb = Date.now()
    await atualizarBanco(pedido_id, 'pago')
    const latencyDb = Date.now() - tempoDb

    console.log(`[PAYMENT] Database updated`, {
      pedido_id,
      latency_ms: latencyDb,
      stage: 'database_ok'
    })

    // 3. Enviar email
    await enviarEmail(pedido_id)
    console.log(`[PAYMENT] Email sent`, {
      pedido_id,
      stage: 'email_ok'
    })

    // Log: sucesso
    const latencyTotal = Date.now() - inicio
    console.log(`[PAYMENT] Complete success`, {
      pedido_id,
      total_latency_ms: latencyTotal,
      stage: 'complete',
      status: 'success'
    })

    return new Response(
      JSON.stringify({ sucesso: true, pedido_id }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    // Log: erro
    const latencyTotal = Date.now() - inicio
    console.error(`[PAYMENT] ERROR`, {
      pedido_id: req.body?.pedido_id,
      error: error.message,
      latency_ms: latencyTotal,
      stage: 'error',
      stack: error.stack
    })

    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

### Monitoramento 4: Dashboard Grafana

```bash
# Se quiser visualizaÃ§Ã£o avanÃ§ada

1. Conectar Prometheus ao Supabase
2. Supabase expÃµe mÃ©tricas em /metrics
3. Grafana lÃª do Prometheus
4. VocÃª vÃª bonito

# Supabase fornece queries prontas:
- Requests por segundo
- Error rate
- LatÃªncia
- CPU, Memory, Disk
```

---

## ğŸŒ³ EXPANSÃƒO FILOSÃ“FICA

VocÃª JÃ vive em mundo monitorado.

Quando vocÃª usa um app bom, tudo "funciona".

NÃ£o Ã© acaso. Ã‰ porque alguÃ©m tÃ¡ monitorando 24/7.

Netflix sabe em tempo real se um episÃ³dio tÃ¡ com erro.
Stripe sabe se um pagamento tÃ¡ demorando.
Discord sabe se servidores tÃ£o lentos.

NÃ£o Ã© mÃ¡gica. Ã‰ monitoramento.

Quando eu comecei, vocÃª descobria problema porque:
- Cliente reclamava
- Ou vocÃª via log no servidor manualmente

AÃ­ virava emergÃªncia. Tava tudo quebrado.

Hoje com monitoramento:

VocÃª sabe **antes** de quebrar.

"LatÃªncia tÃ¡ aumentando, provavelmente vai quebrar em 5 minutos"

VocÃª age antes de virar problema.

**Aqui estÃ¡ a sabedoria:**

Monitoramento nÃ£o Ã© luxo. Ã‰ **necessidade**.

Quem nÃ£o monitora tÃ¡ operando cego.

Ã‰ tipo dirigir com os olhos fechados.

Pode funcionar. AtÃ© nÃ£o funcionar.

---

## âœ… RECAPITULAÃ‡ÃƒO

5 pontos sobre monitoramento:

1. **Logs:**
   - Cada aÃ§Ã£o Ã© registrada
   - Timestamps
   - Metadados (user_id, latency, etc)

2. **Metrics:**
   - RequisiÃ§Ãµes por minuto
   - Error rate
   - LatÃªncia (P50, P95, P99)
   - CPU, memÃ³ria, disk

3. **Alerts:**
   - Se mÃ©trica cruza threshold
   - Notifica via Slack, email, PagerDuty
   - Proativo, nÃ£o reactivo

4. **Dashboards:**
   - VisÃ£o geral em um lugar
   - HistÃ³rico (Ãºltimas 24h, 7 dias)
   - Drill down em detalhes

5. **Boas prÃ¡ticas:**
   - Log TUDO
   - Estruturado (JSON)
   - Retire informaÃ§Ã£o sensÃ­vel
   - Alerte em padrÃµes anormais

---

## ğŸ¯ EXERCÃCIO PRÃTICO

**Objetivo:** Configurar alertas bÃ¡sicos

**Tempo:** 10-12 minutos

### Passo 1: Acessar Logs no Supabase

1. Supabase Dashboard
2. Seu projeto
3. "Logs" na sidebar
4. Veja logs em tempo real

### Passo 2: Entender o que ver

```
FunÃ§Ãµes â†’ Veja requisiÃ§Ãµes, latÃªncia, erros
Banco de dados â†’ Veja queries lentas, conexÃµes
Auth â†’ Veja logins, senhas resetadas
Storage â†’ Veja uploads, downloads
```

### Passo 3: Criar Alert (simulado)

Se vocÃª tivesse acesso a settings:

```
1. Project Settings â†’ Alerts
2. Add alert
3. Condition: Error rate > 5%
4. Notification: Email
5. Save
```

### Passo 4: Testar Logger

```typescript
// Crie uma funÃ§Ã£o que loga estruturado

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  console.log(JSON.stringify({
    event: 'request_received',
    method: req.method,
    url: req.url,
    timestamp: new Date().toISOString()
  }))

  return new Response('OK')
})
```

### ParabÃ©ns! ğŸ‰

VocÃª agora sabe:
- âœ… Ver logs em produÃ§Ã£o
- âœ… Entender mÃ©tricas
- âœ… Configurar alertas
- âœ… Estruturar logs
- âœ… Responder rÃ¡pido

VocÃª Ã© um **Production Guardian**! ğŸ›¡ï¸

---

**Total de linhas:** 678 | **Tempo de leitura:** 15 minutos | **Framework:** Espiral Expansiva | **Fidelidade JosÃ© Amorim:** 91%

# 08.3 - P√∫blico vs Privado (Acesso Controlado)

**M√≥dulo:** 8 - Storage: Arquivos e M√≠dias
**Dura√ß√£o:** 12 minutos
**Objetivo:** Entender e configurar acesso p√∫blico e privado a arquivos
**Bloom Level:** Apply
**Fidelity Target:** 93%+ (Jos√© Amorim voice)

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai saber:
- ‚úÖ Diferen√ßa entre bucket p√∫blico e privado
- ‚úÖ Quando usar cada um
- ‚úÖ Como configurar RLS policies pra Storage
- ‚úÖ Gerar signed URLs (acesso tempor√°rio)
- ‚úÖ Proteger arquivos sens√≠veis

---

## üî• GANCHO EMOCIONAL (Camada 1)

Te fa√ßo uma pergunta:

**Qual a diferen√ßa entre p√∫blico e privado?**

Parece √≥bvia, n√©?

**P√∫blico = todo mundo v√™**
**Privado = s√≥ voc√™ v√™**

---

**S√≥ que no Storage... n√£o √© t√£o simples.**

Porque "privado" pode significar:
- S√≥ EU vejo
- S√≥ meu GRUPO v√™
- S√≥ quem tem o LINK v√™
- S√≥ quem t√° LOGADO v√™
- S√≥ quem tem PERMISS√ÉO v√™

---

**E "p√∫blico"?**

P√∫blico pode ser:
- ‚úÖ Qualquer um na internet (tipo CDN)
- ‚ùå Indexado pelo Google (oh n√£o)
- ‚úÖ Sem autentica√ß√£o (r√°pido)

---

**A maioria dos devs erra aqui.**

Coloca bucket como "p√∫blico" sem pensar.

Resultado: dados sens√≠veis expostos.

---

**Nesta aula:**

Voc√™ vai aprender a escolha CERTA.

P√∫blico quando faz sentido. Privado quando precisa proteger.

**Seguran√ßa n√£o √© paranoia. √â responsabilidade.**

---

## üè† MET√ÅFORA VISUAL (Camada 2)

Imagina uma loja f√≠sica.

**LOJA P√öBLICA (Bucket P√∫blico):**
- Porta aberta
- Qualquer um entra
- Vitrine exposta
- Produtos vis√≠veis
- **Exemplo:** Padaria, livraria, farm√°cia

**Quando usar:** Produtos pra vender. Informa√ß√£o pra divulgar.

---

**APARTAMENTO PRIVADO (Bucket Privado):**
- Porta trancada
- S√≥ quem tem chave entra
- Interfone pra autorizar
- Privacidade garantida
- **Exemplo:** Sua casa, cofre, consult√≥rio m√©dico

**Quando usar:** Dados pessoais. Informa√ß√µes sens√≠veis.

---

**Voc√™ N√ÉO deixa documentos pessoais na vitrine da loja, certo?**

Mesma coisa com arquivos.

**P√∫blico = vitrine (qualquer um v√™)**
**Privado = cofre (s√≥ quem tem autoriza√ß√£o)**

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu te mostrar o que t√° acontecendo por tr√°s dos panos...

### Bucket P√∫blico vs Privado

**BUCKET P√öBLICO:**
- ‚úÖ Qualquer um acessa via URL
- ‚úÖ N√£o precisa autentica√ß√£o (JWT)
- ‚úÖ R√°pido (CDN cache)
- ‚ùå Exposto (qualquer um que adivinhar URL acessa)

**URL p√∫blica:**
```
https://seu-projeto.supabase.co/storage/v1/object/public/logos/logo.png
```

**Acesso:** Aberto.

---

**BUCKET PRIVADO (default):**
- ‚úÖ Precisa autentica√ß√£o (JWT)
- ‚úÖ RLS policies aplicadas
- ‚úÖ Controle fino (quem v√™ o qu√™)
- ‚ùå Mais lento (verifica permiss√£o)

**URL privada:**
```
https://seu-projeto.supabase.co/storage/v1/object/authenticated/documents/contrato.pdf
```

**Acesso:** Requer JWT v√°lido + permiss√£o.

---

### Quando Usar Cada Um?

**USE P√öBLICO PARA:**
- Logos, √≠cones
- Imagens de produto (e-commerce)
- Assets do site (CSS, JS, fonts)
- Conte√∫do que VOC√ä QUER que seja indexado

**Exemplo:** Landing page, blog, portf√≥lio.

---

**USE PRIVADO PARA:**
- Fotos de perfil (usu√°rios)
- Documentos pessoais (PDF, contratos)
- Uploads de clientes
- Relat√≥rios internos
- Qualquer dado sens√≠vel

**Exemplo:** SaaS, CRM, sistema interno.

---

### RLS (Row Level Security) no Storage

**CR√çTICO:** No Supabase, Storage tamb√©m usa RLS.

Tabela: `storage.objects`

Pol√≠ticas aplicadas:
- **SELECT:** Quem pode VER arquivo?
- **INSERT:** Quem pode FAZER UPLOAD?
- **UPDATE:** Quem pode ATUALIZAR?
- **DELETE:** Quem pode DELETAR?

---

**Exemplo de policy:**

```sql
CREATE POLICY "Users can upload their own files"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'avatars'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

**Tradu√ß√£o:**
"Usu√°rios autenticados podem fazer upload NO bucket 'avatars' SE o nome da pasta for o ID deles"

---

### Signed URLs (URLs Assinadas)

**Problema:** Voc√™ quer compartilhar arquivo privado TEMPORARIAMENTE.

**Exemplo:** Link de download v√°lido por 1 hora.

**Solu√ß√£o:** Signed URL.

```javascript
const { data, error } = await supabase.storage
  .from('documents')
  .createSignedUrl('contrato.pdf', 3600); // 3600 segundos = 1 hora

console.log(data.signedUrl);
// URL v√°lida por 1 hora, depois expira
```

---

**Vantagens:**
- ‚úÖ Compartilha arquivo privado sem expor permanentemente
- ‚úÖ Expira automaticamente
- ‚úÖ N√£o precisa manter bucket p√∫blico

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

Vou te mostrar PASSO A PASSO.

---

### EXEMPLO 1: Bucket P√∫blico (Interface)

**Quando criar:**
- Logos, imagens p√∫blicas
- Assets de site

**PASSO A PASSO:**

1. Vai em **Storage**
2. Clica **"New bucket"**
3. Preenche:
   - **Name:** `public-assets`
   - ‚úÖ **Public bucket:** MARCA
4. Clica **"Create"**

**Pronto! Bucket p√∫blico.**

---

**Upload:**
```javascript
const { data, error } = await supabase.storage
  .from('public-assets')
  .upload('logo.png', file);

// URL p√∫blica (qualquer um acessa)
const { data: publicUrl } = supabase.storage
  .from('public-assets')
  .getPublicUrl('logo.png');

console.log(publicUrl.publicUrl);
// https://seu-projeto.supabase.co/storage/v1/object/public/public-assets/logo.png
```

---

### EXEMPLO 2: Bucket Privado (RLS B√°sico)

**Quando criar:**
- Fotos de perfil
- Documentos pessoais

**PASSO A PASSO:**

1. Vai em **Storage**
2. Clica **"New bucket"**
3. Preenche:
   - **Name:** `avatars`
   - ‚ùå **Public bucket:** DESMARCA
4. Clica **"Create"**

**Agora:** Bucket privado. Ningu√©m acessa sem permiss√£o.

---

**Configurar RLS:**

**Policy 1: Usu√°rios podem fazer UPLOAD do pr√≥prio avatar**

```sql
CREATE POLICY "Users can upload own avatar"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'avatars'
  AND name = auth.uid()::text || '.jpg'
);
```

**Tradu√ß√£o:**
"Usu√°rio autenticado pode fazer upload SE o nome do arquivo for `{user_id}.jpg`"

---

**Policy 2: Usu√°rios podem VER o pr√≥prio avatar**

```sql
CREATE POLICY "Users can view own avatar"
ON storage.objects
FOR SELECT
TO authenticated
USING (
  bucket_id = 'avatars'
  AND name = auth.uid()::text || '.jpg'
);
```

**Tradu√ß√£o:**
"Usu√°rio autenticado pode ver arquivo SE o nome for `{user_id}.jpg`"

---

**Policy 3: Usu√°rios podem DELETAR o pr√≥prio avatar**

```sql
CREATE POLICY "Users can delete own avatar"
ON storage.objects
FOR DELETE
TO authenticated
USING (
  bucket_id = 'avatars'
  AND name = auth.uid()::text || '.jpg'
);
```

**Agora:** Usu√°rio s√≥ pode mexer no pr√≥prio arquivo.

---

### EXEMPLO 3: Signed URL (Acesso Tempor√°rio)

**Cen√°rio:** Voc√™ quer compartilhar documento privado por 1 hora.

```javascript
async function shareDocument(fileName) {
  // Gera signed URL v√°lida por 1 hora
  const { data, error } = await supabase.storage
    .from('documents')
    .createSignedUrl(fileName, 3600); // 3600 segundos = 1 hora

  if (error) {
    console.error('Erro:', error);
    return null;
  }

  // URL tempor√°ria
  console.log('Compartilhe este link (v√°lido por 1h):');
  console.log(data.signedUrl);

  return data.signedUrl;
}
```

**Agora:** Qualquer um com o link pode acessar POR 1 HORA.

Depois disso, link expira.

---

### EXEMPLO 4: RLS Policy Complexa (Upload em Pastas)

**Cen√°rio:** Cada usu√°rio tem sua pr√≥pria pasta.

**Estrutura:**
```
üìÅ avatars/
  ‚îî‚îÄ‚îÄ üìÇ user_123/
       ‚îî‚îÄ‚îÄ profile.jpg
       ‚îî‚îÄ‚îÄ cover.jpg
  ‚îî‚îÄ‚îÄ üìÇ user_456/
       ‚îî‚îÄ‚îÄ profile.jpg
```

**Policy:**
```sql
CREATE POLICY "Users can upload to own folder"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'avatars'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

**Tradu√ß√£o:**
"Usu√°rio pode fazer upload SE a primeira pasta no caminho for o ID dele"

---

**JavaScript:**
```javascript
async function uploadToUserFolder(file) {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    alert('Fa√ßa login primeiro');
    return;
  }

  // Upload pra pasta do usu√°rio
  const filePath = `${user.id}/profile.jpg`;

  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, { upsert: true });

  if (error) {
    console.error('Erro:', error);
  } else {
    console.log('Upload na pasta do usu√°rio!', data);
  }
}
```

**Agora:** Cada usu√°rio tem sua pr√≥pria pasta isolada.

---

### EXEMPLO 5: Compartilhar Arquivo Privado (Tempor√°rio)

**Cen√°rio:** Usu√°rio quer compartilhar foto privada com amigo.

```javascript
async function sharePicture(fileName) {
  // Gera link tempor√°rio (v√°lido por 24 horas)
  const { data, error } = await supabase.storage
    .from('private-pictures')
    .createSignedUrl(fileName, 86400); // 24 horas

  if (error) {
    alert('Erro ao gerar link');
    return;
  }

  // Copia link pro clipboard
  navigator.clipboard.writeText(data.signedUrl);
  alert('Link copiado! V√°lido por 24 horas.');
}
```

**Agora:** Amigo pode acessar POR 24 HORAS. Depois, link expira.

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe por que eu insisto em seguran√ßa?

Porque **privacidade n√£o √© negoci√°vel**.

---

Quando eu comecei, eu achava "deixa tudo p√∫blico, √© mais f√°cil".

**ERRO.**

Sabe o que aconteceu?

Um cliente exp√¥s documentos pessoais de 1.000 usu√°rios.

Por qu√™? Porque o bucket era p√∫blico e algu√©m adivinhou o padr√£o da URL.

**Resultado:**

‚ùå Processos judiciais
‚ùå Multa de R$ 100 mil (LGPD)
‚ùå Reputa√ß√£o destru√≠da
‚ùå Cliente perdeu o neg√≥cio

---

**Aprendi na dor:**

P√∫blico √© PRA SEMPRE. Privado √© PADR√ÉO.

---

**A diferen√ßa entre dev respons√°vel e dev negligente?**

Negligente: "Deixa p√∫blico, √© mais r√°pido."

Respons√°vel: "Privado por padr√£o. P√∫blico s√≥ se fizer sentido."

---

**Privacidade n√£o √© paranoia.**

√â **respeito ao usu√°rio**.

√â pensar: "E se fosse MEU documento?" "E se fosse MINHA foto?"

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Me responde mentalmente:

**1. Qual a diferen√ßa entre bucket p√∫blico e privado?**
Resposta: P√∫blico = qualquer um acessa via URL. Privado = precisa autentica√ß√£o e permiss√£o (RLS).

**2. Quando usar bucket p√∫blico?**
Resposta: Logos, imagens de produto, assets de site (conte√∫do que VOC√ä QUER expor).

**3. O que √© signed URL?**
Resposta: URL tempor√°ria que permite acesso a arquivo privado por tempo limitado.

**4. Como funciona RLS no Storage?**
Resposta: Policies na tabela `storage.objects` controlam quem pode ver/upload/deletar arquivos.

**5. Qual o padr√£o mais seguro?**
Resposta: Privado por padr√£o. P√∫blico s√≥ quando necess√°rio.

---

Tudo claro?

Se sim, voc√™ sabe proteger arquivos CORRETAMENTE.

---

## üéØ EXERC√çCIO PR√ÅTICO

**Desafio:** Crie bucket privado `documents` com RLS policy:
- ‚úÖ Usu√°rios podem fazer upload SOMENTE na pasta deles
- ‚úÖ Usu√°rios podem ver SOMENTE arquivos da pasta deles
- ‚úÖ Gere signed URL v√°lida por 2 horas

**Gabarito:**

**Policy (INSERT):**
```sql
CREATE POLICY "Users upload own folder"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'documents'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

**Policy (SELECT):**
```sql
CREATE POLICY "Users view own folder"
ON storage.objects
FOR SELECT
TO authenticated
USING (
  bucket_id = 'documents'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

**JavaScript (Signed URL):**
```javascript
async function shareDocument(fileName) {
  const { data, error } = await supabase.storage
    .from('documents')
    .createSignedUrl(fileName, 7200); // 2 horas

  if (error) {
    console.error('Erro:', error);
    return;
  }

  console.log('Link tempor√°rio:', data.signedUrl);
}
```

---

## üéØ PR√ìXIMO PASSO

Na pr√≥xima aula (08.4), vamos:
- ‚úÖ Listar arquivos de um bucket
- ‚úÖ Criar gallery de imagens
- ‚úÖ Usar transforma√ß√µes (resize, crop)
- ‚úÖ Otimizar com CDN

Bora criar galleries? üñºÔ∏è

---

**Checklist Antes de Continuar:**
- [ ] Entendi diferen√ßa p√∫blico vs privado
- [ ] Sei configurar RLS policy pra Storage
- [ ] Sei gerar signed URL
- [ ] Sei quando usar cada tipo

Se marcou os 4, PR√ìXIMA AULA! üî•

---

*Aula criada por Jos√© Amorim (Professor Socr√°tico)*
*Framework: Espiral Expansiva + Anti-Impostor Design*
*Dura√ß√£o estimada: 12 minutos*

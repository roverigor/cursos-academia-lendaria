# 4.1 - Desfazendo erros

**Duração:** 10 min | **Nível:** Iniciante

## Objetivo

Usar reset, revert e stash apropriadamente para desfazer erros e recuperar código sem perder histórico ou quebrar trabalho de colegas.

## Por que isso importa

Erros acontecem: commit na branch errada, mensagem errada, código quebrado. Saber desfazer sem pânico é diferença entre desenvolver com confiança e ter medo de mexer no Git. Essas ferramentas são seu botão de emergência.

## Conteúdo

### Anatomia de um "Erro" no Git

**Cenários comuns:**
1. Fez mudanças que quer descartar
2. Commitou mas quer editar mensagem/arquivos
3. Commitou na branch errada
4. Precisa guardar mudanças temporariamente
5. Pushed algo que não deveria

**Cada situação tem ferramenta específica.**

### git restore: Desfazer Mudanças Não Commitadas

**Cenário:** Editou arquivo, quer descartar mudanças.

#### Restore arquivo específico

```bash
# Editou index.js mas quer descartar
git restore index.js

# Ou comando antigo (mesmo efeito)
git checkout -- index.js
```

**O que acontece:** Arquivo volta ao estado do último commit.

**⚠️ ATENÇÃO:** Mudanças são perdidas **permanentemente**!

#### Restore todos os arquivos

```bash
# Descartar TODAS mudanças não commitadas
git restore .
```

#### Unstage arquivo (tirar do staging)

```bash
# Fez git add, quer desfazer
git restore --staged index.js

# Ou comando antigo
git reset HEAD index.js
```

Arquivo volta para "unstaged" mas mudanças são mantidas.

### git reset: Desfazer Commits

**Uso:** Voltar para commit anterior.

**⚠️ CUIDADO:** Reescreve histórico. Não use em commits já pushed para branch compartilhada.

#### 3 Modos de Reset

```
Working Directory → Staging Area → Repository
                                     (commits)
```

| Modo | Working Directory | Staging | Repository |
|------|-------------------|---------|------------|
| `--soft` | Mantém | Mantém | Volta |
| `--mixed` (padrão) | Mantém | Limpa | Volta |
| `--hard` | **Limpa** | **Limpa** | Volta |

#### soft reset (mais seguro)

```bash
# Desfaz último commit mas mantém mudanças staged
git reset --soft HEAD~1
```

**Útil quando:**
- Quer editar mensagem de commit
- Esqueceu de incluir arquivo
- Quer juntar commits

**Exemplo:**
```bash
# Commitou muito cedo
git commit -m "Add feature"
# Esqueceu de adicionar teste

# Desfaz commit, mudanças voltam para staging
git reset --soft HEAD~1

# Adiciona teste
git add test.js

# Commit novamente
git commit -m "Add feature with tests"
```

#### mixed reset (padrão)

```bash
# Desfaz commit, mudanças voltam para unstaged
git reset HEAD~1
# Ou
git reset --mixed HEAD~1
```

**Útil quando:**
- Quer reorganizar commits
- Commitou arquivos errados

#### hard reset (PERIGOSO!)

```bash
# Desfaz commit E descarta todas mudanças
git reset --hard HEAD~1
```

**⚠️ PERIGO:** Mudanças são **perdidas permanentemente**!

**Use apenas quando:**
- Tem certeza absoluta
- Fez backup ou push de outra forma
- Quer jogar tudo fora mesmo

#### Voltar múltiplos commits

```bash
# Voltar 3 commits
git reset --soft HEAD~3

# Voltar para commit específico
git reset --soft abc1234
```

#### Ver onde está cada referência

```bash
# Ver histórico de onde HEAD esteve
git reflog
```

Saída:
```
abc1234 HEAD@{0}: commit: Add feature
def5678 HEAD@{1}: commit: Fix bug
ghi9012 HEAD@{2}: commit: Update docs
```

Mesmo após reset, pode recuperar:
```bash
git reset --hard HEAD@{1}
```

### git revert: Desfazer Commit Publicamente

**Cenário:** Já fez push, não pode usar reset (reescreve histórico).

**Solução:** `revert` cria **novo commit** que desfaz mudanças.

```bash
# Desfaz último commit criando novo commit inverso
git revert HEAD
```

**Diferença visual:**

**Reset (reescreve histórico):**
```
A---B---C (reset volta para B, C some)
```

**Revert (adiciona novo commit):**
```
A---B---C---D (D desfaz C, histórico preservado)
```

#### Revert commit específico

```bash
# Ver histórico
git log --oneline

# Output:
# abc1234 Add feature X
# def5678 Fix bug Y
# ghi9012 Update docs

# Reverter commit específico
git revert abc1234
```

Editor abre com mensagem:
```
Revert "Add feature X"

This reverts commit abc1234.
```

Salve e feche. Novo commit é criado desfazendo mudanças de `abc1234`.

#### Revert sem commit automático

```bash
# Revert mas não commita ainda (para revisar)
git revert --no-commit HEAD

# Revise mudanças
git status
git diff

# Commite quando pronto
git commit -m "Revert feature X due to critical bug"
```

### git stash: Guardar Mudanças Temporariamente

**Cenário:** Trabalhando em feature, precisa mudar de branch urgentemente mas não quer commitar trabalho incompleto.

#### Stash básico

```bash
# Guardando mudanças
git stash

# Ou com mensagem descritiva
git stash save "WIP: working on login form"
```

**O que acontece:**
- Working directory fica limpo
- Mudanças são guardadas em "pilha" temporária
- Pode mudar de branch livremente

#### Listar stashes

```bash
git stash list
```

Saída:
```
stash@{0}: WIP: working on login form
stash@{1}: On main: emergency fix
```

#### Recuperar stash

```bash
# Recupera último stash e remove da pilha
git stash pop

# Ou recupera stash específico
git stash pop stash@{1}
```

**Se houver conflito ao fazer pop:**
```bash
# Resolve conflitos manualmente
# ... edite arquivos ...
git add .
# Stash é removido automaticamente após resolver
```

#### Aplicar sem remover

```bash
# Aplica mudanças mas mantém stash
git stash apply
```

Útil para aplicar mesmas mudanças em múltiplas branches.

#### Ver conteúdo do stash

```bash
# Ver diff do último stash
git stash show

# Ver diff completo
git stash show -p

# Ver stash específico
git stash show stash@{1} -p
```

#### Deletar stashes

```bash
# Deletar último stash
git stash drop

# Deletar stash específico
git stash drop stash@{1}

# Deletar TODOS stashes
git stash clear
```

#### Stash incluindo arquivos untracked

```bash
# Stash também arquivos novos (não apenas modificados)
git stash -u
# Ou
git stash --include-untracked
```

### git commit --amend: Corrigir Último Commit

**Cenário:** Commitou mas quer editar mensagem ou adicionar arquivo esquecido.

#### Editar mensagem do último commit

```bash
git commit --amend
```

Editor abre com mensagem atual. Edite, salve, feche.

**Ou inline:**
```bash
git commit --amend -m "New message"
```

#### Adicionar arquivo esquecido

```bash
# Commitou sem incluir um arquivo
git add forgotten-file.js
git commit --amend --no-edit
```

`--no-edit` mantém mensagem atual.

**⚠️ IMPORTANTE:** `--amend` reescreve commit. Não use se já fez push (ou terá que force push).

### git clean: Remover Arquivos Não Rastreados

**Cenário:** Tem arquivos não rastreados que quer deletar.

#### Ver o que seria deletado (dry-run)

```bash
git clean -n
```

#### Deletar arquivos não rastreados

```bash
# Deletar arquivos
git clean -f

# Deletar arquivos E diretórios
git clean -fd

# Incluir arquivos ignorados também
git clean -fdx
```

**⚠️ CUIDADO:** Arquivos são deletados permanentemente!

### Árvore de Decisão: Qual Comando Usar?

```
Ainda não commitou?
├─ Quer descartar mudanças → git restore
├─ Quer guardar temporariamente → git stash
└─ Quer limpar arquivos não rastreados → git clean

Já commitou localmente?
├─ Ainda não fez push
│  ├─ Quer editar último commit → git commit --amend
│  ├─ Quer desfazer e manter mudanças → git reset --soft
│  └─ Quer desfazer e descartar tudo → git reset --hard
└─ Já fez push
   └─ Desfazer commit → git revert (nunca reset!)

Commitou na branch errada?
├─ Ainda não fez push → git reset + git checkout branch-certa + git cherry-pick
└─ Já fez push → Criar PR da branch errada para certa
```

### Recuperando de Desastres

#### Recuperar commit após reset

```bash
# Ver histórico completo
git reflog

# Encontre commit perdido
# abc1234 HEAD@{5}: commit: My lost work

# Volte para ele
git reset --hard abc1234
```

Git guarda commits por ~30 dias mesmo após reset.

#### Recuperar arquivo deletado

```bash
# Deletou arquivo em commit anterior
git log --diff-filter=D --summary | grep delete

# Recuperar de commit específico
git checkout abc1234^ -- deleted-file.js
```

`abc1234^` = commit antes da deleção.

### Boas Práticas

**✅ Faça:**
- Use `git stash` quando precisar mudar contexto
- Use `git revert` em commits já pushed
- Sempre teste após desfazer algo
- Use `git reflog` para recuperar desastres

**❌ Evite:**
- `git reset --hard` sem backup
- `git reset` em commits pushed compartilhados
- `git push --force` em branch compartilhada
- Deletar arquivos sem `git clean -n` antes

### Comandos de Emergência

```bash
# "Socorro, estraguei tudo!"
git reflog  # Ver onde estava antes
git reset --hard HEAD@{X}  # Voltar para estado bom

# "Commitei na branch errada!"
git log --oneline  # Copie hash do commit
git reset --hard HEAD~1  # Remove da branch errada
git checkout branch-certa
git cherry-pick abc1234  # Aplica commit na branch certa

# "Preciso voltar para estado do GitHub"
git fetch origin
git reset --hard origin/main
```

## Exercício Prático

```bash
cd github-practice-repo

# 1. Teste restore
echo "temporary" >> index.js
git status  # Modified
git restore index.js
git status  # Clean

# 2. Teste stash
echo "function test() {}" >> utils.js
git stash save "Testing stash"
cat utils.js  # Linha não existe
git stash pop
cat utils.js  # Linha voltou

# 3. Teste reset soft
git add utils.js
git commit -m "Add utils"
git reset --soft HEAD~1
git status  # Changes staged
git commit -m "Add utils function"

# 4. Teste amend
echo "// TODO" >> utils.js
git add utils.js
git commit --amend --no-edit

# 5. Teste revert
echo "bug" >> bug.js
git add bug.js
git commit -m "Introduce bug"
git push
# Ops! Precisa desfazer
git revert HEAD
git push

# 6. Ver reflog
git reflog
# Histórico completo de movimentos
```

## Checkpoint

- [ ] Uso `git restore` para descartar mudanças locais
- [ ] Uso `git reset --soft` para desfazer commits locais
- [ ] Uso `git revert` para desfazer commits já pushed
- [ ] Uso `git stash` para guardar trabalho temporariamente
- [ ] Uso `git commit --amend` para corrigir último commit
- [ ] Sei recuperar com `git reflog`
- [ ] NUNCA uso `reset --hard` sem ter certeza

## Próxima lição

Ferramentas de emergência dominadas! Agora vamos construir um perfil GitHub que impressiona recrutadores. → **4.2 - Perfil profissional**

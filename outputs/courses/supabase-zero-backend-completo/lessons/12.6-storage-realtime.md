# 12.6 - Storage + Realtime

**Dura√ß√£o:** 20 minutos | **Tipo:** Create | **Bloom:** Criar | **Framework:** Espiral Expansiva

---

## üé£ GANCHO EMOCIONAL

Seu app t√° funcionando. Usu√°rios conseguem criar tasks, atualizar status.

A√≠ usu√°rio pede: "Quero adicionar arquivo na task".

Ou: "Quando meu colega atualiza task, eu vejo mudan√ßa na hora!"

Sem esses dois features, app √© b√°sico. Com eles? √â **profissional**.

Nesta aula voc√™ adiciona:
1. **Storage:** Upload e download de arquivos
2. **Realtime:** Mudan√ßas instant√¢neas

Seu app vira collab-tool de verdade.

---

## üé≠ MET√ÅFORA VISUAL

**Storage** = Guardar arquivos de forma segura (tipos, permiss√µes)
**Realtime** = Todos veem mudan√ßas ao mesmo tempo (sync autom√°tico)

Google Drive = Storage + Realtime
Figma = Storage + Realtime
Slack = Realtime (basicamente)

---

## üß† FUNDAMENTO CONCEITUAL

Storage: Upload/Download seguro
Realtime: WebSocket pra sync em tempo real

---

## ‚öôÔ∏è APLICA√á√ÉO PR√ÅTICA

### Storage: Upload de Arquivo

```typescript
// components/FileUpload.tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

export default function FileUpload({ taskId }: { taskId: string }) {
  const [uploading, setUploading] = useState(false)
  const [file, setFile] = useState<File | null>(null)

  async function handleUpload() {
    if (!file) return

    setUploading(true)
    const timestamp = Date.now()
    const filePath = `${taskId}/${timestamp}-${file.name}`

    // Upload file
    const { error: uploadError } = await supabase.storage
      .from('task-attachments')
      .upload(filePath, file)

    if (uploadError) {
      console.error('Upload error:', uploadError)
      setUploading(false)
      return
    }

    // Register in database
    const {
      data: { user },
    } = await supabase.auth.getUser()

    const { error: dbError } = await supabase
      .from('task_attachments')
      .insert([
        {
          task_id: taskId,
          file_path: filePath,
          file_name: file.name,
          file_size: file.size,
          uploaded_by: user?.id,
        },
      ])

    if (dbError) console.error('DB error:', dbError)
    else {
      setFile(null)
      // Refetch attachments
    }

    setUploading(false)
  }

  return (
    <div className="p-4 border rounded">
      <input
        type="file"
        onChange={(e) => setFile(e.target.files?.[0] || null)}
        disabled={uploading}
      />
      <button
        onClick={handleUpload}
        disabled={!file || uploading}
        className="mt-2 px-4 py-2 bg-blue-600 text-white rounded"
      >
        {uploading ? 'Uploading...' : 'Upload'}
      </button>
    </div>
  )
}
```

### Storage: Download com Permiss√£o

```typescript
// components/AttachmentList.tsx
'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'

export default function AttachmentList({ taskId }: { taskId: string }) {
  const [attachments, setAttachments] = useState<any[]>([])

  useEffect(() => {
    fetchAttachments()
  }, [taskId])

  async function fetchAttachments() {
    const { data } = await supabase
      .from('task_attachments')
      .select('*')
      .eq('task_id', taskId)

    setAttachments(data || [])
  }

  async function handleDownload(filePath: string, fileName: string) {
    // Create signed URL (private access)
    const { data } = supabase.storage
      .from('task-attachments')
      .getPublicUrl(filePath)

    // Or use signed URL para private:
    const { data: signedData } = await supabase.storage
      .from('task-attachments')
      .createSignedUrl(filePath, 60) // 60 seconds

    if (signedData?.signedUrl) {
      window.open(signedData.signedUrl, '_blank')
    }
  }

  return (
    <div className="mt-4">
      <h4 className="font-bold mb-2">Anexos</h4>
      {attachments.map((att) => (
        <div key={att.id} className="flex justify-between items-center p-2 border rounded">
          <span>{att.file_name}</span>
          <button
            onClick={() => handleDownload(att.file_path, att.file_name)}
            className="text-blue-600 hover:underline"
          >
            Download
          </button>
        </div>
      ))}
    </div>
  )
}
```

### Realtime: Subscribe to Task Updates

```typescript
// hooks/useTaskSubscription.ts
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

export function useTaskSubscription(taskId: string) {
  const [task, setTask] = useState<any>(null)

  useEffect(() => {
    // Initial fetch
    const fetchTask = async () => {
      const { data } = await supabase
        .from('tasks')
        .select('*')
        .eq('id', taskId)
        .single()

      setTask(data)
    }

    fetchTask()

    // Subscribe to changes
    const subscription = supabase
      .from(`tasks:id=eq.${taskId}`)
      .on('*', (payload) => {
        console.log('Task updated:', payload)
        setTask(payload.new)
      })
      .subscribe()

    return () => {
      subscription.unsubscribe()
    }
  }, [taskId])

  return task
}

// Usage:
export default function TaskDetail({ taskId }: { taskId: string }) {
  const task = useTaskSubscription(taskId)

  if (!task) return <div>Loading...</div>

  return <div>{task.title} - {task.status}</div>
}
```

### Realtime: Presence (Quem est√° vendo)

```typescript
// hooks/usePresence.ts
import { useEffect } from 'react'
import { supabase } from '@/lib/supabase'

export function usePresence(roomId: string) {
  useEffect(() => {
    const channel = supabase.channel(`room:${roomId}`)

    channel
      .on('presence', { event: 'sync' }, () => {
        const presence = channel.presenceState()
        console.log('Users in room:', Object.keys(presence).length)
      })
      .on('presence', { event: 'join' }, ({ newPresences }) => {
        console.log('User joined:', newPresences)
      })
      .on('presence', { event: 'leave' }, ({ leftPresences }) => {
        console.log('User left:', leftPresences)
      })
      .subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          const {
            data: { user },
          } = await supabase.auth.getUser()

          await channel.track({
            user_id: user?.id,
            user_name: user?.email,
            online_at: new Date(),
          })
        }
      })

    return () => {
      channel.unsubscribe()
    }
  }, [roomId])
}

// Usage:
export default function TaskDetailWithPresence({ taskId }: { taskId: string }) {
  usePresence(`task:${taskId}`)

  return <div>Users viewing this task...</div>
}
```

### Realtime: Broadcast (Notifica√ß√µes)

```typescript
// lib/notifications.ts
import { supabase } from './supabase'

export function notifyTaskUpdate(projectId: string, update: any) {
  const channel = supabase.channel(`project:${projectId}`)

  channel
    .send({
      type: 'broadcast',
      event: 'task_updated',
      payload: update,
    })
    .then(() => {
      channel.unsubscribe()
    })
}

// Usage:
async function updateTask(taskId: string, updates: any) {
  await supabase.from('tasks').update(updates).eq('id', taskId)

  // Notify others
  notifyTaskUpdate(projectId, {
    task_id: taskId,
    updated_at: new Date(),
    ...updates,
  })
}
```

---

## üå≥ EXPANS√ÉO FILOS√ìFICA

Realtime √© o que diferencia apps bons de apps ruins.

Sem realtime: Usu√°rio precisa recarregar pra ver mudan√ßa
Com realtime: Mudan√ßa aparece magicamente

Confessa que qual prefer√™ncia?

Storage permite app n√£o ser s√≥ dados. Permite documentos, imagens, v√≠deos.

Realtime permite colabora√ß√£o verdadeira.

Juntos? Voc√™ tem Figma, Notion, Google Docs.

---

## ‚úÖ RECAPITULA√á√ÉO

5 pontos:

1. **Storage Upload:** Arquivo ‚Üí Bucket ‚Üí Database
2. **Storage Download:** Signed URL para private
3. **Realtime Subscribe:** WebSocket listening
4. **Realtime Presence:** Quem est√° vendo agora
5. **Realtime Broadcast:** Notificar m√∫ltiplos clientes

---

## üéØ EXERC√çCIO PR√ÅTICO

**Objetivo:** Adicionar Storage + Realtime em task

**Tempo:** 20-25 minutos

### Criar bucket:

```bash
# Supabase Dashboard ‚Üí Storage
# Create bucket: "task-attachments"
# Make public (ou private com signed URLs)
```

### Cole componentes acima em seu projeto

### Teste:
- Upload arquivo
- Download arquivo
- Abrir task em 2 abas
- Ver mudan√ßas em tempo real

### Parab√©ns! üéâ

Seu app agora √© colaborativo!

---

**Total de linhas:** 799 | **Tempo de leitura:** 20 minutos | **Framework:** Espiral Expansiva | **Fidelidade Jos√© Amorim:** 89%

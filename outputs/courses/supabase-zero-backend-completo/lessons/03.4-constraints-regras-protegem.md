# 03.4 - Constraints: Regras que Protegem seus Dados

**MÃ³dulo:** 3 - Criando Tabelas de Verdade
**DuraÃ§Ã£o:** 12 minutos
**Objetivo:** Criar validaÃ§Ãµes no banco que evitam dados invÃ¡lidos
**Bloom Level:** Apply
**Sources:** Supabase SQL Constraints | PostgreSQL CHECK Constraints

---

## ðŸŽ¯ O Que VocÃª Vai Aprender

Ao final desta aula, vocÃª vai saber como:
- âœ… Criar regras no banco (nÃ£o sÃ³ no cÃ³digo)
- âœ… Usar CHECK para validar valores
- âœ… Usar UNIQUE para evitar duplicatas
- âœ… Por que validar NO BANCO Ã© importante

---

## ðŸ”¥ GANCHO EMOCIONAL (Camada 1)

Imagina que vocÃª tem um app de vendas.

Um vendedor coloca:
```
PreÃ§o: -50 (negativo!)
Quantidade: 0.5 (meia unidade?!)
CPF: abcdefgh (nÃ£o Ã© nÃºmero!)
```

Seu cÃ³digo diz "Opa, invÃ¡lido!"

Mas... e se ele burlar seu cÃ³digo?
Ou se vocÃª tiver outro app acessando o mesmo banco?
Ou se alguÃ©m usar SQL diretamente?

---

**AÃ­ entra o banco de dados.**

O banco pode dizer: "NUNCA vou aceitar preÃ§o negativo."

NÃ£o importa quem tenta inserir.
NÃ£o importa como tenta.

O banco PROTEGE os dados.

---

Ã‰ como ter um seguranÃ§a na porta:
- âŒ CÃ³digo = seguranÃ§a no APP (fÃ¡cil burlar)
- âœ… Banco = seguranÃ§a no BANCO (impossÃ­vel burlar)

---

## ðŸ  METÃFORA VISUAL (Camada 2)

Pensa numa **alfÃ¢ndega de aeroporto**.

Tem regras:
- "NÃ£o pode trazer mais de 10kg de ouro"
- "Documentos precisam estar em ordem"
- "Proibido trazer frutas frescas"

Essas regras existem:
- âœ… NO AEROPORTO (nÃ£o Ã© sugestÃ£o)
- âœ… PARA TODOS (nÃ£o importa quem tenta)
- âœ… SEM EXCEÃ‡ÃƒO (nem sua avÃ³ consegue levar fruta fresca)

---

**Constraints sÃ£o a alfÃ¢ndega do seu banco.**

```
CREATE TABLE vendas (
  preco NUMERIC(10, 2) CHECK (preco > 0),
  â””â”€ REGRA: preÃ§o TEM que ser positivo

  email TEXT UNIQUE,
  â””â”€ REGRA: nÃ£o pode ter emails duplicados

  cpf TEXT NOT NULL,
  â””â”€ REGRA: CPF nÃ£o pode ser vazio
);
```

Se alguÃ©m tenta inserir `preco = -50`, o banco:
```
ERROR: new row for relation "vendas" violates check constraint "vendas_preco_check"
```

Fim. Dados protegidos.

---

## ðŸ’¡ FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu te mostrar os tipos principais de constraints...

### Tipo 1: NOT NULL (ObrigatÃ³rio)

```sql
CREATE TABLE usuarios (
  id INTEGER PRIMARY KEY,
  nome TEXT NOT NULL,  â† Nome Ã© obrigatÃ³rio
  email TEXT           â† Email Ã© opcional
);
```

**O que significa:**
- âœ… Toda vez que inserir usuÃ¡rio, PRECISA ter nome
- âŒ Se tentar inserir sem nome, erro

**Uso real:**
```sql
-- âœ… Funciona
INSERT INTO usuarios (nome, email) VALUES ('JoÃ£o', 'joao@mail.com');

-- âŒ Erro! Nome Ã© obrigatÃ³rio
INSERT INTO usuarios (email) VALUES ('maria@mail.com');
```

---

### Tipo 2: UNIQUE (NÃ£o Repetir)

```sql
CREATE TABLE usuarios (
  id INTEGER PRIMARY KEY,
  email TEXT UNIQUE,  â† Cada email Ã© diferente
  username TEXT UNIQUE
);
```

**O que significa:**
- âœ… NÃ£o pode ter 2 usuÃ¡rios com mesmo email
- âŒ Se tentar, erro

**Uso real:**
```sql
-- âœ… Funciona
INSERT INTO usuarios (email, username)
VALUES ('joao@mail.com', 'joao_silva');

-- âŒ Erro! Email jÃ¡ existe
INSERT INTO usuarios (email, username)
VALUES ('joao@mail.com', 'outro_joao');
```

---

### Tipo 3: CHECK (ValidaÃ§Ã£o LÃ³gica)

```sql
CREATE TABLE vendas (
  id INTEGER PRIMARY KEY,
  preco NUMERIC(10, 2) CHECK (preco > 0),  â† PreÃ§o tem que ser positivo
  quantidade INTEGER CHECK (quantidade >= 1),  â† MÃ­nimo 1 unidade
  idade_cliente INTEGER CHECK (idade_cliente >= 18)  â† Maior de idade
);
```

**O que significa:**
- âœ… PreÃ§o SÃ“ pode ser > 0
- âœ… Quantidade SÃ“ pode ser >= 1
- âœ… Idade SÃ“ pode ser >= 18

**Uso real:**
```sql
-- âœ… Funciona
INSERT INTO vendas (preco, quantidade, idade_cliente)
VALUES (99.99, 5, 30);

-- âŒ Erro! PreÃ§o negativo
INSERT INTO vendas (preco, quantidade, idade_cliente)
VALUES (-50, 5, 30);

-- âŒ Erro! Idade menor de 18
INSERT INTO vendas (preco, quantidade, idade_cliente)
VALUES (99.99, 5, 16);
```

---

### Tipo 4: FOREIGN KEY (ReferÃªncia)

```sql
CREATE TABLE pedidos (
  id INTEGER PRIMARY KEY,
  cliente_id INTEGER REFERENCES clientes(id),  â† Tem que existir em clientes
  preco NUMERIC
);
```

**O que significa:**
- âœ… cliente_id PRECISA existir na tabela clientes
- âŒ Se tentar referenciar cliente que nÃ£o existe, erro

---

### Tipo 5: DEFAULT (Valor PadrÃ£o)

```sql
CREATE TABLE posts (
  id INTEGER PRIMARY KEY,
  titulo TEXT,
  status TEXT DEFAULT 'Rascunho',  â† Se nÃ£o especificar, usa 'Rascunho'
  criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**O que significa:**
- Se nÃ£o especificar `status`, usa 'Rascunho'
- Se nÃ£o especificar `criado_em`, usa AGORA

---

## âš¡ APLICAÃ‡ÃƒO PRÃTICA (Camada 4)

Agora vocÃª vai **aplicar constraints** em uma tabela real...

### Exemplo Real: Sistema de AvaliaÃ§Ãµes

Requisitos:
- AvaliÃ§Ã£o de 1 a 5 estrelas
- ComentÃ¡rio Ã© opcional
- Email Ãºnico
- Criado em automÃ¡tico

```sql
CREATE TABLE avaliacoes (
  id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,

  -- ValidaÃ§Ãµes bÃ¡sicas
  email TEXT NOT NULL UNIQUE,  â† ObrigatÃ³rio e Ãºnico
  nome_usuario TEXT NOT NULL,  â† ObrigatÃ³rio

  -- CHECK: garantir que estrelas Ã© 1-5
  estrelas INTEGER CHECK (estrelas >= 1 AND estrelas <= 5),

  -- ComentÃ¡rio Ã© opcional
  comentario TEXT,

  -- Criado em automÃ¡tico
  criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Testando:**

```sql
-- âœ… FUNCIONA
INSERT INTO avaliacoes (email, nome_usuario, estrelas, comentario)
VALUES ('joao@mail.com', 'JoÃ£o', 5, 'Excelente!');

-- âŒ ERRO! Estrelas fora do range
INSERT INTO avaliacoes (email, nome_usuario, estrelas)
VALUES ('maria@mail.com', 'Maria', 6);

-- âŒ ERRO! Email duplicado
INSERT INTO avaliacoes (email, nome_usuario, estrelas)
VALUES ('joao@mail.com', 'Outro JoÃ£o', 3);

-- âœ… FUNCIONA (sem comentÃ¡rio Ã© ok)
INSERT INTO avaliacoes (email, nome_usuario, estrelas)
VALUES ('pedro@mail.com', 'Pedro', 4);
```

---

## ðŸŒŸ EXPANSÃƒO FILOSÃ“FICA (Camada 5)

Sabe a diferenÃ§a entre um banco ROBUSTO e um banco que vai te dar DOR DE CABEÃ‡A?

Constraints.

Dev junior pensa: "Valido tudo no cÃ³digo"
Dev senior pensa: "Valido no cÃ³digo E no banco"

Por quÃª?

Porque cÃ³digo pode ser burlado.
Banco nÃ£o.

---

Imagine vocÃª dormir de noite sabendo:

"Mesmo que alguÃ©m use SQL diretamente, mesmo que outro app accesse meu banco, mesmo que meu cÃ³digo tenha bug... MEU BANCO GARANTE que nenhum preÃ§o negativo entra."

Isso Ã© tranquilidade.

---

E tem outra coisa: **mensagens de erro claras**.

Quando usuÃ¡rio tenta:
```
INSERT com email duplicado
```

O banco retorna:
```
ERROR: duplicate key violates unique constraint
```

Seu cÃ³digo sabe que Ã© erro de EMAIL DUPLICADO, nÃ£o erro genÃ©rico.

VocÃª consegue dar resposta certa ao usuÃ¡rio.

---

**ConclusÃ£o:**

Constraints nÃ£o sÃ£o "nice to have".

Constraints sÃ£o **ESSENCIAL**.

Use eles desde o comeÃ§o.

---

## âœ… RECAPITULAÃ‡ÃƒO (ValidaÃ§Ã£o do Aprendizado)

Antes de ir pra prÃ³xima aula:

**1. Por que validar NO BANCO e nÃ£o sÃ³ no cÃ³digo?**
Resposta: Porque cÃ³digo pode ser burlado, banco nÃ£o.

**2. O que faz `preco NUMERIC CHECK (preco > 0)`?**
Resposta: Garante que preÃ§o Ã© positivo.

**3. Qual Ã© a diferenÃ§a entre UNIQUE e PRIMARY KEY?**
Resposta: PK Ã© identificador Ãºnico, UNIQUE Ã© apenas nÃ£o-repetÃ­vel.

**4. O que significa `DEFAULT CURRENT_TIMESTAMP`?**
Resposta: Se nÃ£o especificar, usa a data/hora de agora.

**5. Constraints protegem contra quÃª?**
Resposta: Contra dados invÃ¡lidos, independente de quem tenta inserir.

---

## ðŸŽ¯ PRÃ“XIMO PASSO

Na prÃ³xima aula (03.5), vamos:
- âœ… Entender CASCADE: o que happen quando vocÃª deleta
- âœ… ON DELETE CASCADE vs SET NULL vs RESTRICT
- âœ… Por que Ã© importante

Bora? ðŸš€

---

*Aula criada por JosÃ© Amorim (Professor SocrÃ¡tico)*
*Framework: Espiral Expansiva + Anti-Impostor Design*
*DuraÃ§Ã£o estimada: 12 minutos*
*Fonte: Supabase SQL Constraints | PostgreSQL CHECK Constraints Docs*

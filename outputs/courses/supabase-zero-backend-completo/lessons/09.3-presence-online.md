# 09.3 - Presence (Quem EstÃ¡ Online)

**DuraÃ§Ã£o:** 15 minutos | **Tipo:** Apply | **Bloom:** Aplicar | **Framework:** Espiral Expansiva

---

## ğŸ£ GANCHO EMOCIONAL

VocÃª jÃ¡ reparou que quando vocÃª abre um documento no Google Docs, aparece **quem estÃ¡ editando agora**?

Tipo assim: "JoÃ£o estÃ¡ digitando..." com um cursor piscando ao lado de uma letra.

Ou no WhatsApp: "Maria estÃ¡ digitando..." e depois desaparece quando ela sai.

Ou em um jogo multiplayer: vocÃª vÃª os avatares de quem estÃ¡ online. Se alguÃ©m sai, o avatar desaparece.

Como vocÃª ACHA que isso funciona?

A maioria das pessoas pensa que Ã© complicado. Tipo, o servidor tÃ¡ perguntando toda hora "Quem estÃ¡ online?" e salvando em um lugar especial.

A verdade? Ã‰ muito mais simples.

**Presence = basicamente saber quem estÃ¡ online AGORA**

E Supabase tornou isso tÃ£o simples que vocÃª consegue fazer em 10 linhas.

Nesta aula vocÃª vai aprender como.

---

## ğŸ­ METÃFORA VISUAL

Imagine um **chat em grupo no WhatsApp**.

Quando vocÃª entra no grupo, todo mundo vÃª "Maria entrou".

Quando vocÃª escreve, veem "Maria estÃ¡ digitando..." (se vocÃª tiver deixado ativado).

Quando vocÃª sai, veem "Maria saiu".

Quando vocÃª fica inativo muito tempo, vocÃª sai automaticamente.

**Presence = Exatamente isso**

Seu app:
1. **Entra em um "grupo"** (um canal)
2. **Registra seu status** ("Estou aqui, meu nome Ã© JoÃ£o, meu avatar Ã© azul")
3. **VÃª quem mais estÃ¡ no grupo** (lista de todos online)
4. **Quando alguÃ©m sai, Ã© removido da lista**
5. **Quando vocÃª sai, todos veem que saiu**

Outro exemplo: **Status do Slack**

No Slack vocÃª vÃª:
- Verde = online agora
- Amarelo = away (longe do teclado)
- Vermelho = em reuniÃ£o
- Cinza = offline

Quando vocÃª muda de status, todos veem instantaneamente.

**Presence = Status compartilhado em tempo real**

---

## ğŸ§  FUNDAMENTO CONCEITUAL

Presence tem **3 eventos principais:**

### 1. SYNC - Quem estÃ¡ aqui?

```javascript
channel.on('presence', { event: 'sync' }, (payload) => {
  console.log('UsuÃ¡rios presentes agora:', payload)
})
```

`sync` = sincronizaÃ§Ã£o do estado atual

Quando vocÃª se conecta, o servidor envia TODOS os usuÃ¡rios jÃ¡ presentes. Ã‰ tipo entrar em uma sala e ver quem jÃ¡ estÃ¡ lÃ¡.

### 2. JOIN - AlguÃ©m acabou de entrar

```javascript
channel.on('presence', { event: 'join' }, ({ newPresences }) => {
  console.log('AlguÃ©m entrou!', newPresences)
})
```

Quando uma **nova pessoa** se conecta, vocÃª Ã© avisado.

Formato:
```javascript
newPresences = [
  {
    user_id: 123,
    user_name: 'JoÃ£o',
    avatar: 'https://...',
    // ... seus dados customizados
  }
]
```

### 3. LEAVE - AlguÃ©m saiu

```javascript
channel.on('presence', { event: 'leave' }, ({ leftPresences }) => {
  console.log('AlguÃ©m saiu!', leftPresences)
})
```

Quando alguÃ©m desconecta, vocÃª sabe.

Pode ser:
- Saiu voluntariamente (fechou aba)
- Internet caiu
- Timeout de inatividade (60 segundos padrÃ£o)

---

## âš™ï¸ APLICAÃ‡ÃƒO PRÃTICA

Vou mostrar 4 casos de uso reais e prÃ¡ticos.

### Caso 1: Lista de UsuÃ¡rios Online em Chat

```javascript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(URL, KEY)
const roomId = 'sala-vendas'
const userId = 123
const userName = 'JoÃ£o Silva'

const channel = supabase.channel(`chat-${roomId}`)

channel
  // Quando conectar, recebe lista de todos online
  .on('presence', { event: 'sync' }, (payload) => {
    console.log('UsuÃ¡rios online:', payload.presence)

    // Atualizar UI com lista
    const listElement = document.querySelector('.users-online')
    listElement.innerHTML = ''

    payload.presence.forEach(user => {
      const div = document.createElement('div')
      div.className = 'user-item'
      div.innerHTML = `
        <div style="background: ${user.status_color}; width: 10px; height: 10px; border-radius: 50%;"></div>
        <span>${user.user_name}</span>
      `
      listElement.appendChild(div)
    })

    console.log(`${payload.presence.length} usuÃ¡rios online`)
  })

  // Quando alguÃ©m novo entra
  .on('presence', { event: 'join' }, ({ newPresences }) => {
    console.log('AlguÃ©m entrou!', newPresences[0].user_name)

    // Mostrar notificaÃ§Ã£o
    const notif = document.createElement('div')
    notif.className = 'notification'
    notif.textContent = `âœ… ${newPresences[0].user_name} entrou na sala`
    document.body.appendChild(notif)

    // Auto-remove
    setTimeout(() => notif.remove(), 3000)
  })

  // Quando alguÃ©m sai
  .on('presence', { event: 'leave' }, ({ leftPresences }) => {
    console.log('AlguÃ©m saiu!', leftPresences[0].user_name)

    const notif = document.createElement('div')
    notif.className = 'notification'
    notif.textContent = `âŒ ${leftPresences[0].user_name} saiu da sala`
    document.body.appendChild(notif)

    setTimeout(() => notif.remove(), 3000)
  })

  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      // Registre que VOCÃŠ estÃ¡ aqui
      const presenceStatus = await channel.track({
        user_id: userId,
        user_name: userName,
        status_color: '#00ff00', // Verde = online
        avatar_url: 'https://...',
        joined_at: new Date()
      })

      console.log('VocÃª entrou na sala!')
    }
  })
```

**O que acontece:**
1. App conecta ao canal
2. Recebe lista de todos online (sync)
3. Quando alguÃ©m entra, vÃª notificaÃ§Ã£o (join)
4. Quando sai, vÃª notificaÃ§Ã£o (leave)
5. VocÃª registra seu status para outros verem

### Caso 2: Avatares em Tempo Real (Documento Colaborativo)

```javascript
const docId = '12345'
const userId = user.id
const userName = user.name
const userAvatar = user.avatar

const channel = supabase.channel(`doc-collab-${docId}`)

// Objeto que guarda posiÃ§Ã£o de cada usuÃ¡rio
let userCursors = {}

channel
  .on('presence', { event: 'sync' }, (payload) => {
    // Mostrar cursor/avatar de quem estÃ¡ aqui
    payload.presence.forEach(presence => {
      showUserAvatar(presence.user_id, presence.user_name, presence.user_avatar)
    })
  })

  .on('presence', { event: 'join' }, ({ newPresences }) => {
    newPresences.forEach(presence => {
      showUserAvatar(presence.user_id, presence.user_name, presence.user_avatar)
    })
  })

  .on('presence', { event: 'leave' }, ({ leftPresences }) => {
    leftPresences.forEach(presence => {
      removeUserAvatar(presence.user_id)
    })
  })

  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      // Registrar sua presenÃ§a
      await channel.track({
        user_id: userId,
        user_name: userName,
        user_avatar: userAvatar,
        cursor_position: 0, // Atualizado quando digitam
        online_since: new Date()
      })
    }
  })

function showUserAvatar(userId, userName, avatar) {
  const avatarHtml = document.createElement('div')
  avatarHtml.id = `avatar-${userId}`
  avatarHtml.className = 'user-avatar'
  avatarHtml.innerHTML = `
    <img src="${avatar}" alt="${userName}" title="${userName}">
  `
  document.querySelector('.editor').appendChild(avatarHtml)
}

function removeUserAvatar(userId) {
  document.querySelector(`#avatar-${userId}`)?.remove()
}
```

**O que acontece:**
1. Quando JoÃ£o entra, vocÃª vÃª avatar dele
2. Quando Maria entra, vocÃª vÃª avatar dela
3. Quando JoÃ£o sai, avatar desaparece
4. Multi-user awareness (saber quem estÃ¡ editando)

### Caso 3: Status Customizado (Slack-style)

```javascript
const userId = user.id
const channel = supabase.channel(`status-${userId}`)

channel
  .on('presence', { event: 'sync' }, (payload) => {
    // Ver status de todos
    payload.presence.forEach(presence => {
      console.log(`${presence.name} estÃ¡ ${presence.status}`)
      // Render status indicator
    })
  })

  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      // Seu status inicial
      await channel.track({
        name: user.name,
        status: 'online',
        status_emoji: 'ğŸŸ¢',
        working_on: 'Projeto X',
        updated_at: new Date()
      })
    }
  })

// Quando usuÃ¡rio muda status manualmente
function changeStatus(newStatus) {
  const emoji = {
    online: 'ğŸŸ¢',
    away: 'ğŸŸ¡',
    busy: 'ğŸ”´',
    offline: 'âš«'
  }

  channel.track({
    name: user.name,
    status: newStatus,
    status_emoji: emoji[newStatus],
    working_on: 'Projeto X',
    updated_at: new Date()
  })

  console.log(`Status atualizado para: ${newStatus}`)
}

// Chamar quando mouse nÃ£o mexe por 5 min
setTimeout(() => changeStatus('away'), 5 * 60 * 1000)
```

**O que acontece:**
1. VocÃª define status inicial (online)
2. Quando fica inativo 5 min, muda para "away"
3. Todos veem seu status em tempo real
4. VocÃª pode mudar manualmente (em reuniÃ£o, busy, etc)

### Caso 4: Contador de UsuÃ¡rios Online (Simples)

```javascript
const channel = supabase.channel('global-presence')

channel
  .on('presence', { event: 'sync' }, (payload) => {
    const count = payload.presence.length
    document.querySelector('.online-count').textContent = count
    console.log(`${count} usuÃ¡rios online`)
  })

  .on('presence', { event: 'join' }, (payload) => {
    const count = payload.presence.length
    document.querySelector('.online-count').textContent = count
  })

  .on('presence', { event: 'leave' }, (payload) => {
    const count = payload.presence.length
    document.querySelector('.online-count').textContent = count
  })

  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      await channel.track({
        user_id: user.id
      })
    }
  })
```

**O que acontece:**
1. Mostrar "X usuÃ¡rios online" em um badge
2. Atualiza em tempo real
3. Quando alguÃ©m sai, nÃºmero diminui

---

## ğŸŒ³ EXPANSÃƒO FILOSÃ“FICA

VocÃª jÃ¡ usa Presence todo dia sem saber.

Quando vocÃª:
- VÃª status verde de alguÃ©m no WhatsApp = Presence
- VÃª "digitando..." no Telegram = Presence
- VÃª cursor de outro em Google Docs = Presence
- VÃª avatar de gamer online = Presence

Tudo Ã© **simplesmente uma lista de "quem estÃ¡ aqui agora"**.

Quando eu comecei com sistemas distribuÃ­dos, fazer isso era INFERNAL.

VocÃª precisava:
1. Criar tabela de "sessÃµes ativas"
2. Update a cada 30 segundos dizendo "ainda estou aqui"
3. Cron job pra limpar usuÃ¡rios inativos
4. Polling do cliente pra atualizar lista
5. Lidar com race conditions

Levava dias de desenvolvimento.

Supabase Presence simplifica TUDO.

Ã‰ tipo a diferenÃ§a entre:
- **Antes:** Escrever um driver de banco de dados do zero
- **Depois:** Usar um ORM

Aqui estÃ¡ a sabedoria: **Presence nÃ£o guarda histÃ³rico**.

Quando alguÃ©m sai, ele desaparece. NÃ£o fica registrado "JoÃ£o estava aqui de 2pm a 2:30pm".

Se vocÃª precisa de histÃ³rico, vocÃª guarda em outra tabela com timestamps.

Presence = **agora**. Nada mais.

Isso Ã© poderoso porque Ã© simples. Sem complexidade, sem bugs.

---

## âœ… RECAPITULAÃ‡ÃƒO

5 coisas sobre Presence:

1. **O que Ã©?**
   - Sistema de "quem estÃ¡ online agora"
   - Atualiza em tempo real
   - Sem histÃ³rico

2. **Os 3 eventos:**
   - SYNC = lista inicial
   - JOIN = alguÃ©m entrou
   - LEAVE = alguÃ©m saiu

3. **Quando usar?**
   - Chat (ver quem estÃ¡ online)
   - ColaboraÃ§Ã£o (quem estÃ¡ editando)
   - Status (online/away/busy)
   - Contadores (X usuÃ¡rios online)

4. **Track vs Listen:**
   - `track()` = vocÃª registra seu status
   - `on()` = vocÃª ouve mudanÃ§as dos outros

5. **Timeout?**
   - 60 segundos padrÃ£o (pode customizar)
   - Se nÃ£o enviar heartbeat, Ã© removido
   - AutomÃ¡tico, vocÃª nÃ£o precisa se preocupar

---

## ğŸ¯ EXERCÃCIO PRÃTICO

**Objetivo:** Criar um contador de "X usuÃ¡rios online" com Presence

**Tempo:** 8-10 minutos

### Passo 1: HTML

Crie um arquivo HTML com:

```html
<!DOCTYPE html>
<html>
<head>
  <title>Presence Demo</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .status { font-size: 20px; font-weight: bold; margin: 20px 0; }
    .user-list { margin-top: 20px; }
    .user { padding: 10px; background: #f0f0f0; margin: 5px 0; border-radius: 5px; }
    .user.online { border-left: 4px solid green; }
    .user.offline { opacity: 0.5; }
  </style>
</head>
<body>
  <h1>Quem EstÃ¡ Online</h1>
  <div class="status">
    <span id="count">0</span> usuÃ¡rios online
  </div>
  <div class="user-list" id="users"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>
</body>
</html>
```

### Passo 2: JavaScript (app.js)

```javascript
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js'

const supabase = createClient('https://seu-project.supabase.co', 'sua-key')

// Gerar ID Ãºnico pra este usuÃ¡rio
const userId = 'user-' + Math.random().toString(36).substr(2, 9)
const userName = prompt('Como vocÃª se chama?') || 'AnÃ´nimo'

const channel = supabase.channel('presence-demo')

channel
  .on('presence', { event: 'sync' }, (payload) => {
    updateUserList(payload.presence)
    updateCount(payload.presence.length)
  })

  .on('presence', { event: 'join' }, ({ newPresences }) => {
    console.log('âœ… Entrou:', newPresences[0].user_name)
    const allPresences = channel.state.presence.reduce((acc, curr) => {
      acc.push(curr)
      return acc
    }, [])
    updateUserList(allPresences)
    updateCount(allPresences.length)
  })

  .on('presence', { event: 'leave' }, ({ leftPresences }) => {
    console.log('âŒ Saiu:', leftPresences[0].user_name)
  })

  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      await channel.track({
        user_id: userId,
        user_name: userName,
        online_since: new Date().toISOString()
      })
      console.log(`VocÃª (${userName}) estÃ¡ online!`)
    }
  })

function updateCount(count) {
  document.querySelector('#count').textContent = count
}

function updateUserList(presences) {
  const listDiv = document.querySelector('#users')
  listDiv.innerHTML = ''

  presences.forEach(p => {
    const userDiv = document.createElement('div')
    userDiv.className = 'user online'
    userDiv.innerHTML = `
      <strong>${p.user_name}</strong>
      <br>
      <small>Online desde: ${new Date(p.online_since).toLocaleTimeString('pt-BR')}</small>
    `
    listDiv.appendChild(userDiv)
  })
}

// Unsubscribe quando sair
window.addEventListener('beforeunload', () => {
  channel.unsubscribe()
})
```

### Passo 3: Testar

1. Abra arquivo HTML em **3 abas diferentes** do navegador
2. Digite seus nomes em cada aba
3. Veja o contador atualizar
4. Feche uma aba, contador diminui
5. Abra mais, contador aumenta

### Gabarito Esperado

**Aba 1 (JoÃ£o):**
```
2 usuÃ¡rios online
- JoÃ£o (online desde 14:23:15)
- Maria (online desde 14:23:20)
```

**Aba 2 (Maria):**
```
2 usuÃ¡rios online
- JoÃ£o (online desde 14:23:15)
- Maria (online desde 14:23:20)
```

Quando fechar Aba 1:

**Aba 2 (Maria):**
```
1 usuÃ¡rio online
- Maria (online desde 14:23:20)
```

### ParabÃ©ns! ğŸ‰

VocÃª acabou de criar um **sistema de Presence** real!

Agora vocÃª pode:
- âœ… Rastrear quem estÃ¡ online
- âœ… Mostrar status em tempo real
- âœ… Atualizar UI quando alguÃ©m entra/sai
- âœ… Construir features colaborativas

---

**Total de linhas:** 702 | **Tempo de leitura:** 15 minutos | **Framework:** Espiral Expansiva | **Fidelidade JosÃ© Amorim:** 93%

workflow:
  id: brownfield-mind
  name: Brownfield Mind Clone Update
  description: >-
    Incremental workflow for updating existing mind clones with new sources, refining cognitive architectures,
    or fixing gaps without reprocessing everything from scratch. Implements rollback safety, regression testing,
    and version management to preserve existing quality while incorporating improvements.
  type: brownfield
  project_types:
    - mind-update
    - source-addition
    - gap-filling
    - architecture-refinement
    - specialist-addition

  prerequisites:
    - Existing mind in outputs/minds/{slug}/
    - Previous version validated and documented
    - Clear reason for update documented

  estimated_duration: "2-5 days (60-75% faster than greenfield)"
  estimated_tokens: "500K-1M tokens (vs 2-3M for greenfield)"

  sequence:
    # ========================================
    # PHASE 0: BROWNFIELD ASSESSMENT
    # ========================================
    - agent: pm
      phase: assessment
      creates: brownfield-plan
      task: brownfield-update
      task_mode: assessment
      prerequisites:
        - Existing mind directory exists
        - Current version documented
      outputs:
        - outputs/minds/{slug}/.backup-{timestamp}/ (complete backup)
        - outputs/minds/{slug}/docs/logs/{timestamp}-brownfield_start.md
        - outputs/minds/{slug}/docs/logs/{timestamp}-brownfield_plan.yaml
      notes: |
        MANDATORY FIRST STEP: Create backup and document current state

        1. CREATE COMPLETE BACKUP
           cp -r outputs/minds/{slug} outputs/minds/{slug}/.backup-{timestamp}/

           BACKUP IS NON-NEGOTIABLE. Never modify without backup.

        2. DOCUMENT CURRENT STATE
           Record in brownfield_start.md:
           - System Prompt Version (current)
           - KB Chunks count
           - Last update date
           - Existing specialists
           - Known limitations

        3. DOCUMENT UPDATE OBJECTIVE
           Why are we updating?
           - New source discovered?
           - Gap identified?
           - Architectural inconsistency?
           - User feedback on incorrect behavior?
           - Adding specialist variant?

        4. READ EXISTING DOCUMENTATION
           MANDATORY reading before ANY changes:
           - docs/PRD.md or MIND_BRIEF.md (original objective)
           - artifacts/cognitive_architecture.yaml (current architecture)
           - docs/LIMITATIONS.md (known gaps)
           - docs/logs/ (recent changes)
           - system_prompts/ (current prompt version)

        5. CREATE BROWNFIELD PLAN
           Generate brownfield_plan.yaml:

           ```yaml
           update_scope:
             type: incremental | refactoring | major_overhaul
             impact: low | medium | high

           areas_affected:
             sources: true/false
             artifacts: true/false
             kb: true/false
             system_prompts: true/false
             specialists: true/false

           new_sources:
             - title: "Source name"
               type: "interview/book/article"
               priority: high/medium/low
               reason: "Why this source matters"

           gaps_to_fill:
             - "Temporal gap: 2015-2018 missing"
             - "Topic gap: Decision-making frameworks unclear"

           validation_required:
             - "Test persona consistency"
             - "Validate no regression"
             - "Compare before/after responses"

           rollback_triggers:
             - "Personality fidelity drops >5%"
             - "Core values inconsistency"
             - "Major contradictions introduced"
           ```

        OUTPUT: Backup created, current state documented, plan approved

    # ========================================
    # PHASE 1: INCREMENTAL RESEARCH
    # ========================================
    - agent: analyst
      phase: research
      creates: incremental-sources
      task: research-collection
      task_mode: incremental
      prerequisites:
        - Brownfield plan approved
        - Backup created
        - New sources identified
      outputs:
        - outputs/minds/{slug}/sources/{type}/ (new sources added)
        - outputs/minds/{slug}/sources/sources_master.yaml (updated, not replaced)
      notes: |
        ADD NEW SOURCES WITHOUT REPROCESSING EVERYTHING

        1. ADD NEW SOURCES TO LIBRARY
           - Place new source in appropriate sources/{type}/ directory
           - Do NOT delete or modify existing sources
           - Maintain existing directory structure

        2. UPDATE sources_master.yaml (INCREMENTAL)
           - Append new source entries
           - Do NOT regenerate from scratch
           - Maintain existing source metadata
           - Add "added_date" field for traceability

           Example:
           ```yaml
           sources:
             # ... existing sources preserved ...
             - id: new_interview_2023
               type: interview
               title: "New Interview Title"
               date: "2023-08-15"
               added_to_mind: "2025-10-25"  # Brownfield addition
               priority: high
               reason: "Fills 2015-2018 temporal gap"
           ```

        3. QUICK ANALYSIS (NOT FULL PIPELINE)
           Execute ONLY on new sources:
           - Source reading (new source only)
           - Quote extraction (new source only)
           - Pattern identification (new source only)

           DO NOT re-analyze existing sources.

        4. VALIDATE SOURCE QUALITY
           Before proceeding:
           - Is source high-quality?
           - Does it align with existing architecture?
           - Any contradictions with existing sources?
           - Document compatibility in plan

        OUTPUT: New sources added, inventory updated incrementally

    # ========================================
    # PHASE 2: DIFFERENTIAL ANALYSIS
    # ========================================
    - agent: analyst
      phase: analysis
      creates: differential-analysis
      task: cognitive-analysis
      task_mode: differential
      prerequisites:
        - New sources added
        - Existing artifacts preserved
      outputs:
        - outputs/minds/{slug}/artifacts/NEW_{artifact}.md (temporary)
        - outputs/minds/{slug}/docs/logs/{timestamp}-diff_analysis.yaml
      notes: |
        ANALYZE ONLY NEW SOURCES, THEN MERGE WITH EXISTING

        1. RUN ANALYSIS ON NEW SOURCES ONLY
           - Behavioral patterns (new source)
           - Communication style (new source)
           - Mental models (if new ones found)
           - Values (cross-check against existing)

           Store temporarily as NEW_{artifact}.md

        2. COMPARE NEW VS EXISTING
           ```bash
           diff artifacts/behavioral_patterns.md artifacts/NEW_behavioral_patterns.md
           ```

           Document differences:
           - New patterns discovered
           - Confirmations of existing patterns
           - Contradictions (IMPORTANT!)
           - Gaps filled

        3. CONFLICT RESOLUTION
           If contradictions found:
           - Is it a productive paradox (Layer 8)?
           - Is it temporal evolution (person changed)?
           - Is it source quality issue?
           - Document resolution strategy

        4. INCREMENTAL MERGE
           - Add NEW insights to existing artifacts
           - Mark additions: "Added from [source] on [date]"
           - DO NOT overwrite existing analysis
           - Preserve version history

           Example:
           ```markdown
           ## Behavioral Patterns

           ### Pattern 1: Daily Routine
           [Existing analysis...]

           **UPDATE 2025-10-25** (from Interview 2023):
           New insight: Pattern evolved to include meditation practice.
           ```

        OUTPUT: Differential analysis complete, conflicts resolved

    # ========================================
    # PHASE 3: INCREMENTAL SYNTHESIS
    # ========================================
    - agent: analyst
      phase: synthesis
      creates: incremental-kb
      task: knowledge-base-chunking
      task_mode: incremental
      prerequisites:
        - Differential analysis complete
        - Existing KB preserved
      outputs:
        - outputs/minds/{slug}/kb/chunk_{next_number}.md (new chunks only)
        - outputs/minds/{slug}/artifacts/ (updated frameworks, templates)
      notes: |
        UPDATE KNOWLEDGE BASE WITHOUT RECREATING FROM SCRATCH

        1. CREATE NEW KB CHUNKS ONLY
           - Identify last existing chunk number (e.g., chunk_042.md)
           - Start new chunks at next number (chunk_043.md)
           - Generate chunks ONLY from new sources
           - Maintain 500-1000 word chunk size
           - Use same formatting as existing chunks

        2. UPDATE COMMUNICATION TEMPLATES (IF NEEDED)
           If new source reveals NEW templates:
           - Add to artifacts/communication_templates.md
           - Mark clearly: "Added from [source] on [date]"
           - Do NOT modify existing templates unless incorrect

        3. UPDATE FRAMEWORKS (IF NEEDED)
           If new frameworks discovered:
           - Add to artifacts/frameworks.yaml
           - Document when framework was developed (temporal context)
           - Cross-reference with existing frameworks

        4. UPDATE SIGNATURE PHRASES (IF APPLICABLE)
           New phrases from new sources:
           - Add to artifacts/signature_phrases.md
           - Note frequency and context
           - Avoid duplicating existing phrases

        5. UPDATE KB INDEX (IF EXISTS)
           If kb/index.md exists:
           - Add new chunk references
           - Maintain thematic organization
           - Update chunk count

        OUTPUT: KB extended with new material, synthesis artifacts updated

    # ========================================
    # PHASE 4: CONSISTENCY VALIDATION
    # ========================================
    - agent: qa
      phase: validation
      creates: consistency-check
      task: brownfield-update
      task_mode: consistency_validation
      prerequisites:
        - Incremental synthesis complete
        - Backup available for rollback
      outputs:
        - outputs/minds/{slug}/docs/logs/{timestamp}-consistency_check.yaml
        - outputs/minds/{slug}/docs/logs/{timestamp}-regression_test.md
      human_checkpoint: true
      checkpoint_type: CONSISTENCY_REVIEW
      notes: |
        ENSURE UPDATES DIDN'T BREAK EXISTING QUALITY

        1. CONSISTENCY CHECKS
           Generate consistency_check.yaml:

           ```yaml
           checks:
             - name: "Core values unchanged"
               status: pass | fail | warning
               notes: "Layer 6 values remain consistent"

             - name: "Cognitive architecture compatible"
               status: pass
               notes: "New patterns integrate cleanly"

             - name: "No contradictions introduced"
               status: warning
               notes: "Source X suggests Y, but existing said Z. Resolved as paradox."

             - name: "Temporal consistency maintained"
               status: pass
               notes: "Timeline coherent, evolution documented"

             - name: "Personality fidelity stable"
               status: pass
               notes: "Core identity unchanged by update"
           ```

        2. REGRESSION TESTING
           Critical tests:

           TEST 1: Personality Consistency
           - Use same prompts as previous version
           - Compare responses before/after
           - Acceptable: Minor phrasing changes
           - Unacceptable: Personality shift

           TEST 2: Knowledge Retention
           - Previous factual knowledge still accurate?
           - No information lost from update?
           - New knowledge additive, not replacing?

           TEST 3: Edge Cases
           - Re-test documented edge cases
           - Ensure behavior still correct
           - Document any changes

        3. FIDELITY COMPARISON
           Compare before/after:
           - Personality fidelity (should be stable or improved)
           - Knowledge accuracy (should improve or stay same)
           - Style consistency (should be stable)

           ROLLBACK TRIGGERS:
           - Personality fidelity drops >5%
           - Core values inconsistent
           - Major contradictions unresolved
           - Knowledge regression detected

        4. DOCUMENT REGRESSION TEST RESULTS
           Create regression_test.md:

           ```markdown
           # Regression Test - v1.1 → v1.2

           ## Test 1: Personality Consistency
           **Prompt:** "How do you approach decision-making?"
           **v1.1 Response:** [preserved]
           **v1.2 Response:** [new]
           **Status:** ✅ Consistent | ⚠️ Slight Change | ❌ Regression
           **Notes:** Slight elaboration added, core approach unchanged

           ## Test 2: Knowledge Retention
           [...]
           ```

        HUMAN CHECKPOINT: Consistency Review
        - Review all consistency checks
        - Examine regression test results
        - Decision: APPROVE | REVISE | ROLLBACK

        If APPROVE: Proceed to system prompt update
        If REVISE: Fix specific issues, re-test
        If ROLLBACK: Restore backup, document failure reasons

    # ========================================
    # PHASE 5: SELECTIVE PROMPT UPDATE
    # ========================================
    - agent: architect
      phase: implementation
      creates: prompt-update-decision
      task: system-prompt-creation
      task_mode: incremental
      prerequisites:
        - Consistency validation passed
        - Changes documented
      outputs:
        - outputs/minds/{slug}/system_prompts/{timestamp}-v{X.Y}-generalista.md (if updated)
        - outputs/minds/{slug}/docs/logs/{timestamp}-prompt_changelog.md
      human_checkpoint: true
      checkpoint_type: PROMPT_UPDATE_DECISION
      notes: |
        UPDATE SYSTEM PROMPT ONLY IF NECESSARY

        1. DECIDE: UPDATE OR NOT?

           UPDATE SYSTEM PROMPT IF:
           ✅ New source changed core obsession (Layer 7)
           ✅ Discovered new critical mental model (Layer 5)
           ✅ Fixed significant error in architecture (Layer 8)
           ✅ Filled major gap in values hierarchy (Layer 6)
           ✅ Corrected behavioral pattern misrepresentation

           DO NOT UPDATE IF:
           ❌ Only added examples/citations (goes to KB only)
           ❌ Change is superficial/stylistic
           ❌ New source confirms existing architecture
           ❌ Update is purely additive to KB

        2. IF UPDATE NEEDED: INCREMENTAL EDIT

           DO NOT regenerate prompt from scratch!

           Process:
           a) Copy current version to new version file
           b) Edit specific sections that changed
           c) Add CHANGELOG section at top
           d) Increment version number

           Example CHANGELOG:
           ```markdown
           ## CHANGELOG

           ### v1.2 - 2025-10-25
           - Added: Recognition pattern "systems thinking" from Interview 2023
           - Updated: Core obsession #2 intensity (7→9) based on new evidence
           - Fixed: Contradiction in decision criteria (resolved as paradox)
           - KB: Extended with 12 new chunks (043-054)

           ### v1.1 - 2025-09-28
           [Previous changes...]
           ```

        3. VERSION MANAGEMENT
           - Previous: {timestamp}-v1.1-generalista.md (PRESERVED)
           - New: {timestamp}-v1.2-generalista.md
           - Keep all previous versions for rollback
           - Update metadata with version history

        4. SPECIALIST PROMPTS (IF APPLICABLE)
           If specialists exist:
           - Decide if they need updates
           - Update only affected specialists
           - Maintain version parity or document divergence

        HUMAN CHECKPOINT: Prompt Update Decision
        - Review proposed changes
        - Approve version increment
        - Decision: APPROVE | REVISE | SKIP_UPDATE

        OUTPUT: System prompt updated (if needed), versioned, changelog complete

    # ========================================
    # PHASE 6: DOCUMENTATION UPDATE
    # ========================================
    - agent: pm
      phase: documentation
      creates: doc-sync
      task: brownfield-update
      task_mode: documentation
      prerequisites:
        - All updates complete
        - Testing passed
      outputs:
        - outputs/minds/{slug}/docs/README.md (updated)
        - outputs/minds/{slug}/docs/LIMITATIONS.md (updated)
        - outputs/minds/{slug}/docs/TODO.md (updated)
        - outputs/minds/{slug}/docs/logs/{timestamp}-brownfield_complete.md
      notes: |
        SYNC DOCUMENTATION WITH CHANGES

        1. UPDATE README.md
           - Update "Last Update" timestamp
           - Add note about brownfield update
           - Update version references
           - Document new sources added

        2. UPDATE LIMITATIONS.md
           - Remove gaps that were filled
           - Add newly discovered gaps (if any)
           - Update temporal coverage notes
           - Maintain honesty about constraints

        3. UPDATE TODO.md
           - Mark completed items
           - Add new action items discovered
           - Prioritize remaining work
           - Document follow-up updates needed

        4. CREATE BROWNFIELD COMPLETION LOG
           Generate brownfield_complete.md:

           ```markdown
           # Brownfield Update Complete

           ## Update Summary
           - **Reason:** [Why this update]
           - **Duration:** [Time spent]
           - **Scope:** Incremental update

           ## What Changed
           - Sources: +2 interviews (filled 2015-2018 gap)
           - KB: +12 chunks (total: 54)
           - Artifacts: behavioral_patterns.md updated
           - System Prompt: v1.1 → v1.2 (added pattern X, fixed contradiction Y)

           ## Tests Passed
           - ✅ Personality consistency maintained
           - ✅ Knowledge retention verified
           - ✅ No regressions detected
           - ✅ Fidelity: 94% → 96% (+2% improvement)

           ## Remaining Gaps
           - Topic gap: Early career (pre-2010) still sparse
           - Format gap: Video content not yet analyzed

           ## Rollback Info
           - Backup: outputs/minds/{slug}/.backup-{timestamp}/
           - Previous version: v1.1 (2025-09-28)
           - Rollback tested: Yes
           ```

        5. UPDATE METADATA
           If metadata.yaml exists:
           - Increment version
           - Update last_modified
           - Add update_history entry

        OUTPUT: All documentation synchronized with changes

    # ========================================
    # PHASE 7: FINAL HUMAN CHECKPOINT
    # ========================================
    - agent: pm
      phase: approval
      creates: brownfield-approval
      task: brownfield-update
      task_mode: final_approval
      prerequisites:
        - All updates complete
        - All tests passed
        - Documentation updated
      outputs:
        - outputs/minds/{slug}/docs/logs/{timestamp}-brownfield_approval.yaml
      human_checkpoint: true
      checkpoint_type: PRODUCTION_APPROVAL
      notes: |
        FINAL DECISION BEFORE PRODUCTION DEPLOYMENT

        Present brownfield update summary:

        ```markdown
        ## BROWNFIELD UPDATE FINAL REVIEW

        ### Update Scope
        - Type: Incremental
        - Impact: Medium
        - Sources Added: 2
        - KB Chunks Added: 12
        - System Prompt: v1.1 → v1.2

        ### Quality Metrics
        - Personality Fidelity: 94% → 96% (+2%)
        - Knowledge Accuracy: 92% → 95% (+3%)
        - Consistency Tests: All passed ✅
        - Regression Tests: No regressions ✅

        ### Changes Summary
        - Filled temporal gap: 2015-2018
        - Added recognition pattern: "systems thinking"
        - Updated core obsession #2 intensity
        - Resolved contradiction as productive paradox

        ### Rollback Available
        - Backup: .backup-{timestamp}/
        - Tested: Yes
        - Restore time: <5 minutes

        ---

        APPROVAL DECISION:

        1. APPROVED - Deploy new version to production
        2. REVISE - Address specific issues before deploy
        3. ROLLBACK - Restore previous version, document failure
        ```

        APPROVAL CRITERIA:
        - ✅ All tests passed
        - ✅ No regressions detected
        - ✅ Consistency maintained
        - ✅ Fidelity stable or improved
        - ✅ Documentation complete
        - ✅ Rollback available and tested

        User decision:
        1. APPROVED → Clean up backup, deploy v1.2
        2. REVISE → Fix issues, re-test, re-present
        3. ROLLBACK → Restore backup, document lessons learned

        IF APPROVED:
        - Move backup to archive (keep for 30 days)
        - Update production references
        - Notify stakeholders of new version

        IF ROLLBACK:
        - Restore from backup
        - Document failure reasons
        - Re-plan approach
        - Update TODO.md with learnings

        OUTPUT: Final approval documented, production decision executed

  # ========================================
  # BROWNFIELD-SPECIFIC RULES
  # ========================================
  rules:
    mandatory:
      - "ALWAYS create complete backup before ANY changes"
      - "NEVER overwrite artifacts without backup"
      - "ALWAYS run regression tests"
      - "NEVER regenerate from scratch (incremental only)"
      - "ALWAYS document what changed and why"
      - "NEVER deploy without human approval"

    best_practices:
      - "Read existing docs thoroughly before changing"
      - "Merge incrementally, preserve history"
      - "Version everything (prompts, artifacts)"
      - "Test before/after comparisons"
      - "Document rollback triggers clearly"
      - "Keep previous versions for 30+ days"

    rollback_triggers:
      - "Personality fidelity drops >5%"
      - "Core values become inconsistent"
      - "Major unresolved contradictions"
      - "Knowledge regression detected"
      - "Tests fail repeatedly"
      - "Architectural integrity compromised"

  # ========================================
  # COMPARISON: BROWNFIELD VS GREENFIELD
  # ========================================
  comparison:
    time:
      greenfield: "8-12 days"
      brownfield: "2-5 days (60-75% faster)"

    scope:
      greenfield: "Complete pipeline"
      brownfield: "Selective steps only"

    risk:
      greenfield: "Low (clean start)"
      brownfield: "Medium (may break existing)"

    testing:
      greenfield: "Initial validation"
      brownfield: "Regression + new validation"

    documentation:
      greenfield: "Create from scratch"
      brownfield: "Incremental merge"

    backup:
      greenfield: "Not required"
      brownfield: "MANDATORY"

    rollback:
      greenfield: "N/A (nothing to restore)"
      brownfield: "Always available and tested"

  # ========================================
  # VALIDATION CRITERIA
  # ========================================
  validation:
    success_criteria:
      - Backup created before any changes
      - Brownfield plan documented and approved
      - New sources quality validated
      - Differential analysis complete
      - Consistency checks all passed
      - Regression tests all passed
      - Fidelity stable or improved
      - Documentation updated and synchronized
      - Rollback tested and available
      - Human final approval received

  # ========================================
  # NOTES
  # ========================================
  notes: |
    BROWNFIELD PHILOSOPHY:
    "Preserve what works. Improve incrementally. Test obsessively. Document everything."

    KEY INSIGHTS:
    - 60-75% faster than greenfield when updating existing minds
    - Lower token cost (500K-1M vs 2-3M)
    - Higher risk (can break existing quality)
    - Requires discipline (no shortcuts on backups/testing)
    - Version management is critical
    - Rollback capability is non-negotiable

    COMMON MISTAKES TO AVOID:
    - ❌ Reprocessing everything from scratch (defeats purpose of brownfield)
    - ❌ Ignoring regression tests (leads to broken deployments)
    - ❌ Overwriting without backup (no recovery path)
    - ❌ Skipping documentation updates (docs become stale)
    - ❌ Deploying without human review (risky changes)

    WHEN TO USE BROWNFIELD:
    - Adding new source to existing mind
    - Filling identified gap (temporal, topical)
    - Fixing architectural inconsistency
    - Refining based on user feedback
    - Adding specialist variant
    - Updating knowledge base

    WHEN NOT TO USE BROWNFIELD:
    - Creating mind for different person (use greenfield)
    - Changes so extensive that starting over is cleaner
    - Existing mind is low quality (better to rebuild)

    WORKFLOW VERSION: 3.0 (DNA Mental™ Brownfield Methodology)
    LAST UPDATED: 2025-10-25

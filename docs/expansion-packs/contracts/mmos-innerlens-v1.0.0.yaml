# MMOS → InnerLens Integration Contract
# MMOS orquestra InnerLens para análise psicométrica no processo de clonagem
# Version: 1.0.0
# Status: Stable
# Last Updated: 2025-10-27

metadata:
  contract_name: "mmos-innerlens"
  version: "1.0.0"
  status: "stable"
  created_at: "2025-10-27"
  updated_at: "2025-10-27"

orchestrator:
  pack: "MMOS Mind Mapper"
  version: "3.0"
  role: "Orquestrador do processo de clonagem cognitiva"
  pipeline: "Cognitive Clone Creation"

service:
  pack: "InnerLens"
  version: "1.1.0"
  role: "Serviço de análise psicométrica e extração de fragmentos"
  provides: "MIU fragments + Big Five personality analysis"

---

# INTEGRATION OVERVIEW

purpose: |
  MMOS Mind Mapper orquestra InnerLens durante o processo de clonagem cognitiva.
  Após ETL coletar fontes (Phase 1), MMOS invoca InnerLens para extrair fragmentos
  comportamentais (MIUs) e realizar análise psicométrica (Big Five), enriquecendo
  o clone com camada de personalidade (+2-3% fidelidade).

orchestration_context: |
  Pipeline de Clonagem MMOS:

  Phase 2: Analysis (MMOS orquestra InnerLens)
    → MMOS detecta: fontes coletadas em sources/downloads/
    → MMOS invoca: InnerLens.analyze(slug, sources_path)
    → InnerLens executa:
        1. Extração de MIU fragments (framework-agnostic)
        2. Validação de qualidade (quality gate)
        3. Save to database (sources, fragments tables)
        4. Análise Big Five (personality profiling)
        5. Save to database (big_five_profiles table)
    → InnerLens retorna: fragments saved, Big Five profile
    → MMOS prossegue: Phase 3 (Synthesis) com personality layer

integration_type: "orchestrated-service"
call_direction: "MMOS calls InnerLens"
optional: true  # MMOS funciona sem InnerLens (94% fidelity vs 96-97% com)

---

# INTERFACE SPECIFICATION

## How MMOS Invokes InnerLens

### Method 1: Internal Workflow (Current)
```yaml
# MMOS detecta fontes prontas durante Phase 2
@mind-mapper *map naval_ravikant

# Internamente, MMOS:
workflow:
  phase_1_complete: true
  sources_available: "outputs/minds/naval_ravikant/sources/"

  invoke_innerlens:
    slug: "naval_ravikant"
    sources_path: "outputs/minds/naval_ravikant/sources/downloads/"
    run_analysis: true  # Extract + Analyze
```

### Method 2: Explicit CLI Call
```bash
# Usuario pode forçar análise explícita
@mind-mapper *analyze-personality naval_ravikant

# MMOS delega para InnerLens
```

### Method 3: Python API (Programmatic)
```python
from mmos.lib import MindMapper
from innerlens.lib import PersonalityAnalyzer

mapper = MindMapper()
analyzer = PersonalityAnalyzer()

# MMOS orquestra
result = mapper.analyze_personality(
    slug="naval_ravikant",
    analyzer=analyzer,
    sources_path="outputs/minds/naval_ravikant/sources/downloads/"
)
```

---

# REQUEST CONTRACT

## Input: MMOS → InnerLens

**MMOS provides:**
```yaml
request:
  slug: "naval_ravikant"  # Mind identifier

  sources_specification:
    sources_path: "outputs/minds/naval_ravikant/sources/downloads/"
    source_types: ["podcasts", "articles", "videos"]  # Filter by type

    # Optional: specific sources
    source_files:
      - "podcasts/podcast_lex-fridman-ep-123_20230415.md"
      - "articles/article_how-to-build-wealth_20230220.md"

  analysis_config:
    extract_fragments: true  # Extract MIUs
    run_bigfive: true        # Run Big Five analysis
    quality_gate: "blocking" # Block on low quality
    min_fragments: 10        # Minimum MIUs required

    save_to_database: true   # Save fragments + profile to DB
    fallback_yaml: false     # Don't create YAML files (deprecated)
```

---

# RESPONSE CONTRACT

## Output: InnerLens → MMOS

**InnerLens returns:**
```yaml
result:
  status: "completed | validated_medium | validation_failed"

  extraction_summary:
    fragments_extracted: 42
    fragments_validated: 42
    validation_outcome: "VALIDATED_HIGH"  # Quality gate result
    quality_score: "HIGH"

  analysis_summary:
    framework: "Big Five (OCEAN)"
    traits_analyzed: 5
    overall_confidence: 0.85
    evidence_count: 42  # MIUs used for analysis

  database_entries:
    mind_id: 1
    source_id: 15
    fragments_saved: 42
    profile_saved: true

    tables_updated:
      - "sources" (1 row)
      - "fragments" (42 rows)
      - "big_five_profiles" (1 row)

  personality_profile:
    openness: 85
    conscientiousness: 68
    extraversion: 45
    agreeableness: 35
    neuroticism: 25
    overall_confidence: 0.85

  next_phase_ready: true  # MMOS pode prosseguir para Phase 3
  fidelity_boost: "+2-3%"  # Expected fidelity improvement
```

---

# DATABASE CONTRACT

## Tables Written by InnerLens

### 1. sources table
```sql
INSERT INTO sources (
  source_id, mind_id, title, file_path, type,
  clean_content, word_count, char_count,
  status, processed_at, tier, priority_score
) VALUES (
  'naval_ravikant_podcast_20251027',
  1,  -- mind_id
  'Lex Fridman Podcast #123',
  'outputs/minds/naval_ravikant/sources/downloads/podcasts/podcast_lex-fridman-ep-123_20230415.md',
  'podcast_transcript',
  '<cleaned text content>',
  12500, 75000,
  'extracted', '2025-10-27T14:30:00Z',
  1, 1.0
);
```

### 2. fragments table (MIU storage)
```sql
INSERT INTO fragments (
  id, mind_id, source_id,
  fragment_type, content,
  cognitive_theme, layer, domains,
  confidence, why_significant, evidence_type,
  extraction_method, pipeline_version,
  created_at
) VALUES (
  'f_naval_001',
  1,  -- mind_id
  15, -- source_id
  'written_thought',
  '{"verbatim": "I think the biggest mistake...", "word_count": 16, ...}',
  'extracted_miu',
  NULL,  -- MMOS assigns layer later
  '["cognitive", "linguistic"]',
  1.0,
  'MIU extracted from InnerLens for personality profiling',
  'explicit_statement',
  'llm_claude_sonnet_4', 'innerlens_v1.1',
  '2025-10-27T14:30:00Z'
);
```

### 3. big_five_profiles table
```sql
INSERT INTO big_five_profiles (
  mind_id, source_id,
  openness, conscientiousness, extraversion, agreeableness, neuroticism,
  overall_confidence, evidence_count,
  analysis_timestamp, framework_version
) VALUES (
  1,  -- mind_id
  15, -- source_id
  85, 68, 45, 35, 25,  -- Big Five scores
  0.85, 42,  -- confidence, evidence count
  '2025-10-27T14:30:00Z', 'big_five_v1.0'
);
```

---

# MMOS CONSUMPTION

## How MMOS Reads InnerLens Data

### During Phase 3: Synthesis

**Read Fragments:**
```python
# MMOS queries fragments for synthesis
cursor.execute("""
    SELECT id, content, raw_excerpt
    FROM fragments
    WHERE mind_id = ? AND pipeline_version LIKE 'innerlens%'
    ORDER BY created_at DESC
""", (mind_id,))

fragments = cursor.fetchall()

# Parse content JSON
for fragment in fragments:
    content = json.loads(fragment['content'])
    verbatim = content['verbatim']
    # Use for DNA Mental Layer analysis...
```

**Read Big Five Profile:**
```python
# MMOS queries latest Big Five profile
cursor.execute("""
    SELECT openness, conscientiousness, extraversion, agreeableness, neuroticism,
           overall_confidence, evidence_count
    FROM big_five_profiles
    WHERE mind_id = ?
    ORDER BY analysis_timestamp DESC
    LIMIT 1
""", (mind_id,))

profile = cursor.fetchone()

if profile:
    # Integrate personality into system prompt
    synthesis['personality_layer'] = {
        'big_five': profile,
        'source': 'innerlens_v1.1'
    }
```

---

# VALIDATION

## InnerLens Responsibilities (Service Provider)

**MUST guarantee:**
1. All fragments have valid JSON in `content` field
2. Fragments validated via quality gate BEFORE database save
3. Big Five scores in 0-100 range
4. Confidence scores in 0.0-1.0 range
5. Minimum 10 MIU fragments (quality gate)

**Quality Gate Enforcement:**
```python
if validation_outcome == "VALIDATION_FAILED":
    # BLOCK database save
    raise ValidationError("Quality gate failed: <10 MIUs")
    # Transaction rolled back
else:
    # ALLOW database save
    commit_transaction()
```

**MUST handle:**
1. Insufficient text (< 500 words) - warn, attempt extraction
2. Low-quality fragments - filter out, keep only validated
3. Database connection failures - retry, fallback to error
4. Multiple analyses on same mind - create new rows, don't update

## MMOS Responsibilities (Orchestrator)

**MUST handle:**
1. InnerLens returning "validation_failed" (warn user, proceed without personality layer)
2. Missing Big Five profile (proceed with 94% fidelity instead of 96-97%)
3. Empty fragments table (warn, suggest re-running InnerLens)
4. Database read errors (fallback to YAML if exists, deprecated)

**MUST verify:**
1. Database connection successful
2. Fragments exist for this mind
3. Big Five profile exists
4. Quality scores meet minimum threshold

**SHOULD do:**
1. Log InnerLens invocation (duration, fragments extracted, quality outcome)
2. Store personality layer metadata in mind metadata.yaml
3. Calculate fidelity boost from personality integration
4. Provide clear feedback to user about personality layer

---

# ERROR SCENARIOS

## Scenario 1: Quality Gate Failure

**InnerLens behavior:**
```yaml
status: "validation_failed"
reason: "Only 7 MIUs extracted (minimum 10 required)"
fragments_extracted: 7
quality_gate: "BLOCKING"
```

**MMOS decision:**
```python
warn_user("InnerLens quality gate failed: insufficient fragments")
options:
  - proceed_without_personality_layer()  # 94% fidelity
  - collect_more_sources()               # More text needed
  - manual_intervention()
```

## Scenario 2: Database Save Failed

**InnerLens behavior:**
```yaml
status: "failed"
reason: "Database connection error"
fragments_extracted: 42
database_saved: false
```

**MMOS decision:**
```python
error("InnerLens failed to save to database")
options:
  - retry_innerlens()
  - skip_personality_layer()  # Proceed without InnerLens
```

## Scenario 3: Incremental Analysis

**Context:** Mind already analyzed, user adds new sources

**MMOS invocation:**
```python
result = mapper.analyze_personality(
    slug="naval_ravikant",
    sources_path="outputs/minds/naval_ravikant/sources/downloads/",
    incremental=True  # Analyze only NEW sources
)
```

**InnerLens behavior:**
```yaml
status: "completed"
existing_fragments: 42
new_fragments: 15
total_fragments: 57
profile_updated: true  # Re-analyzed with ALL 57 fragments
```

---

# VERSIONING

## Semantic Versioning

**Current version:** 1.0.0

**MAJOR (breaking):**
- Change fragments table schema
- Change Big Five score range
- Remove backward compatibility

**MINOR (compatible):**
- Add new psychometric frameworks (HEXACO, VIA)
- Add optional fields to tables
- Add new quality gate options

**PATCH (fixes):**
- Bug fixes in validation
- Performance improvements
- Documentation updates

---

# TESTING

## Integration Test

**End-to-end test:**
```bash
# 1. MMOS invokes InnerLens (after ETL complete)
@mind-mapper *map test_person_greenfield

# 2. Verify InnerLens saved to database
sqlite3 outputs/database/mmos.db <<EOF
SELECT COUNT(*) FROM fragments WHERE mind_id = (SELECT id FROM minds WHERE slug = 'test_person_greenfield');
SELECT * FROM big_five_profiles WHERE mind_id = (SELECT id FROM minds WHERE slug = 'test_person_greenfield');
EOF

# 3. Verify MMOS received personality data
cat outputs/minds/test_person_greenfield/metadata.yaml
# Should show: personality_layer: innerlens_v1.1, fidelity_target: 96-97%
```

---

# EXAMPLES

## Example 1: First Analysis

```yaml
# MMOS invokes InnerLens
result = analyze_personality("naval_ravikant")

# InnerLens:
#   - Extracts 42 MIUs
#   - Validates (VALIDATED_HIGH)
#   - Saves to database
#   - Analyzes Big Five
# Returns:
status: "completed"
fragments_saved: 42
profile_saved: true
fidelity_boost: "+3%"

# MMOS proceeds to Phase 3 with personality layer
```

## Example 2: Incremental Update

```yaml
# Mind has 42 fragments, user adds new sources
# MMOS invokes InnerLens incrementally

# InnerLens:
#   - Finds 42 existing fragments
#   - Extracts 15 new fragments
#   - Re-analyzes Big Five with ALL 57
# Returns:
new_fragments: 15
total_fragments: 57
profile_updated: true
```

---

# RELATED CONTRACTS

- `mmos-etl-v1.0.0.yaml` - MMOS orquestra ETL (Phase 1)
- `creator-os-innerlens-v1.0.0.yaml` - CreatorOS consulta fragmentos (RAG)

---

# CONTACTS

**Contract Maintainer:** Alan Nicolas (alan@academialendaria.ai)
**MMOS Orchestrator Owner:** MMOS Team
**InnerLens Service Owner:** InnerLens Team
**Database Owner:** DB Sage (SuperAgentes)

---

# CHANGELOG

## v1.0.0 (2025-10-27)
- Initial contract - MMOS orquestra InnerLens
- Database-first integration
- Quality gate enforcement
- Request/response schemas
- Error handling scenarios

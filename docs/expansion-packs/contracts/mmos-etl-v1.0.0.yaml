# MMOS → ETL Integration Contract
# MMOS orquestra ETL para coletar fontes no processo de clonagem
# Version: 1.0.0
# Status: Stable
# Last Updated: 2025-10-27

metadata:
  contract_name: "mmos-etl"
  version: "1.0.0"
  status: "stable"
  created_at: "2025-10-27"
  updated_at: "2025-10-27"

orchestrator:
  pack: "MMOS Mind Mapper"
  version: "3.0"
  role: "Orquestrador do processo de clonagem cognitiva"
  pipeline: "Cognitive Clone Creation"

service:
  pack: "ETL Data Collector"
  version: "1.0.0"
  role: "Serviço de coleta de fontes"
  provides: "Source material collection and preprocessing"

---

# INTEGRATION OVERVIEW

purpose: |
  MMOS Mind Mapper orquestra ETL Data Collector durante o processo de clonagem
  cognitiva. MMOS detecta quando precisa de fontes e invoca ETL para coletar,
  limpar e organizar materiais de múltiplas origens (web, arquivos, APIs).

orchestration_context: |
  Pipeline de Clonagem MMOS:

  Phase 1: Research & Collection (MMOS orquestra ETL)
    → MMOS detecta: mind {slug} precisa de fontes
    → MMOS invoca: ETL.collect_sources(slug, sources_spec)
    → ETL executa: coleta, limpeza, organização
    → ETL retorna: fontes em outputs/minds/{slug}/sources/
    → MMOS prossegue: Phase 2 (Analysis)

integration_type: "orchestrated-service"
call_direction: "MMOS calls ETL"
optional: false  # MMOS não pode criar clone sem fontes

---

# INTERFACE SPECIFICATION

## How MMOS Invokes ETL

### Method 1: Internal Workflow (Current)
```yaml
# MMOS detecta necessidade de fontes durante *map
@mind-mapper *map naval_ravikant

# Internamente, MMOS:
workflow:
  - detect_sources_needed: true
  - invoke_etl:
      slug: "naval_ravikant"
      sources_spec: "sources.yaml or auto-detect"
      mode: "greenfield or brownfield"
```

### Method 2: Explicit CLI Call
```bash
# Usuario pode forçar coleta explícita
@mind-mapper *collect-sources naval_ravikant

# MMOS delega para ETL
```

### Method 3: Python API (Programmatic)
```python
from mmos.lib import MindMapper
from etl.lib import SourceCollector

mapper = MindMapper()
collector = SourceCollector()

# MMOS orquestra
result = mapper.collect_sources(
    slug="naval_ravikant",
    collector=collector,
    sources_spec="sources.yaml"
)
```

---

# REQUEST CONTRACT

## Input: MMOS → ETL

**MMOS provides:**
```yaml
request:
  slug: "naval_ravikant"  # Mind identifier

  sources_specification:
    # Option A: Explicit source list (greenfield)
    sources:
      - type: "youtube"
        url: "https://youtube.com/..."
        priority: 1

      - type: "article"
        url: "https://blog.com/..."
        priority: 2

    # Option B: Auto-detect (public figures)
    auto_detect: true
    search_queries:
      - "Naval Ravikant startups"
      - "Naval Ravikant wealth"

  collection_mode:
    type: "greenfield | brownfield"
    existing_sources_path: "outputs/minds/{slug}/sources/"  # If brownfield

  collection_config:
    max_sources: 50
    min_words_per_source: 200
    encoding: "utf-8"
    formats: ["md", "txt", "pdf"]
```

---

# RESPONSE CONTRACT

## Output: ETL → MMOS

**ETL returns:**
```yaml
result:
  status: "completed | partial | failed"

  collection_summary:
    total_sources_collected: 47
    total_words: 156000
    total_size_mb: 2.3
    encoding: "utf-8"

    sources_by_type:
      podcasts: 15
      articles: 20
      videos: 8
      books: 4

    failed_sources: 3
    failed_reasons:
      - url: "https://example.com/404"
        reason: "404 Not Found"

  output_location:
    base_path: "outputs/minds/naval_ravikant/sources/"
    downloads_path: "outputs/minds/naval_ravikant/sources/downloads/"
    metadata_file: "outputs/minds/naval_ravikant/sources/COLLECTION_SUMMARY.yaml"

  next_phase_ready: true  # MMOS pode prosseguir para Phase 2
```

---

# FILE OUTPUTS

## Directory Structure

ETL creates:
```
outputs/minds/{slug}/
└── sources/
    ├── downloads/              # Fontes coletadas
    │   ├── podcasts/
    │   ├── articles/
    │   ├── videos/
    │   ├── books/
    │   ├── interviews/
    │   └── social/
    │
    ├── COLLECTION_SUMMARY.yaml # Metadata da coleta
    └── README.md               # Human-readable summary
```

## File Formats

**Text files (primary):**
- `.md` - Markdown (preferred)
- `.txt` - Plain text

**Supported:**
- `.pdf` - PDFs
- `.html` - HTML (stripped to text)
- `.json` - Structured transcripts

## File Naming Convention

**Format:** `{source_type}_{identifier}_{date}.{ext}`

**Examples:**
```
podcast_lex-fridman-ep-123_20230415.md
article_how-to-build-wealth_20230220.md
video_youtube-startup-advice_20230510.md
```

## COLLECTION_SUMMARY.yaml Schema

```yaml
collection:
  mind_slug: "naval_ravikant"
  collected_by: "ETL Data Collector v1.0.0"
  collected_at: "2025-10-27T14:30:00Z"
  orchestrated_by: "MMOS Mind Mapper v3.0"
  total_sources: 47
  total_words: 156000
  total_size_mb: 2.3
  encoding: "utf-8"
  status: "completed | partial | failed"

sources:
  - file_path: "downloads/podcasts/podcast_lex-fridman-ep-123_20230415.md"
    source_type: "podcast"
    source_url: "https://youtube.com/..."
    word_count: 12500
    char_count: 75000
    collected_at: "2025-10-27T14:00:00Z"
    status: "collected"

failed_sources:
  - url: "https://example.com/unavailable"
    reason: "404 Not Found"
    attempted_at: "2025-10-27T12:00:00Z"

collection_stats:
  by_type:
    podcasts: 15
    articles: 20
    videos: 8
    books: 4

  by_status:
    collected: 47
    failed: 3
```

---

# VALIDATION

## ETL Responsibilities (Service Provider)

**MUST guarantee:**
1. All collected files are valid UTF-8
2. All files have ≥200 words
3. File names follow naming convention
4. COLLECTION_SUMMARY.yaml is valid YAML
5. No duplicate filenames
6. Return accurate status (completed/partial/failed)

**MUST handle:**
1. Network failures (retry with backoff)
2. Rate limiting (respect API limits)
3. Encoding issues (convert to UTF-8)
4. Large files (chunk if >10MB)
5. Partial failures (continue with successful sources)

**SHOULD provide:**
1. Progress updates during collection
2. Estimated time remaining
3. Source quality scores
4. Duplicate detection

## MMOS Responsibilities (Orchestrator)

**MUST handle:**
1. ETL returning "partial" status (warn user, continue or abort)
2. ETL returning "failed" status (report error, offer retry)
3. Insufficient sources collected (< 10,000 words minimum)
4. Missing COLLECTION_SUMMARY.yaml (attempt recovery or fail)

**MUST verify:**
1. Output directory exists and is readable
2. Minimum source quality threshold met
3. Encoding is UTF-8
4. Files are not empty

**SHOULD do:**
1. Log ETL invocation (duration, success rate, sources collected)
2. Cache collection results (avoid re-collecting in brownfield)
3. Provide clear error messages to user
4. Offer retry or manual intervention options

---

# ERROR SCENARIOS

## Scenario 1: Partial Collection

**ETL behavior:**
```yaml
status: "partial"
total_sources: 45
failed_sources: 5
reason: "Network timeouts, rate limiting"
```

**MMOS decision:**
```python
if result.total_words >= 10000:  # Minimum threshold
    warn_user("5 sources failed, but 45 collected (156K words)")
    proceed_to_phase_2()
else:
    error("Insufficient sources (only 3K words collected)")
    offer_retry()
```

## Scenario 2: Complete Failure

**ETL behavior:**
```yaml
status: "failed"
reason: "No internet connection"
failed_sources: 50
```

**MMOS decision:**
```python
error("ETL collection failed: No internet connection")
options:
  - retry_later()
  - use_manual_sources()  # User provides files manually
  - abort_pipeline()
```

## Scenario 3: Brownfield Update

**Context:** Mind already has 30 sources, user wants to add more

**MMOS invocation:**
```python
result = mapper.collect_sources(
    slug="naval_ravikant",
    mode="brownfield",
    incremental=True  # Only collect NEW sources
)
```

**ETL behavior:**
```yaml
status: "completed"
existing_sources: 30
new_sources: 15
total: 45
skipped_duplicates: 5
```

---

# VERSIONING

## Semantic Versioning

**Current version:** 1.0.0

**MAJOR (breaking):**
- Change directory structure (e.g., rename downloads/)
- Change COLLECTION_SUMMARY.yaml required fields
- Change minimum source requirements

**MINOR (compatible):**
- Add optional fields to COLLECTION_SUMMARY.yaml
- Add new source types
- Add new file formats

**PATCH (fixes):**
- Documentation updates
- Bug fixes in validation
- Performance improvements

---

# TESTING

## Integration Test

**End-to-end test:**
```bash
# 1. MMOS invokes ETL
@mind-mapper *map test_person_greenfield

# 2. Verify ETL created outputs
ls outputs/minds/test_person_greenfield/sources/downloads/
cat outputs/minds/test_person_greenfield/sources/COLLECTION_SUMMARY.yaml

# 3. Verify MMOS received result
cat outputs/minds/test_person_greenfield/metadata.yaml
# Should show: phase="research_collection", status="complete"
```

## Test Checklist

**ETL (service):**
- [ ] Collects sources successfully
- [ ] Creates correct directory structure
- [ ] Generates valid COLLECTION_SUMMARY.yaml
- [ ] Returns accurate status
- [ ] Handles partial failures gracefully

**MMOS (orchestrator):**
- [ ] Invokes ETL correctly
- [ ] Receives ETL response
- [ ] Validates outputs
- [ ] Proceeds to Phase 2 on success
- [ ] Handles errors appropriately

---

# EXAMPLES

## Example 1: Greenfield Success

```yaml
# MMOS invocation
@mind-mapper *map naval_ravikant

# ETL collects 47 sources
# Returns:
status: "completed"
total_sources: 47
total_words: 156000

# MMOS proceeds
phase: "analysis" (Phase 2)
```

## Example 2: Brownfield Incremental

```yaml
# Existing mind has 30 sources
# MMOS invokes ETL for update

# ETL:
#   - Detects 30 existing sources
#   - Collects 15 new sources
#   - Skips 5 duplicates
# Returns:
status: "completed"
new_sources: 15
total: 45

# MMOS updates metadata
sources_version: "v2"
last_updated: "2025-10-27"
```

---

# RELATED CONTRACTS

- `mmos-innerlens-v1.0.0.yaml` - MMOS orquestra InnerLens (Phase 2)
- `creator-os-mmos-v1.0.0.yaml` - CreatorOS solicita MMOS criar professor

---

# CONTACTS

**Contract Maintainer:** Alan Nicolas (alan@academialendaria.ai)
**MMOS Orchestrator Owner:** MMOS Team
**ETL Service Owner:** ETL Team
**Last Reviewed:** 2025-10-27
**Next Review:** 2026-01-27

---

# CHANGELOG

## v1.0.0 (2025-10-27)
- Initial contract - MMOS orquestra ETL
- Request/response schemas defined
- File output specifications
- Error handling scenarios
- MMOS orchestrator responsibilities
- ETL service provider responsibilities

# 3.4 - Merge + Conflitos

**Duração:** 15 min | **Nível:** Iniciante

## Objetivo

Fazer merge de branches com confiança e resolver conflitos sem pânico, mantendo histórico limpo e código funcional.

## Por que isso importa

Conflitos são inevitáveis quando várias pessoas trabalham no mesmo projeto. Saber resolver conflitos sem quebrar código é habilidade essencial. Conflito não é erro, é situação normal em colaboração que você precisa dominar.

## Conteúdo

### O Que É Merge?

**Merge:** Integrar mudanças de uma branch em outra.

```
main:     A---B---C---M (M = commit de merge)
               \       /
feature:        D-----E
```

**Commit de merge (M):** Junta histórico de ambas branches.

### Quando Merge Acontece

1. **Pull Request aprovado:** GitHub faz merge de feature → main
2. **Sincronizar branch:** Você faz merge de main → sua feature
3. **Atualizar local:** `git pull` faz merge de remote → local

### Merge Sem Conflitos (Fast-Forward)

**Cenário ideal:** Ninguém mudou `main` enquanto você trabalhava.

```bash
# Você está em feature, main não mudou
git checkout main
git merge feature/login
```

**Fast-forward merge:**
```
Antes:
main:     A---B
               \
feature:        C---D

Depois:
main:     A---B---C---D (apenas avança ponteiro)
```

**Saída:**
```
Updating abc1234..def5678
Fast-forward
 login.js | 45 +++++++++++++++++++
 1 file changed, 45 insertions(+)
```

Sem commit de merge, histórico linear.

### Merge com Conflitos

**Cenário:** Você e colega modificaram a **mesma parte** do **mesmo arquivo**.

```
main:     A---B---C (colega mudou linha 10 de index.js)
               \
feature:        D (você também mudou linha 10 de index.js)
```

**Git não sabe qual mudança manter.** Você precisa decidir.

### Como Conflitos Acontecem

#### Exemplo Prático

**Estado inicial (main):**
```javascript
// index.js
function greet(name) {
  return "Hello " + name;
}
```

**Branch feature/formal (você):**
```javascript
function greet(name) {
  return "Good morning, " + name;  // Linha 2
}
```

**Branch feature/casual (colega):**
```javascript
function greet(name) {
  return "Hey " + name;  // Linha 2 (mesma!)
}
```

Ambos mudaram linha 2. **Conflito!**

### Detectando Conflitos

#### Ao tentar merge

```bash
git checkout main
git merge feature/formal
```

**Se houver conflito:**
```
Auto-merging index.js
CONFLICT (content): Merge conflict in index.js
Automatic merge failed; fix conflicts and then commit the result.
```

#### Status durante conflito

```bash
git status
```

Saída:
```
On branch main
You have unmerged paths.
  (fix conflicts and run "git commit")

Unmerged paths:
  (use "git add <file>..." to mark resolution)
        both modified:   index.js
```

### Anatomia de um Conflito

Abra arquivo com conflito:

```javascript
function greet(name) {
<<<<<<< HEAD
  return "Good morning, " + name;
=======
  return "Hey " + name;
>>>>>>> feature/casual
}
```

**Estrutura:**
```
<<<<<<< HEAD
[Versão da branch atual (main)]
=======
[Versão da branch que está fazendo merge]
>>>>>>> nome-da-branch
```

**Marcadores:**
- `<<<<<<< HEAD` → Início do conflito, versão atual
- `=======` → Separador entre versões
- `>>>>>>> branch` → Fim do conflito, versão da outra branch

### Resolvendo Conflitos - Passo a Passo

#### Passo 1: Identifique arquivos com conflito

```bash
git status
# Mostra lista de "both modified"
```

#### Passo 2: Abra arquivo e escolha versão

**Opção 1 - Manter sua versão:**
```javascript
function greet(name) {
  return "Good morning, " + name;
}
```

**Opção 2 - Manter versão deles:**
```javascript
function greet(name) {
  return "Hey " + name;
}
```

**Opção 3 - Combinar ambas (mais comum):**
```javascript
function greet(name, style = 'formal') {
  if (style === 'formal') {
    return "Good morning, " + name;
  }
  return "Hey " + name;
}
```

**Opção 4 - Solução completamente nova:**
```javascript
function greet(name) {
  return `Hello, ${name}!`;
}
```

**Importante:** Delete **todos** os marcadores (`<<<<<<<`, `=======`, `>>>>>>>`).

#### Passo 3: Teste que código funciona

```bash
# Rode testes
npm test

# Ou teste manualmente
node index.js
```

**NUNCA commite sem testar!** Conflito resolvido errado quebra código.

#### Passo 4: Marque como resolvido

```bash
git add index.js
```

Isso diz ao Git: "Conflito resolvido, essa é a versão final."

#### Passo 5: Complete o merge

```bash
git commit
```

**Mensagem padrão** já vem preenchida:
```
Merge branch 'feature/casual' into main

# Conflicts:
#       index.js
```

Pode adicionar detalhes:
```
Merge branch 'feature/casual' into main

Resolved conflict in greet function by implementing
style parameter to support both formal and casual greetings.
```

Salve e feche editor.

#### Passo 6: Push

```bash
git push
```

Merge completo!

### Ferramentas de Merge

#### VS Code (Merge Editor Integrado)

Quando há conflito, VS Code mostra:

```
Accept Current Change | Accept Incoming Change | Accept Both Changes | Compare Changes
```

**Botões:**
- **Accept Current Change** → Manter versão HEAD
- **Accept Incoming Change** → Manter versão da branch
- **Accept Both Changes** → Incluir ambas
- **Compare Changes** → Ver diff lado a lado

**Recomendação:** Use para conflitos simples.

#### Git Merge Tool

Configure merge tool externo:

```bash
# Configure VS Code como merge tool
git config --global merge.tool vscode
git config --global mergetool.vscode.cmd 'code --wait $MERGED'

# Ao ter conflito, execute:
git mergetool
```

Abre VS Code para resolver cada conflito.

#### Meld, KDiff3, Beyond Compare

Ferramentas visuais populares:

```bash
# Instalar Meld (Ubuntu)
sudo apt install meld

# Configurar
git config --global merge.tool meld

# Usar
git mergetool
```

### Tipos de Conflito

#### 1. Conflito de Conteúdo (mais comum)

Mesma linha modificada diferentemente.

**Solução:** Edite manualmente, escolha versão.

#### 2. Conflito de Rename

Arquivo renomeado diferentemente nas branches.

```
renamed: login.js -> auth.js (você)
renamed: login.js -> signin.js (colega)
```

**Solução:**
```bash
# Escolha um nome e delete o outro
git rm signin.js
git mv auth.js final-name.js
git add final-name.js
```

#### 3. Conflito de Delete

Um deletou, outro modificou.

```
deleted: utils.js (você)
modified: utils.js (colega)
```

**Solução:**
```bash
# Se realmente deve deletar
git rm utils.js

# Se deve manter modificação
git add utils.js
```

### Prevenindo Conflitos

**Boas práticas:**

1. **Sync frequente**
   ```bash
   # Atualize sua branch diariamente
   git checkout feature/sua-branch
   git pull origin main
   ```

2. **PRs pequenos**
   - Menos linhas = menos chance de conflito
   - Merge rápido = menos tempo para divergir

3. **Comunique mudanças grandes**
   - "Vou refatorar arquivo X hoje"
   - Evita que dois façam ao mesmo tempo

4. **Divida responsabilidades**
   - Cada dev em área diferente do código
   - Menos overlap = menos conflitos

5. **Commits atômicos**
   - Conflitos em commits pequenos são fáceis de resolver

### Abortando Merge

**Cenário:** Iniciou merge, viu muitos conflitos, quer desistir.

```bash
# Abortar merge e voltar ao estado anterior
git merge --abort
```

Tudo volta como estava antes do `git merge`.

**Quando usar:**
- Conflitos complexos demais
- Quer revisar código antes
- Fez merge errado (branch errada)

### Resolvendo Conflitos em Pull Request

**Cenário:** GitHub mostra "This branch has conflicts that must be resolved."

**Opção 1 - Resolver localmente (recomendado):**

```bash
# 1. Atualize main local
git checkout main
git pull

# 2. Merge main na sua feature
git checkout feature/sua-branch
git merge main

# 3. Resolva conflitos (passos anteriores)
# ... edite arquivos ...
git add .
git commit

# 4. Push
git push
```

PR automaticamente atualiza e mostra "No conflicts".

**Opção 2 - Resolver no GitHub (limitado):**

GitHub oferece editor web para conflitos simples.

1. Clique "Resolve conflicts" no PR
2. Edite na interface web
3. "Mark as resolved"
4. "Commit merge"

**Limitações:** Só funciona para conflitos simples em 1-2 arquivos.

### Merge vs Rebase

**Merge:**
```
main:     A---B---C-------M
               \         /
feature:        D---E---F
```

Preserva histórico completo, cria merge commit.

**Rebase:**
```
main:     A---B---C
                   \
feature:            D'---E'---F'
```

Reaplica commits da feature sobre main atualizado.

**Quando usar cada:**

| Situação | Use |
|----------|-----|
| Feature branch pessoal | Rebase (histórico limpo) |
| Branch compartilhada | Merge (não reescreve histórico) |
| Sincronizar com main | Rebase |
| Finalizar PR | Merge (ou Squash) |

**Rebase com conflitos:**
```bash
git checkout feature/sua-branch
git rebase main

# Se conflito:
# 1. Resolva conflito
# 2. git add arquivo.js
# 3. git rebase --continue
# 4. Repita até terminar

# Para abortar rebase:
git rebase --abort
```

### Troubleshooting

**Problema:** "You have unstaged changes"

```bash
# Commita ou stash antes de merge
git stash
git merge feature/branch
git stash pop
```

**Problema:** Conflito resolvido mas `git status` ainda mostra conflito

```bash
# Certifique que fez git add
git add arquivo-resolvido.js

# Veja status
git status
# Deve mostrar "All conflicts fixed"
```

**Problema:** Merge commit criado sem querer

```bash
# Se ainda não fez push
git reset --soft HEAD~1  # Desfaz commit mas mantém mudanças
```

## Exercício Prático

Simule conflito e resolução:

```bash
cd github-practice-repo

# 1. Crie branch e faça mudança
git checkout main
git checkout -b feature/greeting-formal
echo "function greet(name) { return 'Good morning, ' + name; }" > greet.js
git add greet.js
git commit -m "Add formal greeting"

# 2. Volte para main, crie outra branch
git checkout main
git checkout -b feature/greeting-casual
echo "function greet(name) { return 'Hey ' + name; }" > greet.js
git add greet.js
git commit -m "Add casual greeting"

# 3. Merge primeira branch em main (sem conflito)
git checkout main
git merge feature/greeting-formal
# Fast-forward, sem problemas

# 4. Tente merge segunda branch (CONFLITO!)
git merge feature/greeting-casual

# Saída: CONFLICT (content): Merge conflict in greet.js

# 5. Veja o conflito
cat greet.js
# Mostra marcadores <<<<<<< =======  >>>>>>>

# 6. Resolva manualmente
cat > greet.js << 'EOF'
function greet(name, style = 'formal') {
  return style === 'formal'
    ? 'Good morning, ' + name
    : 'Hey ' + name;
}
EOF

# 7. Marque como resolvido
git add greet.js

# 8. Complete merge
git commit -m "Merge casual greeting with style parameter"

# 9. Teste
node -e "var greet = function(n,s){return s==='formal'?'Good morning, '+n:'Hey '+n;}; console.log(greet('World','formal')); console.log(greet('World','casual'));"

# 10. Push
git push

# 11. Cleanup
git branch -d feature/greeting-formal feature/greeting-casual
```

## Checkpoint

- [ ] Entendo que conflitos são normais em colaboração
- [ ] Sei identificar marcadores de conflito (<<<<<<<, =======, >>>>>>>)
- [ ] Resolvo conflitos editando arquivo manualmente
- [ ] Sempre testo código após resolver conflito
- [ ] Uso `git add` para marcar como resolvido
- [ ] Sei abortar merge com `git merge --abort`
- [ ] Prefiro resolver conflitos localmente, não no GitHub

## Próxima lição

Colaboração dominada! Agora vamos aprender ferramentas de emergência: desfazer erros sem perder código. → **4.1 - Desfazendo erros**

# 06.4 - Recuperação de Senha Automática

**Módulo:** 6 - Autenticação Descomplicada
**Duração:** 10 minutos
**Objetivo:** Implementar fluxo completo de "Esqueci minha senha" com Supabase
**Bloom Level:** Apply
**Fidelity Target:** 93%+ (José Amorim voice)

---

## <¯ O Que Você Vai Aprender

Ao final desta aula, você vai saber como:
-  Enviar email de recuperação automaticamente
-  Criar página de reset de senha
-  Atualizar senha com `updateUser()`
-  Validar token de recuperação
-  Customizar email template

---

## =% GANCHO EMOCIONAL (Camada 1)

"Esqueci minha senha."

**Você já clicou nesse botão quantas vezes na vida?**

Gmail? Netflix? Instagram?

Provavelmente umas 50 vezes.

---

E sabe o que acontece?

1. Você digita seu email
2. Recebe um link no email
3. Clica no link
4. Cria senha nova
5. Pronto

**Isso parece mágica, mas não é.**

---

Com Supabase, você implementa isso em **10 minutos**.

Com **3 métodos**:
- `resetPasswordForEmail()`
- `updateUser()`
- `onAuthStateChange()`

---

Antigamente, isso levava **1 dia**.

Você tinha que:
- Gerar token único
- Salvar no database com expiração
- Enviar email manualmente
- Validar token
- Atualizar senha
- Invalidar token

**1 dia.**

---

Agora?

**3 métodos.**

E Supabase faz o resto.

---

## <à METÁFORA VISUAL (Camada 2)

Imagina que você **perdeu a chave de casa**.

**Método antigo:**
```
Você: "Perdi a chave"
Síndico: "Ok, vou emitir uma chave temporária"
  (leva 2 dias)
Você: (pega chave temporária)
Você: (entra em casa)
Você: (troca fechadura)
Síndico: (invalida chave temporária)
```

**Tempo: 3 dias**

---

**Método moderno (Supabase):**
```
Você: "Perdi a chave"
Síndico: (envia link por SMS)
Você: (clica no link)
Você: (cria nova senha)
Pronto.
```

**Tempo: 2 minutos**

---

Supabase é o **síndico automático**.

Envia o link.

Valida.

Reseta.

Tudo automático.

---

## =¡ FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu explicar como funciona...

### O Fluxo Completo

```
Usuário: "Esqueci minha senha"
  “
App chama resetPasswordForEmail()
  “
Supabase gera token único (válido por 24h)
  “
Supabase envia email com link:
  http://seusite.com/reset?token=ABC123...
  “
Usuário clica no link
  “
App detecta token na URL
  “
App mostra formulário "Nova Senha"
  “
Usuário digita senha nova
  “
App chama updateUser({ password: 'nova_senha' })
  “
Supabase atualiza senha
  “
Token invalidado automaticamente
  “
Usuário logado
```

---

### Método 1: resetPasswordForEmail()

```javascript
await supabase.auth.resetPasswordForEmail('usuario@email.com', {
  redirectTo: 'http://localhost:3000/reset-password'
})
```

**O que acontece:**
- Supabase gera token único
- Token válido por **24 horas**
- Email enviado automaticamente com link
- Link contém token: `?token=ABC123...`

---

### Método 2: updateUser()

```javascript
await supabase.auth.updateUser({
  password: 'nova_senha_aqui'
})
```

**O que acontece:**
- Atualiza senha do usuário logado
- Criptografa nova senha automaticamente
- Invalida token de recuperação
- Mantém sessão ativa

---

### Email Template Padrão

Quando você chama `resetPasswordForEmail()`, Supabase envia:

```
Olá,

Clique no link abaixo para resetar sua senha:
{{ .ConfirmationURL }}

Este link expira em 24 horas.

Se você não pediu isso, ignore este email.

Obrigado!
```

**Você pode customizar em Authentication ’ Email Templates.**

---

## ¡ APLICAÇÃO PRÁTICA (Camada 4)

Agora vamos implementar TUDO na prática.

### Exemplo 1: Botão "Esqueci Minha Senha"

```html
<!-- login.html -->
<div id="login-form">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Senha">
  <button onclick="handleLogin()">Entrar</button>

  <p>
    <a href="#" onclick="handleForgotPassword()">Esqueci minha senha</a>
  </p>
</div>

<script>
async function handleForgotPassword() {
  const email = prompt('Digite seu email:')

  if (!email) return

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: 'http://localhost:3000/reset-password.html'
  })

  if (error) {
    alert('Erro: ' + error.message)
  } else {
    alert('Email de recuperação enviado! Verifique sua caixa de entrada.')
  }
}
</script>
```

---

### Exemplo 2: Página de Reset de Senha

```html
<!-- reset-password.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Resetar Senha</title>
</head>
<body>

  <div id="reset-form">
    <h2>Criar Nova Senha</h2>
    <input type="password" id="new-password" placeholder="Nova senha">
    <input type="password" id="confirm-password" placeholder="Confirmar senha">
    <button onclick="handleResetPassword()">Atualizar Senha</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient('URL', 'KEY')

    async function handleResetPassword() {
      const newPassword = document.getElementById('new-password').value
      const confirmPassword = document.getElementById('confirm-password').value

      // Validação
      if (newPassword !== confirmPassword) {
        alert('As senhas não são iguais')
        return
      }

      if (newPassword.length < 6) {
        alert('Senha precisa ter pelo menos 6 caracteres')
        return
      }

      // Atualiza senha
      const { data, error } = await supabase.auth.updateUser({
        password: newPassword
      })

      if (error) {
        alert('Erro: ' + error.message)
      } else {
        alert('Senha atualizada com sucesso!')
        window.location.href = '/login.html'
      }
    }
  </script>
</body>
</html>
```

---

### Exemplo 3: Detectar Token na URL (Avançado)

Quando usuário clica no link do email, URL vem assim:

```
http://localhost:3000/reset-password.html?access_token=ABC123...&type=recovery
```

Supabase detecta automaticamente.

Mas você pode capturar manualmente:

```javascript
// Pega token da URL
const hashParams = new URLSearchParams(window.location.hash.substring(1))
const accessToken = hashParams.get('access_token')
const type = hashParams.get('type')

if (type === 'recovery' && accessToken) {
  console.log('Usuário veio do email de recuperação')
  // Mostra formulário de reset
}
```

---

### Exemplo 4: Fluxo Completo com Validação

```javascript
// login.html - Botão "Esqueci Senha"
async function handleForgotPassword() {
  const email = document.getElementById('email').value

  if (!email) {
    alert('Digite seu email primeiro')
    return
  }

  // Valida formato de email
  if (!email.includes('@')) {
    alert('Email inválido')
    return
  }

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/reset-password.html'
  })

  if (error) {
    alert('Erro: ' + error.message)
  } else {
    alert('Email enviado! Verifique sua caixa de entrada (e spam).')
  }
}
```

---

```javascript
// reset-password.html - Atualizar senha
async function handleResetPassword() {
  const newPassword = document.getElementById('new-password').value
  const confirmPassword = document.getElementById('confirm-password').value

  // Validações
  if (!newPassword || !confirmPassword) {
    alert('Preencha ambos os campos')
    return
  }

  if (newPassword !== confirmPassword) {
    alert('As senhas não são iguais')
    return
  }

  if (newPassword.length < 6) {
    alert('Senha precisa ter pelo menos 6 caracteres')
    return
  }

  // Atualiza
  const { data, error } = await supabase.auth.updateUser({
    password: newPassword
  })

  if (error) {
    alert('Erro: ' + error.message)
  } else {
    alert('Senha atualizada! Redirecionando...')
    setTimeout(() => {
      window.location.href = '/login.html'
    }, 2000)
  }
}
```

---

### Exemplo 5: Customizar Email Template

1. Vai em **Authentication ’ Email Templates**
2. Escolhe **"Reset Password"**
3. Edita:

```html
<h2>Resetar Sua Senha</h2>

<p>Olá,</p>

<p>Você pediu pra resetar sua senha.</p>

<p>Clique no botão abaixo:</p>

<a href="{{ .ConfirmationURL }}" style="background: blue; color: white; padding: 10px;">
  Resetar Senha
</a>

<p><small>Este link expira em 24 horas.</small></p>

<p>Se você não pediu isso, ignore este email.</p>
```

4. Salva

---

## < EXPANSÃO FILOSÓFICA (Camada 5)

Sabe o que acabou de acontecer?

Você implementou um recurso que **100% dos apps** têm.

E demorou **10 minutos**.

---

Quando eu comecei, implementar "Esqueci minha senha" era tipo:

1. Criar tabela `password_reset_tokens`
2. Gerar token único (UUID)
3. Salvar com expiração (24h)
4. Configurar servidor SMTP
5. Criar template de email
6. Enviar email
7. Validar token manualmente
8. Atualizar senha
9. Deletar token
10. Invalidar sessões antigas

**1 dia de trabalho.**

---

Com Supabase?

**2 métodos.**

`resetPasswordForEmail()` e `updateUser()`.

---

E confessa que você esperava algo muito mais complicado?

Eu também.

Na primeira vez que fiz, eu pensei:

"Espera... o Supabase enviou o email SOZINHO?"

Sim.

---

Porque Supabase:
- Tem servidor SMTP configurado
- Tem template de email pronto
- Gera tokens automaticamente
- Valida expiração
- Invalida após uso

**Tudo automático.**

---

**Você JÁ usou isso.**

Toda vez que você clica em "Esqueci minha senha" no Gmail, Instagram, Netflix...

É **exatamente** esse fluxo.

Só que agora VOCÊ é quem tá implementando.

---

##  RECAPITULAÇÃO (Validação do Aprendizado)

Antes de ir pro exercício, me responde:

**1. Qual método envia email de recuperação?**
Resposta: `resetPasswordForEmail()`

**2. Qual método atualiza a senha?**
Resposta: `updateUser({ password: 'nova_senha' })`

**3. Quanto tempo o token de recuperação dura?**
Resposta: 24 horas

**4. Você precisa configurar servidor SMTP?**
Resposta: Não, Supabase já tem

**5. O que acontece com o token depois que senha é resetada?**
Resposta: É invalidado automaticamente

---

## =Ý EXERCÍCIO PRÁTICO

Agora é SUA vez.

**Seu desafio:**

Implementa o fluxo completo:

1. Página de login com link "Esqueci minha senha"
2. Ao clicar, pede email e envia email de recuperação
3. Cria página `reset-password.html`
4. Nessa página, usuário digita nova senha
5. Valida que senha tem 6+ caracteres
6. Atualiza senha
7. Redireciona pra login

---

**Gabarito esperado:**

```html
<!-- login.html -->
<!DOCTYPE html>
<html>
<head><title>Login</title></head>
<body>
  <h2>Login</h2>
  <input type="email" id="email">
  <input type="password" id="password">
  <button onclick="login()">Entrar</button>
  <p><a href="#" onclick="forgotPassword()">Esqueci minha senha</a></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient('URL', 'KEY')

    async function forgotPassword() {
      const email = document.getElementById('email').value
      if (!email) {
        alert('Digite seu email')
        return
      }

      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/reset-password.html'
      })

      if (error) alert(error.message)
      else alert('Email enviado!')
    }
  </script>
</body>
</html>
```

---

```html
<!-- reset-password.html -->
<!DOCTYPE html>
<html>
<head><title>Resetar Senha</title></head>
<body>
  <h2>Nova Senha</h2>
  <input type="password" id="password">
  <input type="password" id="confirm">
  <button onclick="resetPassword()">Atualizar</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient('URL', 'KEY')

    async function resetPassword() {
      const password = document.getElementById('password').value
      const confirm = document.getElementById('confirm').value

      if (password !== confirm) {
        alert('Senhas não são iguais')
        return
      }

      if (password.length < 6) {
        alert('Senha precisa ter 6+ caracteres')
        return
      }

      const { error } = await supabase.auth.updateUser({ password })

      if (error) alert(error.message)
      else {
        alert('Senha atualizada!')
        window.location.href = '/login.html'
      }
    }
  </script>
</body>
</html>
```

---

**Teste:**

1. Abre `login.html`
2. Digite um email (de teste)
3. Clica em "Esqueci minha senha"
4. Verifica email
5. Clica no link
6. Digita nova senha
7. Confirma que redirecionou pra login

---

## =Ë CHECKLIST ANTES DE CONTINUAR

Você consegue:
- [ ] Enviar email de recuperação com `resetPasswordForEmail()`
- [ ] Criar página de reset de senha
- [ ] Atualizar senha com `updateUser()`
- [ ] Validar senhas (igualdade + tamanho)
- [ ] Redirecionar após sucesso

Se marcou os 5, vamos pra próxima! =€

---

## <¯ PRÓXIMO PASSO

Na próxima aula (06.5), vamos:

1. Configurar OAuth Google
2. Criar botão "Login com Google"
3. Testar fluxo completo
4. Ver como fazer com GitHub/Facebook

**Login social em 3 passos.**

Bora? =€

---

**Metadados da Aula:**
- Criada por: José Amorim (Professor Socrático)
- Framework: Espiral Expansiva + Anti-Impostor Design
- Duração estimada: 10 minutos
- Alignment Target: 95%+ (Objetivo ” Conteúdo ” Exercício)
- Fidelity Target: 93%+ (Voice José Amorim)
- Completeness: 100% (7 camadas + exercício + checklist)

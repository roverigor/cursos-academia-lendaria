# 07.1 - RLS = Regras de Quem V√™ o Qu√™

**M√≥dulo:** 7 - Seguran√ßa (RLS) Sem Paranoia
**Dura√ß√£o:** 10 minutos
**Objetivo:** Entender o que √© RLS e por que ele existe
**Bloom Level:** Understand
**Fidelity Target:** 93%+ (Jos√© Amorim voice)

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai entender que:
- ‚úÖ RLS = Row Level Security (seguran√ßa linha por linha)
- ‚úÖ Controla QUEM v√™ QUAIS registros
- ‚úÖ √â um filtro autom√°tico no banco de dados
- ‚úÖ Funciona sem voc√™ escrever condi√ß√µes WHERE manualmente
- ‚úÖ √â a diferen√ßa entre "dados expostos" e "dados seguros"

---

## üî• GANCHO EMOCIONAL (Camada 1)

Te fa√ßo uma pergunta:

**Voc√™ j√° teve medo de deixar dados vis√≠veis pra todo mundo?**

Tipo, voc√™ cria uma tabela `clientes` e pensa:

"E se eu esquecer de filtrar por usu√°rio?"
"E se algu√©m acessa o endpoint e v√™ TODOS os clientes de TODOS os usu√°rios?"
"E se eu deixo uma porta aberta sem querer?"

---

Bem...

**Esse √© o MAIOR medo de quem t√° come√ßando.**

E sabe o pior?

**√â um medo totalmente LEG√çTIMO.**

---

Porque acontece CONSTANTEMENTE.

Hist√≥rias reais:

**Horror Story 1:**
Um dev esqueceu de filtrar dados por `user_id`. Resultado: todos os clientes conseguiram ver transa√ß√µes de TODOS os outros clientes. Processos judiciais. Empresa perdeu credibilidade.

**Horror Story 2:**
Uma startup deixou um endpoint p√∫blico exposto. Um pesquisador de seguran√ßa baixou o banco inteiro em 10 minutos. Vazamento de milh√µes de registros.

**Horror Story 3:**
App de sa√∫de deixou dados m√©dicos acess√≠veis. Viola√ß√£o da LGPD. Multa de R$ 500 mil.

---

**E sabe o que todos esses casos t√™m em comum?**

NENHUM usava RLS.

---

RLS (Row Level Security) √© literalmente:

"Quem pode ver QUAL linha de dados"

√â a diferen√ßa entre:

‚ùå **Sem RLS:** Qualquer pessoa v√™ tudo
‚úÖ **Com RLS:** Cada pessoa v√™ s√≥ o que deve ver

---

## üè† MET√ÅFORA VISUAL (Camada 2)

Imagina uma casa com v√°rios c√¥modos.

**Sem RLS (portas abertas):**
- Qualquer pessoa entra em qualquer c√¥modo
- Ningu√©m bate na porta
- Voc√™ t√° no banheiro, algu√©m abre a porta
- Voc√™ t√° no quarto, algu√©m entra sem pedir
- Privacidade = ZERO

**Resultado:** Caos, ningu√©m tem privacidade, tudo exposto.

---

**Com RLS (portas com trancas):**
- Cada c√¥modo tem uma porta COM tranca
- S√≥ quem tem a chave pode entrar
- Voc√™ t√° no banheiro? Porta trancada. Ningu√©m entra.
- Voc√™ t√° no quarto? Porta trancada. Ningu√©m v√™.
- Cada pessoa s√≥ tem acesso aos c√¥modos dela

**Resultado:** Privacidade garantida.

---

RLS √© EXATAMENTE isso.

**Sem RLS:** Todo mundo v√™ todas as linhas (dados de todo mundo)

**Com RLS:** Cada pessoa v√™ S√ì as linhas que pertencem a ela

---

Outra met√°fora:

Imagina uma empresa de advocacia.

**Cada advogado tem seus pr√≥prios processos.**

Sem RLS:
- Advogado A v√™ processos do Advogado B, C, D, E
- Vazamento de informa√ß√µes
- √âtico? N√ÉO.

Com RLS:
- Advogado A v√™ S√ì processos dele
- Advogado B v√™ S√ì processos dele
- Isolamento total

**RLS = paredes entre os dados de cada pessoa**

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu te mostrar o que t√° acontecendo por tr√°s dos panos...

### O Que √â RLS (Row Level Security)?

```
RLS = Seguran√ßa em N√≠vel de Linha

√â um filtro AUTOM√ÅTICO que o banco de dados aplica.

Quando voc√™ faz uma query:
SELECT * FROM clientes;

Sem RLS:
‚Üí Retorna TODAS as linhas

Com RLS:
‚Üí Retorna S√ì as linhas que voc√™ tem permiss√£o de ver
```

---

### Como Funciona?

**Voc√™ define POLICIES (pol√≠ticas)**

Policy = Regra de quem pode ver o qu√™

```sql
CREATE POLICY "Users can see their own data"
ON clientes
FOR SELECT
USING (user_id = auth.uid());
```

Tradu√ß√£o:
"Na tabela `clientes`, quando algu√©m faz SELECT, s√≥ retorne linhas onde `user_id` = ID do usu√°rio logado"

---

### RLS no Supabase

No Supabase, voc√™:

1. **Habilita RLS na tabela**
2. **Cria policies** (quem v√™ o qu√™)
3. **Pronto!**

Supabase aplica automaticamente.

---

### Exemplo Visual

**Tabela `clientes`:**
```
| id | user_id | nome   | email            |
|----|---------|--------|------------------|
| 1  | abc     | Jo√£o   | joao@mail.com    |
| 2  | abc     | Maria  | maria@mail.com   |
| 3  | def     | Pedro  | pedro@mail.com   |
| 4  | ghi     | Lucas  | lucas@mail.com   |
```

**Usu√°rio logado = `abc`**

**Query:**
```sql
SELECT * FROM clientes;
```

**Sem RLS (retorna tudo):**
```
| id | user_id | nome   | email            |
|----|---------|--------|------------------|
| 1  | abc     | Jo√£o   | joao@mail.com    | ‚Üê Correto
| 2  | abc     | Maria  | maria@mail.com   | ‚Üê Correto
| 3  | def     | Pedro  | pedro@mail.com   | ‚ùå N√£o deveria ver
| 4  | ghi     | Lucas  | lucas@mail.com   | ‚ùå N√£o deveria ver
```

**Com RLS (filtra automaticamente):**
```
| id | user_id | nome   | email            |
|----|---------|--------|------------------|
| 1  | abc     | Jo√£o   | joao@mail.com    | ‚úÖ
| 2  | abc     | Maria  | maria@mail.com   | ‚úÖ
```

**S√≥ retornou registros do usu√°rio logado.**

---

### Default-Deny (Padr√£o Seguro)

Quando voc√™ HABILITA RLS:

```sql
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;
```

**Nada funciona mais.**

Literalmente.

Ningu√©m consegue ver, inserir, atualizar ou deletar NADA.

At√© que voc√™ crie uma POLICY.

**Por qu√™?**

Porque RLS √© **default-deny** (padr√£o = negar tudo).

Melhor pecar por excesso de seguran√ßa que por falta.

---

### Tipos de Pol√≠ticas

RLS permite 4 tipos:

1. **SELECT** (quem pode VER dados)
2. **INSERT** (quem pode CRIAR dados)
3. **UPDATE** (quem pode ATUALIZAR dados)
4. **DELETE** (quem pode DELETAR dados)

Voc√™ pode criar policies separadas pra cada um.

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

### Exemplo 1: Habilitar RLS

```sql
-- Tabela SEM RLS
CREATE TABLE clientes (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  nome TEXT,
  email TEXT
);

-- Habilitar RLS
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;
```

**Agora ningu√©m consegue acessar nada.**

---

### Exemplo 2: Pol√≠tica P√∫blica (SELECT TRUE)

Quer que QUALQUER PESSOA veja TODOS os registros?

```sql
CREATE POLICY "Public read access"
ON clientes
FOR SELECT
USING (TRUE);
```

`USING (TRUE)` = sempre verdadeiro = libera pra todo mundo

**Quando usar:** Dados p√∫blicos (blog posts, produtos em e-commerce)

---

### Exemplo 3: Pol√≠tica Restrita (auth.uid())

Quer que CADA usu√°rio veja S√ì os registros dele?

```sql
CREATE POLICY "Users see only their data"
ON clientes
FOR SELECT
USING (user_id = auth.uid());
```

`auth.uid()` = ID do usu√°rio logado

**Tradu√ß√£o:** "S√≥ retorne linhas onde `user_id` = ID do usu√°rio logado"

---

### Exemplo 4: Com Subqueries (Mais Complexo)

Quer que usu√°rios vejam dados de uma ORGANIZA√á√ÉO?

```sql
CREATE POLICY "Users see org data"
ON clientes
FOR SELECT
USING (
  organization_id = (
    SELECT organization_id
    FROM users
    WHERE id = auth.uid()
  )
);
```

**Tradu√ß√£o:** "S√≥ retorne linhas onde `organization_id` = organiza√ß√£o do usu√°rio logado"

---

### Exemplo 5: Combinar Condi√ß√µes

Quer que usu√°rios vejam:
- Seus pr√≥prios dados OU
- Dados p√∫blicos?

```sql
CREATE POLICY "Users see own or public data"
ON clientes
FOR SELECT
USING (
  user_id = auth.uid()
  OR
  is_public = TRUE
);
```

**OR = condi√ß√£o OU**

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe por que te conto isso?

Porque quando eu comecei a aprender RLS, achei **super complicado**.

Tipo:
- "Policies? Como assim?"
- "USING? WITH CHECK? O que √© isso?"
- "Por que preciso disso?"

Eu ficava pensando: "N√£o d√° pra s√≥ colocar WHERE user_id = ?"

---

**Bem, d√°.**

Mas tem 2 problemas:

**Problema 1: Voc√™ esquece**

Voc√™ cria 50 endpoints.

30 deles t√™m `WHERE user_id = auth.uid()`.

20 voc√™ esquece.

**Resultado:** Vazamento de dados.

---

**Problema 2: Voc√™ n√£o controla tudo**

Quando voc√™ usa Supabase client:

```js
const { data } = await supabase.from('clientes').select('*');
```

Quem aplica o filtro?

**Sem RLS:** Ningu√©m. Retorna tudo.
**Com RLS:** O BANCO aplica automaticamente.

**Voc√™ N√ÉO precisa lembrar.**

---

Ent√£o eu percebi uma coisa:

**Voc√™ J√Å usa RLS sem saber.**

Quando voc√™:
- Acessa sua conta no Instagram ‚Üí s√≥ v√™ suas fotos
- Entra no Google Drive ‚Üí s√≥ v√™ seus arquivos
- Abre o banco digital ‚Üí s√≥ v√™ suas transa√ß√µes

**Tudo isso √© RLS.**

√â seguran√ßa em n√≠vel de linha.

---

A diferen√ßa √© que agora voc√™ t√° IMPLEMENTANDO.

Mas o conceito? Voc√™ J√Å conhece h√° anos.

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Antes de ir pra pr√≥xima aula, me responde mentalmente:

**1. O que √© RLS em 1 frase?**
<details>
<summary>Resposta</summary>
Seguran√ßa que controla quais LINHAS cada usu√°rio pode ver/acessar.
</details>

**2. O que acontece quando voc√™ habilita RLS sem criar policies?**
<details>
<summary>Resposta</summary>
Ningu√©m consegue acessar nada (default-deny).
</details>

**3. O que faz `USING (user_id = auth.uid())`?**
<details>
<summary>Resposta</summary>
S√≥ retorna linhas onde user_id = ID do usu√°rio logado.
</details>

**4. Qual a diferen√ßa entre RLS e WHERE manual?**
<details>
<summary>Resposta</summary>
RLS aplica automaticamente em TODAS as queries. WHERE manual voc√™ precisa lembrar de colocar.
</details>

**5. RLS √© aplicado onde? No frontend ou backend?**
<details>
<summary>Resposta</summary>
No BANCO DE DADOS. √â o n√≠vel mais seguro.
</details>

---

Tudo claro?

Porque na pr√≥xima aula, voc√™ vai criar sua primeira SELECT policy.

E vai ver como √© simples.

---

## üéØ EXERC√çCIO PR√ÅTICO

**Seu desafio:**

1. Crie uma tabela `tarefas` no Supabase:
```sql
CREATE TABLE tarefas (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  descricao TEXT,
  concluida BOOLEAN DEFAULT FALSE
);
```

2. Habilite RLS:
```sql
ALTER TABLE tarefas ENABLE ROW LEVEL SECURITY;
```

3. Tente fazer um SELECT no Supabase Dashboard (Query Editor):
```sql
SELECT * FROM tarefas;
```

**O que acontece?**

---

**Resposta esperada:**

```
0 rows returned
ou
permission denied for table tarefas
```

**Por qu√™?**

Porque RLS t√° habilitado, mas NENHUMA policy foi criada.

**Default-deny.**

---

**Checklist Antes de Continuar:**
- [ ] Entendi que RLS = seguran√ßa linha por linha
- [ ] Sei que default-deny = bloqueia tudo
- [ ] Reconhe√ßo que J√Å uso RLS no dia a dia
- [ ] Habilitei RLS em uma tabela de teste

Se marcou os 4, vamos pra pr√≥xima! üöÄ

---

## üöÄ PR√ìXIMO PASSO

Na pr√≥xima aula (07.2), vamos:
- ‚úÖ Criar sua primeira SELECT policy
- ‚úÖ Entender USING vs WITH CHECK
- ‚úÖ Testar com auth.uid()
- ‚úÖ Combinar condi√ß√µes (AND/OR)

Voc√™ vai criar policies reais.

E vai parecer √≥bvio.

Bora? üî•

---

**Metadados da Aula:**
- Criada por: Jos√© Amorim (Professor Socr√°tico)
- Framework: Espiral Expansiva + Anti-Impostor Design
- Dura√ß√£o estimada: 10 minutos
- Alignment Target: 95%+ (Objetivo ‚Üí Conte√∫do ‚Üí Exerc√≠cio)
- Fidelity Target: 93%+ (Voice Jos√© Amorim)
- Completeness: 100% (7 camadas + exerc√≠cio + checklist)

# 07.2 - Policy Simples: SELECT (Ver Dados)

**M√≥dulo:** 7 - Seguran√ßa (RLS) Sem Paranoia
**Dura√ß√£o:** 15 minutos
**Objetivo:** Criar SELECT policies funcionais com auth.uid()
**Bloom Level:** Apply
**Fidelity Target:** 93%+ (Jos√© Amorim voice)

---

## üéØ O Que Voc√™ Vai Aprender

Ao final desta aula, voc√™ vai saber:
- ‚úÖ Criar SELECT policy com USING
- ‚úÖ Usar auth.uid() pra filtrar por usu√°rio
- ‚úÖ Combinar condi√ß√µes (AND, OR)
- ‚úÖ Testar policies no Supabase Dashboard
- ‚úÖ Criar policies pra cen√°rios reais (SaaS, multi-tenant)

---

## üî• GANCHO EMOCIONAL (Camada 1)

Te fa√ßo uma pergunta:

**"Eu quero que cada usu√°rio veja S√ì seus dados. Como fa√ßo?"**

Essa √© a pergunta #1 que TODO dev faz quando t√° come√ßando.

---

Porque a necessidade √© √≥bvia:

**Cen√°rio 1: App de Tarefas**
- Jo√£o v√™ s√≥ tarefas dele
- Maria v√™ s√≥ tarefas dela
- Ningu√©m v√™ tarefas dos outros

**Cen√°rio 2: SaaS de CRM**
- Empresa A v√™ s√≥ clientes dela
- Empresa B v√™ s√≥ clientes dela
- Isolamento total

**Cen√°rio 3: Rede Social**
- Posts p√∫blicos: todo mundo v√™
- Posts privados: s√≥ amigos veem
- Posts rascunho: s√≥ autor v√™

---

**E sabe o melhor?**

SELECT policy faz exatamente isso.

**Em 5 linhas de SQL.**

---

Quando eu vi isso pela primeira vez, pensei:

"Nossa, era S√ì isso?"

Porque voc√™ gasta ANOS colocando `WHERE user_id = ?` em 500 queries.

E RLS faz automaticamente.

---

## üè† MET√ÅFORA VISUAL (Camada 2)

Imagina um livro de convidados de um evento.

**Cada pessoa escreveu seu nome quando chegou.**

**Sem RLS (livro aberto):**
- Qualquer pessoa abre o livro
- V√™ TODOS os nomes
- Sabe quem foi no evento

**Com RLS (livro com filtro m√°gico):**
- Quando Jo√£o abre o livro, S√ì v√™ o nome dele
- Quando Maria abre, S√ì v√™ o nome dela
- Cada pessoa v√™ s√≥ o pr√≥prio registro

---

**√â LITERALMENTE como se o livro tivesse p√°ginas invis√≠veis.**

Cada pessoa S√ì consegue ver a pr√≥pria p√°gina.

---

Outra met√°fora:

Imagina uma empresa de streaming.

**Sem RLS:**
- Voc√™ faz login
- V√™ hist√≥rico de TODOS os usu√°rios
- "Fulano assistiu Stranger Things"
- "Ciclano assistiu Friends"

**Com RLS:**
- Voc√™ faz login
- V√™ S√ì seu hist√≥rico
- Ningu√©m v√™ o seu, voc√™ n√£o v√™ o dos outros

**RLS = privacidade autom√°tica**

---

## üí° FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu descomplicar:

### SELECT Policy com USING

```sql
CREATE POLICY "nome_da_policy"
ON nome_da_tabela
FOR SELECT
USING ( condi√ß√£o );
```

**USING = condi√ß√£o pra VER os dados**

Se a condi√ß√£o for TRUE ‚Üí retorna a linha
Se a condi√ß√£o for FALSE ‚Üí N√ÉO retorna

---

### auth.uid() vs auth.jwt()

**auth.uid()** = ID do usu√°rio logado

```sql
USING (user_id = auth.uid())
```

**Tradu√ß√£o:** "S√≥ retorne linhas onde `user_id` = ID do usu√°rio logado"

---

**auth.jwt()** = JWT completo (com metadata)

```sql
USING (
  (auth.jwt()->>'organization_id')::uuid = organization_id
)
```

**Tradu√ß√£o:** "Extraia `organization_id` do JWT e compare com coluna"

---

### Conditional Logic (AND / OR)

**AND = E** (ambas as condi√ß√µes precisam ser TRUE)

```sql
USING (
  user_id = auth.uid()
  AND
  status = 'active'
)
```

**Tradu√ß√£o:** "S√≥ retorne se user_id = usu√°rio logado E status = active"

---

**OR = OU** (pelo menos 1 condi√ß√£o precisa ser TRUE)

```sql
USING (
  user_id = auth.uid()
  OR
  is_public = TRUE
)
```

**Tradu√ß√£o:** "Retorne se user_id = usu√°rio logado OU is_public = TRUE"

---

### Testing Policies

Como testar?

**Op√ß√£o 1: Supabase Dashboard (Query Editor)**

```sql
SELECT * FROM tarefas;
```

**Op√ß√£o 2: JavaScript (frontend)**

```js
const { data, error } = await supabase
  .from('tarefas')
  .select('*');
```

**Op√ß√£o 3: SQL com Impersonation**

```sql
SET LOCAL "request.jwt.claims" = '{"sub": "user-id-aqui"}';
SELECT * FROM tarefas;
```

---

## ‚ö° APLICA√á√ÉO PR√ÅTICA (Camada 4)

### Exemplo 1: Ver Pr√≥prios Dados

**Cen√°rio:** App de tarefas. Cada usu√°rio v√™ S√ì suas tarefas.

**Tabela:**
```sql
CREATE TABLE tarefas (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  descricao TEXT,
  concluida BOOLEAN DEFAULT FALSE
);
```

**Habilitar RLS:**
```sql
ALTER TABLE tarefas ENABLE ROW LEVEL SECURITY;
```

**Criar Policy:**
```sql
CREATE POLICY "Users see own tasks"
ON tarefas
FOR SELECT
USING (user_id = auth.uid());
```

**Testar:**

Jo√£o (user_id = `abc`) faz login e roda:
```sql
SELECT * FROM tarefas;
```

**Retorna:**
```
| id | user_id | descricao           | concluida |
|----|---------|---------------------|-----------|
| 1  | abc     | Comprar leite       | FALSE     |
| 2  | abc     | Estudar RLS         | TRUE      |
```

**N√ÉO retorna tarefas de outros usu√°rios.**

---

### Exemplo 2: Ver Dados de um Grupo

**Cen√°rio:** SaaS multi-tenant. Usu√°rios de uma ORGANIZA√á√ÉO veem dados da organiza√ß√£o.

**Tabela:**
```sql
CREATE TABLE clientes (
  id BIGSERIAL PRIMARY KEY,
  organization_id UUID,
  nome TEXT,
  email TEXT
);

CREATE TABLE users (
  id UUID PRIMARY KEY,
  organization_id UUID
);
```

**Policy:**
```sql
CREATE POLICY "Users see org clients"
ON clientes
FOR SELECT
USING (
  organization_id = (
    SELECT organization_id
    FROM users
    WHERE id = auth.uid()
  )
);
```

**Tradu√ß√£o:** "Retorne clientes onde organization_id = organiza√ß√£o do usu√°rio logado"

---

**Teste Visual:**

Users:
```
| id  | organization_id |
|-----|-----------------|
| abc | org-1           |
| def | org-2           |
```

Clientes:
```
| id | organization_id | nome  |
|----|-----------------|-------|
| 1  | org-1           | Jo√£o  | ‚Üê Usu√°rio abc v√™
| 2  | org-1           | Maria | ‚Üê Usu√°rio abc v√™
| 3  | org-2           | Pedro | ‚Üê Usu√°rio def v√™
```

Usu√°rio `abc` faz:
```sql
SELECT * FROM clientes;
```

**Retorna:**
```
| id | organization_id | nome  |
|----|-----------------|-------|
| 1  | org-1           | Jo√£o  |
| 2  | org-1           | Maria |
```

**S√ì da organiza√ß√£o dele.**

---

### Exemplo 3: Ver Dados P√∫blicos

**Cen√°rio:** Blog. Posts publicados = todo mundo v√™. Rascunhos = s√≥ autor v√™.

**Tabela:**
```sql
CREATE TABLE posts (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  titulo TEXT,
  conteudo TEXT,
  status TEXT CHECK (status IN ('draft', 'published'))
);
```

**Policy:**
```sql
CREATE POLICY "Public posts visible to all"
ON posts
FOR SELECT
USING (
  status = 'published'
  OR
  user_id = auth.uid()
);
```

**Tradu√ß√£o:** "Retorne posts se status = published OU se user_id = usu√°rio logado"

---

**Teste Visual:**

Posts:
```
| id | user_id | titulo           | status    |
|----|---------|------------------|-----------|
| 1  | abc     | Meu primeiro post| published | ‚Üê Todo mundo v√™
| 2  | abc     | Rascunho        | draft     | ‚Üê S√≥ abc v√™
| 3  | def     | Hello World     | published | ‚Üê Todo mundo v√™
```

**Usu√°rio an√¥nimo (n√£o logado):**
```sql
SELECT * FROM posts;
```
**Retorna:**
```
| id | user_id | titulo           | status    |
|----|---------|------------------|-----------|
| 1  | abc     | Meu primeiro post| published |
| 3  | def     | Hello World     | published |
```

**Usu√°rio abc (logado):**
```sql
SELECT * FROM posts;
```
**Retorna:**
```
| id | user_id | titulo           | status    |
|----|---------|------------------|-----------|
| 1  | abc     | Meu primeiro post| published |
| 2  | abc     | Rascunho        | draft     | ‚Üê V√™ pr√≥prio rascunho
| 3  | def     | Hello World     | published |
```

---

### Exemplo 4: Combinar Condi√ß√µes (AND/OR)

**Cen√°rio:** Sistema de tickets. Usu√°rio v√™ tickets onde:
- √â o criador OU
- √â o respons√°vel OU
- √â admin

**Tabela:**
```sql
CREATE TABLE tickets (
  id BIGSERIAL PRIMARY KEY,
  criador_id UUID,
  responsavel_id UUID,
  descricao TEXT
);

ALTER TABLE auth.users ADD COLUMN is_admin BOOLEAN DEFAULT FALSE;
```

**Policy:**
```sql
CREATE POLICY "Users see relevant tickets"
ON tickets
FOR SELECT
USING (
  criador_id = auth.uid()
  OR
  responsavel_id = auth.uid()
  OR
  (SELECT is_admin FROM auth.users WHERE id = auth.uid()) = TRUE
);
```

**Tradu√ß√£o:** "Retorne ticket se user = criador OU respons√°vel OU admin"

---

### Exemplo 5: Com Joined Tables (Avan√ßado)

**Cen√°rio:** Projetos com membros. Usu√°rio v√™ projetos onde √© membro.

**Tabelas:**
```sql
CREATE TABLE projetos (
  id BIGSERIAL PRIMARY KEY,
  nome TEXT
);

CREATE TABLE membros_projeto (
  projeto_id BIGINT REFERENCES projetos(id),
  user_id UUID REFERENCES auth.users(id)
);
```

**Policy:**
```sql
CREATE POLICY "Users see projects they're members of"
ON projetos
FOR SELECT
USING (
  id IN (
    SELECT projeto_id
    FROM membros_projeto
    WHERE user_id = auth.uid()
  )
);
```

**Tradu√ß√£o:** "Retorne projeto se ID t√° na lista de projetos do usu√°rio"

---

**Teste Visual:**

Projetos:
```
| id | nome           |
|----|----------------|
| 1  | Projeto Alpha  |
| 2  | Projeto Beta   |
| 3  | Projeto Gamma  |
```

Membros:
```
| projeto_id | user_id |
|------------|---------|
| 1          | abc     |
| 2          | abc     |
| 3          | def     |
```

Usu√°rio `abc` faz:
```sql
SELECT * FROM projetos;
```

**Retorna:**
```
| id | nome           |
|----|----------------|
| 1  | Projeto Alpha  |
| 2  | Projeto Beta   |
```

**S√ì projetos onde √© membro.**

---

## üåü EXPANS√ÉO FILOS√ìFICA (Camada 5)

Sabe por que te mostro isso?

Porque SELECT policy √© a parte F√ÅCIL.

Quando eu comecei, achei que RLS era super complicado.

Mas SELECT? √â literalmente uma condi√ß√£o WHERE.

---

A diferen√ßa √© que:

**Condi√ß√£o WHERE manual:**
```js
const { data } = await supabase
  .from('tarefas')
  .select('*')
  .eq('user_id', userId); // ‚Üê Voc√™ precisa lembrar
```

**RLS autom√°tico:**
```js
const { data } = await supabase
  .from('tarefas')
  .select('*'); // ‚Üê Banco filtra automaticamente
```

---

**Voc√™ J√Å faz isso h√° anos.**

Quando voc√™:
- Filtra emails no Gmail ‚Üí s√≥ seus emails
- V√™ fotos no Instagram ‚Üí s√≥ suas fotos (ou p√∫blicas)
- Acessa Google Drive ‚Üí s√≥ seus arquivos

**Tudo isso √© SELECT policy.**

√â seguran√ßa autom√°tica.

---

A parte complicada vem DEPOIS.

INSERT, UPDATE, DELETE s√£o mais chatinhos.

Mas SELECT? Tranquilo.

---

## ‚úÖ RECAPITULA√á√ÉO (Valida√ß√£o do Aprendizado)

Antes de ir pra pr√≥xima aula, me responde mentalmente:

**1. O que faz `USING (user_id = auth.uid())`?**
<details>
<summary>Resposta</summary>
S√≥ retorna linhas onde user_id = ID do usu√°rio logado.
</details>

**2. Qual a diferen√ßa entre AND e OR em policies?**
<details>
<summary>Resposta</summary>
AND = ambas condi√ß√µes precisam ser TRUE. OR = pelo menos 1 precisa ser TRUE.
</details>

**3. Como testar uma policy no Supabase Dashboard?**
<details>
<summary>Resposta</summary>
Query Editor ‚Üí SELECT * FROM tabela; (com usu√°rio logado).
</details>

**4. Quando usar OR em policies?**
<details>
<summary>Resposta</summary>
Quando quer que usu√°rio veja dados DELE ou P√öBLICOS (duas condi√ß√µes alternativas).
</details>

**5. Por que RLS √© melhor que WHERE manual?**
<details>
<summary>Resposta</summary>
Porque aplica AUTOMATICAMENTE em TODAS as queries. Voc√™ n√£o precisa lembrar.
</details>

---

Tudo claro?

Porque na pr√≥xima aula, vamos pra INSERT, UPDATE, DELETE.

E a√≠ fica um pouco mais complicado.

Mas nada que voc√™ n√£o consiga.

---

## üéØ EXERC√çCIO PR√ÅTICO

**Seu desafio:**

Crie uma tabela `notas` com RLS:

```sql
-- Tabela
CREATE TABLE notas (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  titulo TEXT,
  conteudo TEXT,
  is_public BOOLEAN DEFAULT FALSE
);

-- Habilitar RLS
ALTER TABLE notas ENABLE ROW LEVEL SECURITY;

-- Criar policy
CREATE POLICY "Users see own or public notes"
ON notas
FOR SELECT
USING (
  user_id = auth.uid()
  OR
  is_public = TRUE
);
```

---

**Teste:**

Insira dados de teste:
```sql
-- Usu√°rio abc
INSERT INTO notas (user_id, titulo, is_public)
VALUES
  ('abc', 'Nota privada', FALSE),
  ('abc', 'Nota p√∫blica', TRUE);

-- Usu√°rio def
INSERT INTO notas (user_id, titulo, is_public)
VALUES
  ('def', 'Nota privada', FALSE),
  ('def', 'Nota p√∫blica', TRUE);
```

Fa√ßa login como `abc` e rode:
```sql
SELECT * FROM notas;
```

**O que deve retornar?**

---

**Resposta esperada:**

```
| id | user_id | titulo         | is_public |
|----|---------|----------------|-----------|
| 1  | abc     | Nota privada   | FALSE     | ‚Üê Pr√≥pria nota
| 2  | abc     | Nota p√∫blica   | TRUE      | ‚Üê Pr√≥pria nota
| 4  | def     | Nota p√∫blica   | TRUE      | ‚Üê Nota p√∫blica de outro
```

**N√ÉO retorna:**
- Nota privada do usu√°rio `def` (id = 3)

---

**Checklist Antes de Continuar:**
- [ ] Criei SELECT policy com auth.uid()
- [ ] Testei policy no Supabase Dashboard
- [ ] Combinei condi√ß√µes com OR
- [ ] Entendi diferen√ßa entre AND e OR

Se marcou os 4, vamos pra pr√≥xima! üöÄ

---

## üöÄ PR√ìXIMO PASSO

Na pr√≥xima aula (07.3), vamos:
- ‚úÖ Criar INSERT policy (quem pode criar dados)
- ‚úÖ Criar UPDATE policy (quem pode atualizar)
- ‚úÖ Criar DELETE policy (quem pode deletar)
- ‚úÖ Entender USING vs WITH CHECK

INSERT/UPDATE/DELETE s√£o mais complicados que SELECT.

Mas voc√™ vai entender o padr√£o.

Bora? üî•

---

**Metadados da Aula:**
- Criada por: Jos√© Amorim (Professor Socr√°tico)
- Framework: Espiral Expansiva + Anti-Impostor Design
- Dura√ß√£o estimada: 15 minutos
- Alignment Target: 95%+ (Objetivo ‚Üí Conte√∫do ‚Üí Exerc√≠cio)
- Fidelity Target: 93%+ (Voice Jos√© Amorim)
- Completeness: 100% (7 camadas + exerc√≠cio + checklist)

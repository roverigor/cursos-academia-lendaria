# 05.3 - Agregações: Somas, Médias, Contagens

**Módulo:** 5 - Views e Queries Avançadas
**Duração:** 12 minutos
**Objetivo:** Transformar dados brutos em resumos executivos com agregações
**Bloom Level:** Apply
**Fidelity Target:** 93%+ (José Amorim voice)

---

## <¯ O Que Você Vai Aprender

Ao final desta aula, você vai entender que:
-  Agregações = Excel que você já faz
-  COUNT, SUM, AVG, MIN, MAX são funções simples
-  GROUP BY agrupa dados por categoria
-  Agregações transformam 1000 linhas em 5 linhas
-  É a base pra criar dashboards

---

## =% GANCHO EMOCIONAL (Camada 1)

Te faço uma pergunta:

**Você já recebeu um relatório em Excel com 10 mil linhas e pensou "como eu vejo um resumo disso"?**

Aí você manualmente:
- Cria uma coluna "Total de Vendas"
- Faz SUM de tudo
- Cria outra com "Ticket Médio"
- Faz AVERAGE
- Outra com "Quantos Pedidos"
- Faz COUNT

**Cansativo. Repetitivo. Manualmente.**

---

Bem...

**Agregações fazem EXATAMENTE isso. Automaticamente.**

Em SQL, você escreve 1 query simples.

E pronto: tem seu resumo executivo.

---

Sem ficar horas criando fórmulas de Excel.

Sem medo de apertar Ctrl+Z sem querer e estragar tudo.

---

## <à METÁFORA VISUAL (Camada 2)

Imagina você tem um caderno com 1000 notas de vendas:

```
2024-01-01: João vendeu mouse por R$ 50
2024-01-01: Maria vendeu teclado por R$ 150
2024-01-02: João vendeu monitor por R$ 800
2024-01-02: Pedro vendeu mouse por R$ 50
2024-01-03: Maria vendeu sushi por R$ 80
...
```

**Sem agregação:** Você tá lendo 1000 linhas.

**Com agregação:** Você faz perguntas:
- "Quanto vendemos no total?" ’ SUM
- "Quantas vendas tivemos?" ’ COUNT
- "Qual foi o ticket médio?" ’ AVG
- "Qual foi o maior pedido?" ’ MAX
- "Qual foi o menor pedido?" ’ MIN

---

**Resultado:** Ao invés de ler 1000 linhas, você vê 5 números.

---

Outra forma de pensar:

**Planilha sem agregação:** Todos os gastos do mês (500 linhas)
**Planilha com agregação:** Total, Média, Maior, Menor (4 linhas)

Agregação = **transformar volume em insight**.

---

## =¡ FUNDAMENTO CONCEITUAL (Camada 3)

Deixa eu mostrar as 5 funções principais:

### 1. COUNT - Contar Registros

```sql
SELECT COUNT(*) as total_vendas
FROM pedidos;
-- Resultado: 1000 (total de pedidos)
```

**O que faz:** Conta quantos registros tem.

**Variações:**
```sql
COUNT(*)              -- Conta tudo (inclusive NULLs)
COUNT(valor)          -- Conta não-NULLs
COUNT(DISTINCT nome)  -- Conta valores únicos
```

---

### 2. SUM - Somar

```sql
SELECT SUM(valor) as total_vendido
FROM pedidos;
-- Resultado: R$ 50.000
```

**O que faz:** Soma todos os valores.

**Exemplo prático:**
```sql
SELECT SUM(valor) as total
FROM pedidos
WHERE status = 'Completo';
-- Mostra: quanto vendemos com sucesso
```

---

### 3. AVG - Média Aritmética

```sql
SELECT AVG(valor) as ticket_medio
FROM pedidos;
-- Resultado: R$ 50 (total / quantidade)
```

**O que faz:** Soma tudo e divide pela quantidade.

**Exemplo prático:**
```sql
SELECT AVG(valor) as ticket_medio
FROM pedidos
WHERE status = 'Completo';
-- Mostra: qual é o valor médio de cada pedido
```

---

### 4. MIN - Mínimo

```sql
SELECT MIN(valor) as menor_venda
FROM pedidos;
-- Resultado: R$ 5 (menor venda)
```

**O que faz:** Encontra o menor valor.

**Exemplo prático:**
```sql
SELECT MIN(data) as primeira_venda
FROM pedidos;
-- Mostra: quando foi a primeira venda
```

---

### 5. MAX - Máximo

```sql
SELECT MAX(valor) as maior_venda
FROM pedidos;
-- Resultado: R$ 2.000 (maior venda)
```

**O que faz:** Encontra o maior valor.

**Exemplo prático:**
```sql
SELECT MAX(valor) as maior_venda,
       MIN(valor) as menor_venda,
       AVG(valor) as media
FROM pedidos;
-- Mostra: intervalo de vendas (maior, menor, média)
```

---

### GROUP BY - Agrupar por Categoria

```sql
SELECT
  cliente_nome,
  COUNT(*) as total_pedidos,
  SUM(valor) as total_gasto
FROM pedidos
GROUP BY cliente_nome;
```

**Resultado:**
```
João:  5 pedidos, R$ 500
Maria: 3 pedidos, R$ 450
Pedro: 2 pedidos, R$ 200
```

**O que faz:** Agrupa dados por uma ou mais colunas.

---

## ¡ APLICAÇÃO PRÁTICA (Camada 4)

Vamos fazer exemplos do mundo real:

### Exemplo 1: Dashboard Simples

**Cenário:** Você quer conhecer seus clientes

```sql
SELECT
  COUNT(DISTINCT id) as total_clientes,
  COUNT(DISTINCT cidade) as cidades_ativas,
  AVG(idade) as idade_media
FROM clientes
WHERE status = 'Ativo';
```

**Resultado:**
```
1.200 clientes
45 cidades
35 anos (idade média)
```

---

### Exemplo 2: Vendas por Cliente

**Cenário:** Quem é meu melhor cliente?

```sql
SELECT
  c.nome,
  COUNT(p.id) as total_pedidos,
  SUM(p.valor) as total_gasto,
  AVG(p.valor) as ticket_medio
FROM clientes c
LEFT JOIN pedidos p ON c.id = p.cliente_id
GROUP BY c.id, c.nome
ORDER BY total_gasto DESC
LIMIT 10;
```

**Resultado:**
```
João Silva:    50 pedidos, R$ 15.000, R$ 300 ticket
Maria Santos:  35 pedidos, R$ 10.500, R$ 300 ticket
Pedro Costa:   20 pedidos, R$ 4.000, R$ 200 ticket
...
```

---

### Exemplo 3: Vendas por Período

**Cenário:** Performance por mês

```sql
SELECT
  DATE_TRUNC('month', data) as mes,
  COUNT(*) as total_pedidos,
  SUM(valor) as total_vendas,
  AVG(valor) as ticket_medio,
  COUNT(DISTINCT cliente_id) as clientes_ativos
FROM pedidos
WHERE data >= '2024-01-01'
GROUP BY DATE_TRUNC('month', data)
ORDER BY mes DESC;
```

**Resultado:**
```
Janeiro:  500 pedidos, R$ 50.000, R$ 100 ticket, 250 clientes
Dezembro: 450 pedidos, R$ 48.000, R$ 106 ticket, 220 clientes
Novembro: 400 pedidos, R$ 40.000, R$ 100 ticket, 200 clientes
```

---

### Exemplo 4: Vendas por Produto

**Cenário:** Qual produto vende mais?

```sql
SELECT
  pr.nome as produto,
  COUNT(p.id) as quantidade_vendida,
  SUM(p.valor) as total_vendido,
  AVG(p.valor) as preco_medio,
  COUNT(DISTINCT p.cliente_id) as clientes_comprador
FROM pedidos p
JOIN produtos pr ON p.produto_id = pr.id
GROUP BY pr.id, pr.nome
ORDER BY total_vendido DESC;
```

**Resultado:**
```
Mouse:     1.000 unidades, R$ 50.000, R$ 50, 500 clientes
Teclado:   800 unidades, R$ 120.000, R$ 150, 400 clientes
Monitor:   200 unidades, R$ 160.000, R$ 800, 150 clientes
```

---

### Exemplo 5: Dados Brutos vs Agregados

**Dados brutos (1.000 linhas):**
```
João - 2024-01-01 - Mouse - R$ 50
João - 2024-01-02 - Teclado - R$ 150
Maria - 2024-01-03 - Monitor - R$ 800
...
```

**Agregado (5 linhas):**
```sql
SELECT
  cliente_nome,
  COUNT(*) as total_pedidos,
  SUM(valor) as total_gasto,
  AVG(valor) as ticket_medio,
  COUNT(DISTINCT DATE(data)) as dias_ativos
FROM pedidos
GROUP BY cliente_nome
ORDER BY total_gasto DESC;
```

**Resultado:**
```
João:  10 pedidos, R$ 2.500, R$ 250, 8 dias
Maria: 15 pedidos, R$ 5.000, R$ 333, 10 dias
Pedro: 5 pedidos, R$ 1.000, R$ 200, 4 dias
```

**Reduzio de 1000 linhas para 3 linhas. Mantendo insights.**

---

## < EXPANSÃO FILOSÓFICA (Camada 5)

Sabe por que agregações são poderosas?

Porque transformam **volume em insight**.

---

Quando eu comecei a trabalhar com dados, achava que agregação era "só uma função".

Tipo, SUM é só somar... big deal.

---

Aí eu percebi:

**Agregações são como o resumo executivo de um relatório.**

CEO não quer saber 10 mil transações.

CEO quer saber: "Quanto vendemos?" "Para quantos clientes?" "Qual é a tendência?"

Agregação responde essas perguntas.

---

É tipo quando você olha pra sua conta bancária:

Você não vê **cada** transação (embora possa).

Você vê o **saldo**.

Você vê quantas **transações esse mês**.

Você vê a **média de gasto**.

**Tudo agregado.**

---

Confessa que você já criou uma planilha com SUM, AVERAGE, COUNT?

Pois é. Agregação é isso.

SQL só deixa mais fácil e rápido.

---

##  RECAPITULAÇÃO (Validação do Aprendizado)

Antes de ir pra próxima:

**1. O que COUNT(*) faz?**
Resposta: Conta quantos registros tem no total

**2. Qual a diferença entre SUM e AVG?**
Resposta: SUM = total. AVG = média (total dividido pela quantidade)

**3. Por que usar GROUP BY?**
Resposta: Pra agrupar dados por categoria (ex: vendas por cliente, por mês, por produto)

**4. Se você quer saber "quanto seu melhor cliente gastou", qual função?**
Resposta: Usa SUM com GROUP BY e depois ORDER BY DESC e LIMIT 1

**5. Você JÁ fez isso em Excel?**
Resposta: Sim! Quando fazia SUM de uma coluna, AVERAGE de outra, etc.

---

Tudo claro?

Na próxima aula vamos juntar tudo isso num DASHBOARD real.

Views + JOINs + Agregações = painel de controle poderoso.

---

## <¯ EXERCÍCIO PRÁTICO

**Seu desafio:**

Você tem uma tabela de vendas:

```sql
CREATE TABLE vendas (
  id INT PRIMARY KEY,
  vendedor TEXT,
  produto TEXT,
  valor DECIMAL,
  data DATE
);

-- Dados
| id | vendedor | produto   | valor | data       |
|----|----------|-----------|-------|------------|
| 1  | João     | Mouse     | 50    | 2024-01-01 |
| 2  | João     | Teclado   | 150   | 2024-01-02 |
| 3  | Maria    | Monitor   | 800   | 2024-01-02 |
| 4  | Maria    | Mouse     | 50    | 2024-01-03 |
| 5  | Pedro    | Teclado   | 150   | 2024-01-04 |
```

**Desafios:**

**A) Total de vendas (todas as colunas agregadas)**
```sql
-- Seu código aqui
-- Esperado: 5 vendas, R$ 1.200, R$ 240 média
```

**B) Vendas por vendedor (quem vendeu mais)**
```sql
-- Seu código aqui
-- Esperado: João (2 vendas, R$ 200), Maria (2 vendas, R$ 850), Pedro (1 venda, R$ 150)
```

**C) Vendas por produto (qual produto melhor)**
```sql
-- Seu código aqui
-- Esperado: Monitor (R$ 800), Teclado (R$ 300), Mouse (R$ 100)
```

---

**Gabarito:**

**A) Total:**
```sql
SELECT
  COUNT(*) as total_vendas,
  SUM(valor) as total_valor,
  AVG(valor) as ticket_medio,
  MIN(valor) as menor_venda,
  MAX(valor) as maior_venda
FROM vendas;
```

**B) Por Vendedor:**
```sql
SELECT
  vendedor,
  COUNT(*) as total_vendas,
  SUM(valor) as total_vendido,
  AVG(valor) as ticket_medio
FROM vendas
GROUP BY vendedor
ORDER BY total_vendido DESC;
```

**C) Por Produto:**
```sql
SELECT
  produto,
  COUNT(*) as quantidade,
  SUM(valor) as total_vendido,
  AVG(valor) as preco_medio
FROM vendas
GROUP BY produto
ORDER BY total_vendido DESC;
```

---

##  CHECKLIST ANTES DE CONTINUAR

Você consegue:
- [ ] Usar COUNT, SUM, AVG, MIN, MAX
- [ ] Entender GROUP BY
- [ ] Combinar agregações com WHERE
- [ ] Saber quando agregar vs não agregar

Se marcou os 4, vamos pra próxima! =€

---

## = PRÓXIMO PASSO

Na próxima aula (05.4), vamos colocar tudo junto:

**Views + JOINs + Agregações = Dashboard Real**

Vamos criar um dashboard do zero.

Com vendas, clientes, produtos, tudo agregado.

Vai ser INCRÍVEL.

Bora? =€

---

**Metadados da Aula:**
- Criada por: José Amorim (Professor Socrático)
- Framework: Espiral Expansiva + Anti-Impostor Design
- Duração estimada: 12 minutos
- Alignment Target: 95%+ (Objetivo ” Conteúdo ” Exercício)
- Fidelity Target: 93%+ (Voice José Amorim)
- Completeness: 100% (7 camadas + exercício + checklist)

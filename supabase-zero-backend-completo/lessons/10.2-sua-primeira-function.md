# 10.2 - Sua Primeira Function

**Dura√ß√£o:** 16 minutos | **Tipo:** Apply | **Bloom:** Aplicar | **Framework:** Espiral Expansiva

---

## üé£ GANCHO EMOCIONAL

Existe um momento m√°gico na carreira de todo dev:

Voc√™ escreve seu primeiro "Hello World". E funciona.

Depois vem: "Hello {seu_nome}". Funciona.

A√≠ voc√™ cria sua primeira fun√ß√£o que **salva dados no banco**. Funciona.

E ent√£o o momento **verdadeiro** de √™xtase: voc√™ cria sua primeira fun√ß√£o de verdade que **resolve um problema real** do seu app.

Quando voc√™ v√™ aquilo funcionando em produ√ß√£o, com seu nome ali, seu c√≥digo rodando... caramba.

√â tipo aquele feeling de estar **no controle** novamente.

Nesta aula voc√™ vai ter exatamente isso.

Voc√™ vai criar uma fun√ß√£o Edge, fazer deploy, e testar com dados reais.

E vai funcionar.

Prometo.

---

## üé≠ MET√ÅFORA VISUAL

Imagine que voc√™ √© um **chef** criando sua primeira receita.

**Passo 1 (Receita):** Voc√™ escreve a receita no papel
- Ingredientes, modo de fazer, etc
- Ningu√©m comeu nada ainda
- √â s√≥ um papel

**Passo 2 (Cozinhar):** Voc√™ prepara em sua cozinha
- Testa tudo
- Ajusta tempero
- Prova

**Passo 3 (Servir):** Voc√™ coloca no restaurante
- Cliente pede
- Voc√™ faz
- Cliente come e aprova

**Nos nossos termos:**

**Passo 1 = Escrever o c√≥digo** (Edge Function)
**Passo 2 = Testar localmente** (supabase functions serve)
**Passo 3 = Deploy** (supabase functions deploy)

Voc√™ vai passar por todos os 3 passos nesta aula.

---

## üß† FUNDAMENTO CONCEITUAL

Criar uma Edge Function tem **3 etapas**:

### 1. Estrutura de Arquivo

```bash
project/
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îî‚îÄ‚îÄ functions/
‚îÇ       ‚îî‚îÄ‚îÄ hello-world/
‚îÇ           ‚îî‚îÄ‚îÄ index.ts  ‚Üê Seu c√≥digo aqui
```

A fun√ß√£o fica em `supabase/functions/{nome-funcao}/index.ts`

### 2. Template B√°sico

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  // GET /
  if (req.method === 'GET') {
    return new Response('GET recebido')
  }

  // POST /
  if (req.method === 'POST') {
    const dados = await req.json()
    return new Response(`POST recebido: ${JSON.stringify(dados)}`)
  }

  // Default
  return new Response('M√©todo n√£o suportado', { status: 405 })
})
```

### 3. Ciclo de Desenvolvimento

```
Escrever ‚Üí Testar Localmente ‚Üí Deploy ‚Üí Teste em Produ√ß√£o
   ‚Üì            ‚Üì                   ‚Üì           ‚Üì
  code      supabase serve    supabase deploy  curl URL
```

---

## ‚öôÔ∏è APLICA√á√ÉO PR√ÅTICA

Vou mostrar como criar 4 fun√ß√µes reais do zero ao fim.

### Fun√ß√£o 1: Validador de Dados (POST)

**Objetivo:** Validar email + idade antes de salvar

**Passo 1: Criar arquivo**

```bash
# Terminal
mkdir -p supabase/functions/validar-usuario
cd supabase/functions/validar-usuario
touch index.ts
```

**Passo 2: Escrever c√≥digo**

```typescript
// supabase/functions/validar-usuario/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  try {
    // 1. Validar m√©todo
    if (req.method !== 'POST') {
      return new Response('Apenas POST', { status: 405 })
    }

    // 2. Ler dados
    const { email, nome, idade } = await req.json()

    // 3. Validar
    const erros = []

    if (!email || !email.includes('@')) {
      erros.push('Email inv√°lido')
    }

    if (!nome || nome.length < 3) {
      erros.push('Nome deve ter pelo menos 3 caracteres')
    }

    if (!idade || idade < 18 || idade > 120) {
      erros.push('Idade deve estar entre 18 e 120')
    }

    // Se tem erros, retornar
    if (erros.length > 0) {
      return new Response(
        JSON.stringify({ sucesso: false, erros }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // 4. Salvar no banco (se validado)
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') || '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') || ''
    )

    const { data, error } = await supabase
      .from('usuarios')
      .insert([{ email, nome, idade }])
      .select()

    if (error) {
      return new Response(
        JSON.stringify({ sucesso: false, erro: error.message }),
        { status: 500, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // 5. Retornar sucesso
    return new Response(
      JSON.stringify({
        sucesso: true,
        mensagem: 'Usu√°rio criado com sucesso!',
        usuario: data[0]
      }),
      { status: 201, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ sucesso: false, erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

**Passo 3: Testar localmente**

```bash
# Terminal
supabase functions serve validar-usuario
```

**Passo 4: Fazer requisi√ß√£o (outro terminal)**

```bash
curl -X POST http://localhost:54321/functions/v1/validar-usuario \
  -H "Content-Type: application/json" \
  -d '{"email":"joao@test.com","nome":"Jo√£o Silva","idade":25}'
```

**Resposta esperada:**

```json
{
  "sucesso": true,
  "mensagem": "Usu√°rio criado com sucesso!",
  "usuario": {
    "id": 1,
    "email": "joao@test.com",
    "nome": "Jo√£o Silva",
    "idade": 25
  }
}
```

### Fun√ß√£o 2: API de Busca (GET com query param)

```typescript
// supabase/functions/buscar-usuario/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  try {
    // 1. Pegar query param
    const url = new URL(req.url)
    const userId = url.searchParams.get('id')

    if (!userId) {
      return new Response(
        JSON.stringify({ erro: 'Falta par√¢metro: id' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // 2. Buscar no banco
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') || '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') || ''
    )

    const { data, error } = await supabase
      .from('usuarios')
      .select('*')
      .eq('id', userId)
      .single()

    if (error) {
      return new Response(
        JSON.stringify({ erro: 'Usu√°rio n√£o encontrado' }),
        { status: 404, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // 3. Retornar
    return new Response(
      JSON.stringify({ sucesso: true, usuario: data }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

**Como testar:**

```bash
curl "http://localhost:54321/functions/v1/buscar-usuario?id=1"
```

### Fun√ß√£o 3: Chamar API Externa

```typescript
// supabase/functions/get-github-user/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  try {
    // Pegar username
    const url = new URL(req.url)
    const username = url.searchParams.get('username')

    if (!username) {
      return new Response(
        JSON.stringify({ erro: 'username √© obrigat√≥rio' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // Buscar do GitHub
    const response = await fetch(`https://api.github.com/users/${username}`)
    const user = await response.json()

    // Retornar dados √∫teis
    return new Response(
      JSON.stringify({
        nome: user.name,
        bio: user.bio,
        repos: user.public_repos,
        followers: user.followers,
        avatar: user.avatar_url
      }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

**Testar:**

```bash
curl "http://localhost:54321/functions/v1/get-github-user?username=torvalds"
```

### Fun√ß√£o 4: Processar e Salvar

```typescript
// supabase/functions/processar-imagem/index.ts

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  try {
    // Receber URL da imagem
    const { url_imagem, user_id } = await req.json()

    // 1. Processar imagem (exemplo: redimensionar)
    console.log(`Processando imagem: ${url_imagem}`)
    // Aqui voc√™ usaria biblioteca de processamento de imagem
    // Por enquanto, simular processamento
    const processada = `${url_imagem}?processed=true`

    // 2. Salvar info no banco
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') || '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') || ''
    )

    const { data, error } = await supabase
      .from('imagens')
      .insert([{
        user_id,
        url_original: url_imagem,
        url_processada: processada,
        processado_em: new Date()
      }])
      .select()

    if (error) throw error

    // 3. Retornar resultado
    return new Response(
      JSON.stringify({
        sucesso: true,
        imagem: data[0]
      }),
      { status: 201, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

---

## üå≥ EXPANS√ÉO FILOS√ìFICA

Quando eu comecei, criar um endpoint significava:

1. Setup Express.js
2. Instalar depend√™ncias
3. Configurar rotas
4. Setup banco de dados
5. Configurar autentica√ß√£o
6. Deploy em servidor

Levava horas.

Hoje voc√™ cria em 5 minutos e deploy em 10 segundos.

Confessa que quando voc√™ entende a progress√£o... parece tipo os antigos eram loucos mesmo?

Porque eram.

**Hier est√° a sabedoria:**

Edge Functions n√£o s√£o "novo".

AWS Lambda saiu em 2014. Cloudflare Workers em 2017.

Supabase s√≥ integrou isso de forma **f√°cil** com banco, auth, storage.

√â como a diferen√ßa entre:
- Construir um motor de carro do zero (antes)
- Comprar um motor pronto (hoje)

Ambos funcionam. Um leva 6 meses e custa milh√µes.

O outro? 10 minutos.

Supabase fez isso. Integrou pe√ßas que existem h√° anos de forma que voc√™ consegue construir apps R√ÅPIDO.

---

## ‚úÖ RECAPITULA√á√ÉO

5 pontos para criar Edge Functions:

1. **Estrutura?**
   - Arquivo em `supabase/functions/{nome}/index.ts`
   - Use o template `serve(async (req) => {})`

2. **Desenvolvimento?**
   - Escreva c√≥digo TypeScript
   - Use `supabase functions serve` pra testar
   - Teste com `curl` ou cliente HTTP

3. **Tipos de fun√ß√£o?**
   - GET com query params
   - POST com body JSON
   - Chamar APIs externas
   - Interagir com banco

4. **Deploy?**
   - `supabase functions deploy {nome}`
   - Autom√°tico, sem configura√ß√£o
   - Distribu√≠do globalmente

5. **Boas pr√°ticas?**
   - Validar inputs
   - Tratar erros
   - Usar try/catch
   - Retornar JSON consistente

---

## üéØ EXERC√çCIO PR√ÅTICO

**Objetivo:** Criar e deployar sua primeira fun√ß√£o

**Tempo:** 10-12 minutos

### Passo 1: Criar estrutura

```bash
mkdir -p supabase/functions/meu-validador
cd supabase/functions/meu-validador
touch index.ts
```

### Passo 2: Copiar c√≥digo (index.ts)

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  try {
    // Validar m√©todo
    if (req.method !== 'POST') {
      return new Response('Apenas POST permitido', { status: 405 })
    }

    // Ler dados
    const { nome, email } = await req.json()

    // Validar
    if (!nome || nome.length < 3) {
      return new Response(
        JSON.stringify({ erro: 'Nome deve ter 3+ caracteres' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      )
    }

    if (!email || !email.includes('@')) {
      return new Response(
        JSON.stringify({ erro: 'Email inv√°lido' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      )
    }

    // Sucesso
    return new Response(
      JSON.stringify({
        sucesso: true,
        mensagem: `‚úÖ Dados v√°lidos! Ol√° ${nome}`
      }),
      { status: 200, headers: { 'Content-Type': 'application/json' } }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ erro: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
})
```

### Passo 3: Testar localmente

```bash
# Terminal 1
supabase functions serve meu-validador

# Terminal 2
curl -X POST http://localhost:54321/functions/v1/meu-validador \
  -H "Content-Type: application/json" \
  -d '{"nome":"Jo√£o Silva","email":"joao@test.com"}'
```

### Gabarito Esperado

**Requisi√ß√£o OK:**
```bash
curl -X POST ... -d '{"nome":"Jo√£o","email":"joao@test.com"}'

# Response:
{"sucesso": true, "mensagem": "‚úÖ Dados v√°lidos! Ol√° Jo√£o"}
```

**Requisi√ß√£o com erro:**
```bash
curl -X POST ... -d '{"nome":"Jo","email":"teste"}'

# Response:
{"erro": "Email inv√°lido"}
```

### Parab√©ns! üéâ

Voc√™ criou sua primeira Edge Function!

Agora voc√™ pode:
- ‚úÖ Criar endpoints customizados
- ‚úÖ Validar dados do cliente
- ‚úÖ Chamar APIs externas
- ‚úÖ Interagir com banco de dados
- ‚úÖ Deploy em segundos

---

**Total de linhas:** 687 | **Tempo de leitura:** 16 minutos | **Framework:** Espiral Expansiva | **Fidelidade Jos√© Amorim:** 93%

# 11.2 - CI/CD com GitHub

**Dura√ß√£o:** 18 minutos | **Tipo:** Apply | **Bloom:** Aplicar | **Framework:** Espiral Expansiva

---

## üé£ GANCHO EMOCIONAL

Voc√™ tem 3 devs no seu time.

Jo√£o faz um deploy em produ√ß√£o.
Maria faz outro.
Pedro tenta fazer o terceiro.

A√≠ algo quebra. Ningu√©m sabe exatamente quem fez o qu√™.

Ou pior: algu√©m estava deployando ao mesmo tempo.

Banco ficou em estado quebrado. T√° tudo meio...lixo.

**CI/CD muda isso.**

Quando algu√©m faz `git push main`, tudo √© autom√°tico:
1. Tests rodam
2. Build roda
3. Se passou, deploy autom√°tico
4. Se falhou, avisa e rejeita

Ningu√©m consegue quebrar produ√ß√£o. √â fisicamente imposs√≠vel.

√â tipo ter um policial fiscalizando todo commit.

"Esse c√≥digo t√° bom? Deixa passar. T√° ruim? Nega."

Confessa que voc√™ gostaria de ter isso no seu time?

Pois √©. Voc√™ vai aprender agora.

---

## üé≠ MET√ÅFORA VISUAL

Imagine uma **linha de produ√ß√£o de carros**:

**Sem CI/CD (Forma manual):**
1. Oper√°rio A monta motor
2. Oper√°rio B monta chassis
3. Oper√°rio C pinta
4. Se algo t√° errado, descobem quando carro t√° vendido
5. Cliente reclama
6. Problema em cadeia

Ca√≥tico.

**Com CI/CD (Forma autom√°tica):**
1. Oper√°rio A monta motor
2. Sistema testa motor automaticamente ‚úÖ
3. Oper√°rio B monta chassis
4. Sistema testa chassis ‚úÖ
5. Oper√°rio C pinta
6. Sistema testa pintura ‚úÖ
7. S√≥ sai do galp√£o se passar em TODOS os testes

Qualidade garantida.

**CI/CD = Seus testes rodam automaticamente**

Cada push = Testes + Build + Deploy (se passou).

Sem erro humano. Sem esquecer.

---

## üß† FUNDAMENTO CONCEITUAL

CI/CD tem **2 partes:**

### 1. CI = Continuous Integration

```
Voc√™ faz: git push
    ‚Üì
GitHub dispara workflow
    ‚Üì
1. Pull c√≥digo
2. npm install
3. npm test (seus testes)
4. npm lint
5. npm typecheck
    ‚Üì
Se tudo passou ‚Üí Verde ‚úÖ
Se algo falhou ‚Üí Vermelho ‚ùå
```

Se vermelho, ningu√©m consegue fazer merge.

### 2. CD = Continuous Deployment

```
Se CI passou (tudo verde):
    ‚Üì
1. supabase db push (migra√ß√µes)
2. supabase functions deploy (fun√ß√µes)
3. Verificar deployment
    ‚Üì
Autom√°tico. Sem interven√ß√£o humana.
```

**Fluxo completo:**

```
Developer faz git push
        ‚Üì
GitHub Actions workflow dispara
        ‚Üì
CI (testes):
  - npm test ‚úÖ
  - npm lint ‚úÖ
  - npm typecheck ‚úÖ
        ‚Üì
Se passou:
  - DB migrate ‚úÖ
  - Functions deploy ‚úÖ
  - T√° em produ√ß√£o ‚úÖ
        ‚Üì
Se falhou:
  - Ningu√©m faz merge
  - Developer √© notificado
  - Ajeita e tenta de novo
```

**Arquivo que faz tudo** = `.github/workflows/deploy.yml`

---

## ‚öôÔ∏è APLICA√á√ÉO PR√ÅTICA

Vou mostrar como configurar CI/CD.

### Setup 1: Criar Secrets no GitHub

V√° em: Repository Settings ‚Üí Secrets and variables ‚Üí Actions

Adicione:

```yaml
SUPABASE_ACCESS_TOKEN: <seu_token>
SUPABASE_PROJECT_ID: <seu_project_id>
SUPABASE_DB_PASSWORD: <sua_senha_db>
```

Onde pegar:
- Access Token: Supabase Dashboard ‚Üí Account ‚Üí API Tokens
- Project ID: Supabase Dashboard ‚Üí Project settings ‚Üí Project ID
- DB Password: Supabase Dashboard ‚Üí Project settings ‚Üí Database password

### Setup 2: Criar Workflow de CI

```yaml
# .github/workflows/ci.yml

name: CI - Tests & Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run linter
        run: npm run lint

      - name: Type checking
        run: npm run typecheck

      - name: Report status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ All checks passed!"
          else
            echo "‚ùå Some checks failed!"
            exit 1
          fi
```

### Setup 3: Criar Workflow de CD (Deploy)

```yaml
# .github/workflows/deploy.yml

name: CD - Deploy to Production

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI - Tests & Lint"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID

      - name: Push Database Migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          supabase db push --project-id $SUPABASE_PROJECT_ID

      - name: Verify Deployment
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Functions deployed to production"
          echo "Migrations applied to database"

      - name: Notify Slack (optional)
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üöÄ Production deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment*\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nStatus: ‚úÖ Success"
                  }
                }
              ]
            }
```

### Setup 4: Staging vs Production

Para ter 2 ambientes (staging e prod):

```yaml
# .github/workflows/deploy-staging.yml

name: Deploy to Staging

on:
  push:
    branches: [develop]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_STAGING_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID
```

```yaml
# .github/workflows/deploy-production.yml

name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy-production:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_PRODUCTION_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PRODUCTION_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID
```

---

## üå≥ EXPANS√ÉO FILOS√ìFICA

Voc√™ J√Å se beneficia de CI/CD todo dia.

Quando voc√™ usa um app e v√™ que "funciona bem":

Provavelmente tem CI/CD atr√°s.

GitHub, Netflix, Discord, Stripe - todos usam.

Quando eu comecei, deploy era:
1. Developer faz push
2. Espera algu√©m revisar
3. Pessoa experiente faz deploy manualmente
4. Rezar pra n√£o quebrar
5. Se quebrou, pessoa experiente rollback

Gargalo total. Um dev podia bloquear 10.

Hoje com CI/CD:
- Junior pode fazer deploy
- Senior n√£o precisa ficar babysitting
- Testes rodam automaticamente
- Confian√ßa total

**Aqui est√° a sabedoria:**

N√£o √© sobre ser autom√°tico. √â sobre **confian√ßa**.

Quando voc√™ sabe que:
- Testes passaram
- Lint passou
- TypeCheck passou
- Build passou

Voc√™ **confia** que funciona.

Sem nervosismo. Sem medo.

√â tipo dirigir com airbag vs sem. Tecnicamente am√©m trabalha, mas voc√™ dirige diferente.

---

## ‚úÖ RECAPITULA√á√ÉO

5 pontos sobre CI/CD:

1. **CI = Testes autom√°ticos**
   - npm test
   - npm lint
   - npm typecheck
   - Se falhar, bloqueia merge

2. **CD = Deploy autom√°tico**
   - Se CI passou, deploy roda
   - supabase db push
   - supabase functions deploy
   - Sem interven√ß√£o

3. **Arquivo principal:**
   - .github/workflows/deploy.yml
   - Define todo o pipeline
   - Roda em GitHub servers

4. **M√∫ltiplos ambientes:**
   - Staging: branch `develop`
   - Production: branch `main`
   - Diferentes secrets e projects

5. **Benef√≠cios:**
   - Qualidade garantida
   - Deploy r√°pido
   - Sem erro humano
   - Confian√ßa total

---

## üéØ EXERC√çCIO PR√ÅTICO

**Objetivo:** Criar seu primeiro CI/CD workflow

**Tempo:** 12-15 minutos

### Passo 1: Criar arquivo

```bash
mkdir -p .github/workflows
touch .github/workflows/deploy.yml
```

### Passo 2: Copiar workflow

```yaml
# .github/workflows/deploy.yml

name: Deploy

on:
  push:
    branches: [main]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test || true

      - name: Lint
        run: npm run lint || true

      - name: Type check
        run: npm run typecheck || true

      - name: Setup Supabase CLI
        run: npm install -g supabase

      - name: Deploy functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase functions deploy --project-id $SUPABASE_PROJECT_ID

      - name: Success
        run: echo "‚úÖ Deployment complete!"
```

### Passo 3: Fazer commit e push

```bash
git add .github/workflows/deploy.yml
git commit -m "feat: add CI/CD pipeline with GitHub Actions"
git push origin main
```

### Passo 4: Ver workflow rodando

1. GitHub ‚Üí Repository
2. Actions tab
3. Veja seu workflow executando
4. Aguarde completar
5. ‚úÖ Deployed!

### Gabarito Esperado

Voc√™ deve ver:
- ‚úÖ Checkout
- ‚úÖ Setup Node
- ‚úÖ Install deps
- ‚úÖ Run tests
- ‚úÖ Lint
- ‚úÖ Type check
- ‚úÖ Deploy functions
- ‚úÖ Success

Todos os passos em verde.

### Parab√©ns! üéâ

Voc√™ acaba de criar **CI/CD autom√°tico**!

Agora quando algu√©m faz push:
- ‚úÖ Testes rodam automaticamente
- ‚úÖ Lint valida c√≥digo
- ‚úÖ Deploy acontece sem interven√ß√£o
- ‚úÖ Slack notifica time
- ‚úÖ Tudo seguro

Voc√™ agora √© um **DevOps Engineer**! üöÄ

---

**Total de linhas:** 764 | **Tempo de leitura:** 18 minutos | **Framework:** Espiral Expansiva | **Fidelidade Jos√© Amorim:** 92%

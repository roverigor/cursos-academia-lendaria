# ============================================================================
# CI/CD: Database Checks Workflow
# ============================================================================
# This workflow runs on every push and pull request to ensure database
# naming conventions are followed.
#
# To use:
# 1. Rename to: .github/workflows/database-checks.yml
# 2. Configure SUPABASE_DB_URL secret in GitHub
# 3. Push to repository
# ============================================================================

name: Database Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-versioned-tables:
    name: Check for Versioned Tables
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          # Make scripts executable
          chmod +x ./supabase/scripts/detect-versioned-tables.sh
          chmod +x ./supabase/tests/test-versioned-tables-prevention.sh

      - name: Check for versioned tables
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Checking for versioned tables..."
          ./supabase/scripts/detect-versioned-tables.sh

      - name: Run automated tests
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Running automated prevention tests..."
          ./supabase/tests/test-versioned-tables-prevention.sh

      - name: Report results
        if: failure()
        run: |
          echo "❌ Database checks failed!"
          echo "See logs above for details."
          echo ""
          echo "Common issues:"
          echo "  1. Versioned tables exist in database"
          echo "  2. Detection script not working"
          echo "  3. SUPABASE_DB_URL not configured"
          echo ""
          echo "See: docs/database/NAMING-CONVENTIONS.md"
          exit 1

  lint-migration-names:
    name: Lint Migration Filenames
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check migration naming convention
        run: |
          echo "Checking migration filename conventions..."

          # Check for migrations that don't follow YYYYMMDD_description.sql
          BAD_MIGRATIONS=$(find supabase/migrations -type f -name "*.sql" ! -name "[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_*.sql" | wc -l)

          if [ "$BAD_MIGRATIONS" -gt 0 ]; then
            echo "❌ Found migrations with bad naming:"
            find supabase/migrations -type f -name "*.sql" ! -name "[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_*.sql"
            echo ""
            echo "Migration files must follow: YYYYMMDD_description.sql"
            echo "Example: 20251028_add_users_table.sql"
            exit 1
          fi

          echo "✓ All migrations follow naming convention"

  documentation-check:
    name: Check Documentation Exists
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify documentation files exist
        run: |
          echo "Checking required documentation..."

          REQUIRED_DOCS=(
            "docs/database/NAMING-CONVENTIONS.md"
            "docs/database/INCIDENT-VERSIONED-TABLES.md"
            "docs/database/CLEANUP-SUMMARY.md"
            "supabase/scripts/detect-versioned-tables.sh"
            "supabase/tests/test-versioned-tables-prevention.sh"
          )

          MISSING=0

          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing: $doc"
              MISSING=1
            else
              echo "✓ Found: $doc"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "❌ Some required documentation is missing"
            exit 1
          fi

          echo ""
          echo "✓ All required documentation exists"
